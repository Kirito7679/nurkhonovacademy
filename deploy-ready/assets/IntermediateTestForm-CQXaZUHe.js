import{r as h,j as e,X as U,z as E,aP as M,b4 as z,b5 as G,T as X,ag as R,d as _,u as K,e as B,V as H,f as J,as as W,b6 as L,a4 as Y,ai as I,aU as Z,aT as q,$ as ee,a0 as te,aV as O,a1 as $}from"./vendor-D1Bc63Il.js";import{a as Q}from"./index-BcL9BEkO.js";import{E as se}from"./ErrorModal-ADowvIV6.js";function ae({isOpen:p,question:m,onClose:b,onSave:S}){const[a,r]=h.useState({id:"",testId:"",question:"",type:"SINGLE",order:0,points:1,options:[]}),[c,j]=h.useState({}),[u,f]=h.useState("");h.useEffect(()=>{r(m?{...m,options:m.options||[]}:{id:"",testId:"",question:"",type:"SINGLE",order:0,points:1,options:[]}),j({}),f("")},[m,p]);const v=()=>{const t={};return a.question.trim()||(t.question="Вопрос обязателен"),a.points<1&&(t.points="Баллы должны быть больше 0"),a.type!=="TEXT"&&a.options.length<2&&(t.options="Добавьте минимум 2 варианта ответа"),a.type!=="TEXT"&&(a.options.some(o=>o.isCorrect)||(t.options="Выберите хотя бы один правильный ответ")),j(t),Object.keys(t).length===0},d=()=>{v()&&(S({...a,options:a.options.map((t,n)=>({...t,order:n}))}),b())},C=()=>{u.trim()&&(r({...a,options:[...a.options,{id:"",questionId:"",text:u.trim(),isCorrect:!1,order:a.options.length}]}),f(""))},N=t=>{r({...a,options:a.options.filter((n,o)=>o!==t)})},T=t=>{const n=[...a.options];a.type==="SINGLE"?n.forEach((o,x)=>{o.isCorrect=x===t}):n[t].isCorrect=!n[t].isCorrect,r({...a,options:n})},g=(t,n)=>{if(n==="up"&&t===0||n==="down"&&t===a.options.length-1)return;const o=[...a.options],x=n==="up"?t-1:t+1;[o[t],o[x]]=[o[x],o[t]],r({...a,options:o})};return p?e.jsx("div",{className:"fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50 p-4",children:e.jsxs("div",{className:"bg-white rounded-lg shadow-xl max-w-3xl w-full max-h-[90vh] overflow-hidden flex flex-col",children:[e.jsxs("div",{className:"flex items-center justify-between p-6 border-b border-neutral-200",children:[e.jsx("h2",{className:"text-2xl font-bold text-neutral-900",children:m?"Редактировать вопрос":"Добавить вопрос"}),e.jsx("button",{onClick:b,className:"text-neutral-400 hover:text-neutral-600 transition-colors",children:e.jsx(U,{className:"h-6 w-6"})})]}),e.jsxs("div",{className:"flex-1 overflow-y-auto p-6 space-y-6",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-neutral-700 mb-2",children:"Текст вопроса *"}),e.jsx("textarea",{value:a.question,onChange:t=>r({...a,question:t.target.value}),className:"input-field min-h-[100px]",placeholder:"Введите вопрос..."}),c.question&&e.jsxs("p",{className:"mt-1 text-sm text-red-600 flex items-center gap-1",children:[e.jsx(E,{className:"h-4 w-4"}),c.question]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-neutral-700 mb-2",children:"Тип вопроса *"}),e.jsx("div",{className:"grid grid-cols-3 gap-3",children:[{value:"SINGLE",label:"Один ответ",icon:"○"},{value:"MULTIPLE",label:"Несколько ответов",icon:"☑"},{value:"TEXT",label:"Текстовый ответ",icon:"✎"}].map(t=>e.jsxs("button",{type:"button",onClick:()=>{r({...a,type:t.value,options:t.value==="TEXT"?[]:a.options})},className:`p-4 border-2 rounded-lg transition-all ${a.type===t.value?"border-primary-500 bg-primary-50":"border-neutral-200 hover:border-primary-300"}`,children:[e.jsx("div",{className:"text-2xl mb-2",children:t.icon}),e.jsx("div",{className:"text-sm font-medium text-neutral-700",children:t.label})]},t.value))})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-neutral-700 mb-2",children:"Баллы за правильный ответ *"}),e.jsx("input",{type:"number",min:"1",value:a.points,onChange:t=>r({...a,points:parseInt(t.target.value)||1}),className:"input-field w-32"}),c.points&&e.jsxs("p",{className:"mt-1 text-sm text-red-600 flex items-center gap-1",children:[e.jsx(E,{className:"h-4 w-4"}),c.points]})]}),a.type!=="TEXT"&&e.jsxs("div",{children:[e.jsxs("label",{className:"block text-sm font-medium text-neutral-700 mb-2",children:["Варианты ответов *",e.jsx("span",{className:"text-neutral-500 text-xs ml-2",children:"(минимум 2, выберите правильные)"})]}),e.jsxs("div",{className:"flex gap-2 mb-4",children:[e.jsx("input",{type:"text",value:u,onChange:t=>f(t.target.value),onKeyPress:t=>{t.key==="Enter"&&(t.preventDefault(),C())},className:"input-field flex-1",placeholder:"Введите вариант ответа и нажмите Enter или кнопку"}),e.jsxs("button",{type:"button",onClick:C,className:"btn-primary whitespace-nowrap",children:[e.jsx(M,{className:"h-4 w-4 mr-2"}),"Добавить"]})]}),c.options&&e.jsxs("p",{className:"mb-3 text-sm text-red-600 flex items-center gap-1",children:[e.jsx(E,{className:"h-4 w-4"}),c.options]}),e.jsx("div",{className:"space-y-2",children:a.options.map((t,n)=>e.jsxs("div",{className:`flex items-center gap-3 p-3 border-2 rounded-lg transition-all ${t.isCorrect?"border-green-500 bg-green-50":"border-neutral-200 hover:border-neutral-300"}`,children:[e.jsx("button",{type:"button",className:"text-neutral-400 hover:text-neutral-600 cursor-move",title:"Перетащите для изменения порядка",children:e.jsx(z,{className:"h-5 w-5"})}),e.jsx("button",{type:"button",onClick:()=>T(n),className:`flex-shrink-0 w-6 h-6 rounded-full border-2 flex items-center justify-center transition-all ${t.isCorrect?"border-green-500 bg-green-500":"border-neutral-300 hover:border-primary-500"}`,title:a.type==="SINGLE"?"Правильный ответ (только один)":"Правильный ответ",children:t.isCorrect&&e.jsx(G,{className:"h-4 w-4 text-white"})}),e.jsx("input",{type:"text",value:t.text,onChange:o=>{const x=[...a.options];x[n].text=o.target.value,r({...a,options:x})},className:"input-field flex-1 border-0 bg-transparent p-0",placeholder:"Вариант ответа"}),e.jsxs("div",{className:"flex gap-1",children:[e.jsx("button",{type:"button",onClick:()=>g(n,"up"),disabled:n===0,className:"text-neutral-400 hover:text-neutral-600 disabled:opacity-30",title:"Вверх",children:"↑"}),e.jsx("button",{type:"button",onClick:()=>g(n,"down"),disabled:n===a.options.length-1,className:"text-neutral-400 hover:text-neutral-600 disabled:opacity-30",title:"Вниз",children:"↓"}),e.jsx("button",{type:"button",onClick:()=>N(n),className:"text-red-500 hover:text-red-600",title:"Удалить",children:e.jsx(X,{className:"h-4 w-4"})})]})]},n))}),a.options.length===0&&e.jsx("div",{className:"text-center py-8 text-neutral-400 border-2 border-dashed border-neutral-200 rounded-lg",children:e.jsx("p",{children:"Добавьте варианты ответов"})})]}),a.type==="TEXT"&&e.jsx("div",{className:"bg-blue-50 border border-blue-200 rounded-lg p-4",children:e.jsxs("p",{className:"text-sm text-blue-800",children:[e.jsx("strong",{children:"Текстовый ответ:"})," Студенты введут текстовый ответ, который будет проверяться вручную или автоматически (если настроено)."]})})]}),e.jsxs("div",{className:"flex items-center justify-end gap-3 p-6 border-t border-neutral-200 bg-neutral-50",children:[e.jsx("button",{type:"button",onClick:b,className:"btn-secondary",children:"Отмена"}),e.jsx("button",{type:"button",onClick:d,className:"btn-primary",children:"Сохранить вопрос"})]})]})}):null}const re=te({title:$().min(1,"Название теста обязательно"),description:$().optional(),passingScore:O().int().min(0).max(100).default(70),timeLimit:O().int().min(0).optional(),order:O().int().min(0).default(0)});function oe(){const{courseId:p,testId:m}=R(),b=_(),S=K(),a=!!m,[r,c]=h.useState([]),[j,u]=h.useState(null),[f,v]=h.useState({isOpen:!1,message:""}),{data:d,isLoading:C}=B(["test",m],async()=>(await Q.get(`/tests/${m}`)).data.data,{enabled:a}),{register:N,handleSubmit:T,formState:{errors:g},reset:t,watch:n}=H({resolver:ee(re),defaultValues:{title:"",description:"",passingScore:70,timeLimit:void 0,order:0}});n("timeLimit"),n("passingScore"),h.useEffect(()=>{d&&(t({title:d.title||"",description:d.description||"",passingScore:d.passingScore||70,timeLimit:d.timeLimit||void 0,order:d.order||0}),d.questions&&c(d.questions))},[d,t]);const o=J(async s=>(await Q.post("/tests",{...s,courseId:p})).data.data,{onSuccess:async s=>{if(r.length>0&&s.id)try{const l=r.map((i,y)=>{const k={testId:s.id,question:i.question,type:i.type,order:y,points:i.points};return i.options&&i.options.length>0&&(k.options=i.options.map((w,F)=>({text:w.text,isCorrect:w.isCorrect||!1,order:F}))),Q.post(`/tests/${s.id}/questions`,k).catch(w=>(console.warn("Question save endpoint not available yet:",w),null))});await Promise.all(l)}catch(l){console.error("Error saving questions:",l),l.response?.status!==404&&v({isOpen:!0,message:"Тест создан, но не удалось сохранить вопросы. Попробуйте отредактировать тест позже."})}S.invalidateQueries(["tests",p]),b(`/teacher/courses/${p}/edit`)},onError:s=>{v({isOpen:!0,message:s.response?.data?.message||"Ошибка при создании теста"})}}),x=s=>{j?.id?c(r.map(l=>l.id===j.id?s:l)):c([...r,{...s,order:r.length}]),u(null)},V=s=>{c(r.filter((l,i)=>i!==s))},P=(s,l)=>{if(l==="up"&&s===0||l==="down"&&s===r.length-1)return;const i=[...r],y=l==="up"?s-1:s+1;[i[s],i[y]]=[i[y],i[s]],c(i.map((k,w)=>({...k,order:w})))},A=()=>r.reduce((s,l)=>s+(l.points||1),0),D=s=>{if(r.length===0){v({isOpen:!0,message:"Добавьте хотя бы один вопрос"});return}o.mutate(s)};return C?e.jsxs("div",{className:"text-center py-12",children:[e.jsx("div",{className:"inline-block relative",children:e.jsx("div",{className:"animate-spin rounded-full h-12 w-12 border-4 border-primary-200 border-t-primary-500"})}),e.jsx("p",{className:"mt-4 text-neutral-600",children:"Загрузка..."})]}):e.jsxs("div",{children:[e.jsxs("button",{onClick:()=>b(`/teacher/courses/${p}/edit`),className:"flex items-center text-neutral-600 hover:text-primary-600 mb-6 transition-colors",children:[e.jsx(W,{className:"h-5 w-5 mr-2"}),"Назад к курсу"]}),e.jsx("div",{className:"relative mb-8",children:e.jsx("h1",{className:"text-2xl md:text-3xl lg:text-5xl font-bold text-gradient",children:a?"Редактировать тест":"Создать промежуточный тест"})}),e.jsxs("form",{onSubmit:T(D),className:"space-y-6",children:[e.jsxs("div",{className:"card p-6",children:[e.jsx("h2",{className:"text-xl font-semibold text-neutral-900 mb-4",children:"Основная информация"}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-neutral-700 mb-2",children:"Название теста *"}),e.jsx("input",{...N("title"),className:"input-field",placeholder:"Например: Тест по модулю 1"}),g.title&&e.jsx("p",{className:"mt-1 text-sm text-red-600",children:g.title.message})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-neutral-700 mb-2",children:"Описание"}),e.jsx("textarea",{...N("description"),className:"input-field",rows:3,placeholder:"Описание теста (необязательно)"})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsxs("label",{className:"block text-sm font-medium text-neutral-700 mb-2 flex items-center gap-2",children:[e.jsx(L,{className:"h-4 w-4"}),"Проходной балл (%) *"]}),e.jsxs("div",{className:"relative",children:[e.jsx("input",{...N("passingScore",{valueAsNumber:!0}),type:"number",min:"0",max:"100",className:"input-field pr-12",defaultValue:70}),e.jsx("div",{className:"absolute right-3 top-1/2 -translate-y-1/2 text-neutral-400 text-sm",children:"%"})]}),g.passingScore&&e.jsxs("p",{className:"mt-1 text-sm text-red-600 flex items-center gap-1",children:[e.jsx(E,{className:"h-4 w-4"}),g.passingScore.message]}),e.jsx("p",{className:"mt-1 text-xs text-neutral-500",children:"Минимальный процент для прохождения теста"})]}),e.jsxs("div",{children:[e.jsxs("label",{className:"block text-sm font-medium text-neutral-700 mb-2 flex items-center gap-2",children:[e.jsx(Y,{className:"h-4 w-4"}),"Лимит времени (минуты)"]}),e.jsxs("div",{className:"relative",children:[e.jsx("input",{...N("timeLimit",{valueAsNumber:!0}),type:"number",min:"0",className:"input-field pr-12",placeholder:"Не ограничено"}),e.jsx("div",{className:"absolute right-3 top-1/2 -translate-y-1/2 text-neutral-400 text-sm",children:"мин"})]}),e.jsx("p",{className:"mt-1 text-xs text-neutral-500",children:"Оставьте пустым для неограниченного времени"})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-neutral-700 mb-2",children:"Порядок"}),e.jsx("input",{...N("order",{valueAsNumber:!0}),type:"number",min:"0",className:"input-field",defaultValue:0})]})]})]}),e.jsxs("div",{className:"card p-6",children:[e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsxs("div",{children:[e.jsxs("h2",{className:"text-xl font-semibold text-neutral-900 flex items-center gap-2",children:[e.jsx(I,{className:"h-5 w-5"}),"Вопросы"]}),r.length>0&&e.jsxs("div",{className:"mt-2 flex items-center gap-4 text-sm text-neutral-600",children:[e.jsxs("span",{className:"flex items-center gap-1",children:[e.jsx(I,{className:"h-4 w-4"}),r.length," ",r.length===1?"вопрос":r.length<5?"вопроса":"вопросов"]}),e.jsxs("span",{className:"flex items-center gap-1",children:[e.jsx(L,{className:"h-4 w-4"}),"Всего баллов: ",A()]})]})]}),e.jsxs("button",{type:"button",onClick:()=>{u({id:"",testId:m||"",question:"",type:"SINGLE",order:r.length,points:1,options:[]})},className:"btn-primary text-sm",children:[e.jsx(M,{className:"h-4 w-4 mr-2"}),"Добавить вопрос"]})]}),r.length===0?e.jsxs("div",{className:"text-center py-12 border-2 border-dashed border-neutral-200 rounded-lg",children:[e.jsx(I,{className:"h-12 w-12 text-neutral-300 mx-auto mb-4"}),e.jsx("p",{className:"text-neutral-500 mb-2",children:"Нет вопросов"}),e.jsx("p",{className:"text-sm text-neutral-400",children:"Добавьте вопросы к тесту, нажав кнопку выше"})]}):e.jsx("div",{className:"space-y-3",children:r.map((s,l)=>e.jsx("div",{className:"border-2 border-neutral-200 rounded-lg p-4 hover:border-primary-300 transition-colors bg-white",children:e.jsxs("div",{className:"flex items-start gap-3",children:[e.jsxs("div",{className:"flex flex-col items-center gap-1 pt-1",children:[e.jsx("button",{type:"button",onClick:()=>P(l,"up"),disabled:l===0,className:"text-neutral-400 hover:text-neutral-600 disabled:opacity-30 disabled:cursor-not-allowed",title:"Вверх",children:"↑"}),e.jsx("span",{className:"text-xs font-medium text-neutral-500 bg-neutral-100 px-2 py-1 rounded",children:l+1}),e.jsx("button",{type:"button",onClick:()=>P(l,"down"),disabled:l===r.length-1,className:"text-neutral-400 hover:text-neutral-600 disabled:opacity-30 disabled:cursor-not-allowed",title:"Вниз",children:"↓"})]}),e.jsx("div",{className:"flex-1",children:e.jsxs("div",{className:"flex items-start justify-between gap-3",children:[e.jsxs("div",{className:"flex-1",children:[e.jsx("p",{className:"font-medium text-neutral-900 mb-2",children:s.question||"(Без текста)"}),e.jsxs("div",{className:"flex items-center gap-3 text-sm text-neutral-600",children:[e.jsxs("span",{className:"flex items-center gap-1",children:[s.type==="SINGLE"&&"○ Один ответ",s.type==="MULTIPLE"&&"☑ Несколько ответов",s.type==="TEXT"&&"✎ Текстовый ответ"]}),e.jsxs("span",{className:"flex items-center gap-1",children:[e.jsx(L,{className:"h-3 w-3"}),s.points," ",s.points===1?"балл":s.points<5?"балла":"баллов"]}),s.options&&s.options.length>0&&e.jsxs("span",{children:[s.options.length," ",s.options.length===1?"вариант":s.options.length<5?"варианта":"вариантов"]})]}),s.options&&s.options.length>0&&e.jsxs("div",{className:"mt-3 space-y-1",children:[s.options.slice(0,3).map((i,y)=>e.jsxs("div",{className:`text-xs px-2 py-1 rounded flex items-center gap-2 ${i.isCorrect?"bg-green-100 text-green-800":"bg-neutral-100 text-neutral-600"}`,children:[i.isCorrect&&e.jsx(G,{className:"h-3 w-3"}),e.jsx("span",{className:"truncate",children:i.text})]},y)),s.options.length>3&&e.jsxs("p",{className:"text-xs text-neutral-400",children:["+",s.options.length-3," еще"]})]})]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx("button",{type:"button",onClick:()=>u(s),className:"p-2 text-primary-600 hover:text-primary-700 hover:bg-primary-50 rounded transition-colors",title:"Редактировать",children:e.jsx(Z,{className:"h-4 w-4"})}),e.jsx("button",{type:"button",onClick:()=>V(l),className:"p-2 text-red-500 hover:text-red-600 hover:bg-red-50 rounded transition-colors",title:"Удалить",children:e.jsx(X,{className:"h-4 w-4"})})]})]})})]})},s.id||l))})]}),e.jsxs("div",{className:"flex gap-3",children:[e.jsx("button",{type:"button",onClick:()=>b(`/teacher/courses/${p}/edit`),className:"btn-secondary",children:"Отмена"}),e.jsxs("button",{type:"submit",disabled:o.isLoading,className:"btn-primary flex-1 disabled:opacity-50",children:[e.jsx(q,{className:"h-5 w-5 mr-2"}),o.isLoading?"Сохранение...":"Сохранить тест"]})]})]}),e.jsx(ae,{isOpen:j!==null,question:j,onClose:()=>u(null),onSave:x}),e.jsx(se,{isOpen:f.isOpen,message:f.message,onClose:()=>v({isOpen:!1,message:""})})]})}export{oe as default};
