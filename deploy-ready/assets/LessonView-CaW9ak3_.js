import{f as te,r as L,h as F,W as Y,k as Q,j as e,S as he,M as Se,ai as ke,aj as Ee,T as se,C as Ne,l as ye,ak as be,al as fe,a0 as H,am as Z,H as De,m as Le,ad as Ae,u as Te,an as Oe,ao as Re,ap as X,v as Ie,L as ge}from"./vendor-react-BfsyfZ9v.js";import{u as ve,R as $,C as we,a as D}from"./index-Da4DAFDw.js";import{t as q,o as $e,s as Me}from"./vendor-forms-BkiXKzYS.js";import{p as je}from"./vendor-utils-A66Cw1IH.js";import{u as Ue}from"./useSocket-BGhtp_8h.js";import"./vendor-other-Dj6_ObJ-.js";import"./vendor-network-Dklq3Edc.js";import"./vendor-i18n-DHwuzpMN.js";const Pe=s=>{const i=/^.*(youtu.be\/|v\/|u\/\w\/|embed\/|watch\?v=|&v=)([^#&?]*).*/,r=s.match(i);return r&&r[2].length===11?r[2]:null},_e=s=>{const i=/(?:vimeo\.com\/|player\.vimeo\.com\/video\/)(\d+)/,r=s.match(i);return r?r[1]:null},ze=s=>{const i=/drive\.google\.com\/file\/d\/([a-zA-Z0-9_-]+)/,r=s.match(i);return r?r[1]:null},Ce=s=>{if(!s)return"other";const i=s.toLowerCase();return i.includes("youtube.com")||i.includes("youtu.be")?"youtube":i.includes("vimeo.com")?"vimeo":i.includes("drive.google.com")?"google-drive":i.includes("vk.com/video")?"vk":/\.(mp4|webm|ogg|mov|avi|wmv|flv)(\?.*)?$/i.test(s)?"direct":"other"},Ve=s=>{if(!s)return null;switch(Ce(s)){case"youtube":{const r=Pe(s);return r?`https://www.youtube.com/embed/${r}`:null}case"vimeo":{const r=_e(s);return r?`https://player.vimeo.com/video/${r}`:null}case"google-drive":{const r=ze(s);return r?`https://drive.google.com/file/d/${r}/preview`:null}case"vk":return s;case"direct":case"other":return s;default:return s}},ee=$e({content:Me().min(1,"Комментарий не может быть пустым").max(1e3,"Комментарий слишком длинный")});function Fe({lessonId:s}){var ae,re;const{user:i}=ve(),r=te(),{socket:o}=Ue(),[I,k]=L.useState(null),[A,u]=L.useState(null),[S,h]=L.useState(1),[T,O]=L.useState({isOpen:!1,commentId:null});L.useEffect(()=>{if(o)return o.emit("join-lesson",s),o.on("new-comment",()=>{r.invalidateQueries(["comments",s])}),()=>{o&&(o.emit("leave-lesson",s),o.off("new-comment"))}},[o,s,r]);const{data:N,isLoading:V}=F(["comments",s,S],async()=>(await D.get(`/comments/lesson/${s}?page=${S}&limit=10`)).data,{refetchOnWindowFocus:!1}),M=((ae=N==null?void 0:N.data)==null?void 0:ae.comments)||[],y=(re=N==null?void 0:N.data)==null?void 0:re.pagination,{register:t,handleSubmit:v,reset:b,formState:{errors:c}}=Y({resolver:q(ee)}),{register:n,handleSubmit:m,reset:x,formState:{errors:f}}=Y({resolver:q(ee)}),{register:R,handleSubmit:G,reset:B,formState:{errors:J},setValue:W}=Y({resolver:q(ee)}),_=Q(async l=>(await D.post(`/comments/lesson/${s}`,l)).data,{onSuccess:()=>{r.invalidateQueries(["comments",s]),b(),k(null),x(),S!==1&&h(1)}}),a=Q(async l=>{await D.delete(`/comments/${l}`)},{onSuccess:()=>{r.invalidateQueries(["comments",s])}}),g=Q(async l=>(await D.put(`/comments/${l.commentId}`,{content:l.content})).data,{onSuccess:()=>{r.invalidateQueries(["comments",s]),u(null),B()}}),C=l=>{_.mutate(l)},w=(l,P)=>{_.mutate({...l,parentId:P})},d=(l,P)=>{g.mutate({commentId:P,content:l.content})},p=l=>{u(l.id),W("content",l.content)},z=l=>{if(!i||l.userId!==i.id)return!1;const P=Date.now()-new Date(l.createdAt).getTime(),K=15*60*1e3;return P<=K},j=l=>i?l.userId===i.id||i.role===$.TEACHER||i.role===$.ADMIN:!1,U=l=>i?i.role===$.TEACHER||i.role===$.ADMIN:!1;return e.jsxs("div",{className:"card p-6 md:p-8 animate-fade-scale",style:{animationDelay:"0.4s"},children:[e.jsx("h2",{className:"text-xl md:text-2xl font-semibold text-neutral-900 mb-6",children:"Комментарии и вопросы"}),(i==null?void 0:i.role)===$.STUDENT&&e.jsx("form",{onSubmit:v(C),className:"mb-6",children:e.jsxs("div",{className:"flex gap-3",children:[e.jsxs("div",{className:"flex-1",children:[e.jsx("textarea",{...t("content"),placeholder:"Оставьте комментарий или вопрос...",className:"input-field resize-none",rows:3}),c.content&&e.jsx("p",{className:"mt-1 text-sm text-red-600",children:c.content.message})]}),e.jsx("button",{type:"submit",disabled:_.isLoading,className:"btn-primary px-6 py-3 h-fit disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center",children:_.isLoading?e.jsx("span",{className:"animate-spin",children:"⟳"}):e.jsx(he,{className:"h-5 w-5"})})]})}),V?e.jsxs("div",{className:"text-center py-8",children:[e.jsx("div",{className:"inline-block animate-spin rounded-full h-8 w-8 border-4 border-primary-200 border-t-primary-500"}),e.jsx("p",{className:"mt-4 text-neutral-600",children:"Загрузка комментариев..."})]}):M.length===0?e.jsxs("div",{className:"text-center py-8",children:[e.jsx(Se,{className:"mx-auto h-12 w-12 text-neutral-400 mb-4"}),e.jsx("p",{className:"text-neutral-600",children:"Нет комментариев"}),e.jsx("p",{className:"text-sm text-neutral-500 mt-2",children:"Будьте первым, кто оставит комментарий!"})]}):e.jsxs("div",{className:"space-y-4",children:[M.map(l=>{var P,K,ne,le,ie,de;return e.jsxs("div",{className:"border border-neutral-200 rounded-lg p-4 bg-white animate-slide-in hover:shadow-sm transition-shadow",children:[e.jsxs("div",{className:"flex items-start gap-3 mb-3",children:[e.jsx("div",{className:"flex-shrink-0 w-10 h-10 rounded-full bg-gradient-primary text-white flex items-center justify-center font-bold",children:((K=(P=l.user)==null?void 0:P.firstName)==null?void 0:K[0])||"U"}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-1",children:[e.jsxs("span",{className:"font-semibold text-neutral-900",children:[(ne=l.user)==null?void 0:ne.firstName," ",(le=l.user)==null?void 0:le.lastName]}),(((ie=l.user)==null?void 0:ie.role)===$.TEACHER||((de=l.user)==null?void 0:de.role)===$.ADMIN)&&e.jsx("span",{className:"text-xs px-2 py-0.5 rounded-full bg-primary-100 text-primary-700 border border-primary-200 font-medium",children:"Преподаватель"})]}),A===l.id?e.jsxs("form",{onSubmit:G(E=>d(E,l.id)),className:"mb-2",children:[e.jsx("textarea",{...R("content"),className:"input-field text-sm resize-none",rows:3}),J.content&&e.jsx("p",{className:"mt-1 text-xs text-red-600",children:J.content.message}),e.jsxs("div",{className:"flex gap-2 mt-2",children:[e.jsx("button",{type:"submit",disabled:g.isLoading,className:"btn-primary px-3 py-1 text-sm disabled:opacity-50",children:"Сохранить"}),e.jsx("button",{type:"button",onClick:()=>{u(null),B()},className:"btn-secondary px-3 py-1 text-sm",children:"Отмена"})]})]}):e.jsx("p",{className:"text-neutral-700 text-sm mb-2 whitespace-pre-wrap",dangerouslySetInnerHTML:{__html:je.sanitize(l.content,{ALLOWED_TAGS:[]})}}),e.jsxs("div",{className:"flex items-center gap-4 text-xs text-neutral-500",children:[e.jsx("span",{children:new Date(l.createdAt).toLocaleString("ru-RU")}),z(l)&&A!==l.id&&e.jsxs("button",{onClick:()=>p(l),className:"text-primary-600 hover:text-primary-700 transition-colors flex items-center gap-1",children:[e.jsx(ke,{size:14}),e.jsx("span",{children:"Редактировать"})]}),U()&&e.jsxs("button",{onClick:()=>k(I===l.id?null:l.id),className:"text-primary-600 hover:text-primary-700 transition-colors flex items-center gap-1",children:[e.jsx(Ee,{size:14}),e.jsx("span",{children:"Ответить"})]}),j(l)&&e.jsxs("button",{onClick:()=>O({isOpen:!0,commentId:l.id}),className:"text-red-600 hover:text-red-700 transition-colors flex items-center gap-1",children:[e.jsx(se,{size:14}),e.jsx("span",{children:"Удалить"})]})]})]})]}),I===l.id&&U()&&e.jsxs("form",{onSubmit:m(E=>w(E,l.id)),className:"mt-3 ml-12 md:ml-14 border-l-2 border-primary-300 pl-4",children:[e.jsxs("div",{className:"flex gap-2",children:[e.jsx("textarea",{...n("content"),placeholder:"Ответить...",className:"input-field flex-1 text-sm resize-none",rows:2}),e.jsx("button",{type:"submit",disabled:_.isLoading,className:"btn-primary px-4 py-2 h-fit disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center",children:_.isLoading?e.jsx("span",{className:"animate-spin",children:"⟳"}):e.jsx(he,{className:"h-4 w-4"})})]}),f.content&&e.jsx("p",{className:"mt-1 text-xs text-red-600",children:f.content.message})]}),l.replies&&l.replies.length>0&&e.jsx("div",{className:"mt-3 ml-12 md:ml-14 space-y-3 border-l-2 border-primary-200 pl-4",children:l.replies.map(E=>{var ce,oe,me,xe,pe,ue;return e.jsxs("div",{className:"flex items-start gap-3",children:[e.jsx("div",{className:"flex-shrink-0 w-8 h-8 rounded-full bg-gradient-primary text-white flex items-center justify-center font-bold text-sm",children:((oe=(ce=E.user)==null?void 0:ce.firstName)==null?void 0:oe[0])||"T"}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-1",children:[e.jsxs("span",{className:"font-semibold text-neutral-900 text-sm",children:[(me=E.user)==null?void 0:me.firstName," ",(xe=E.user)==null?void 0:xe.lastName]}),(((pe=E.user)==null?void 0:pe.role)===$.TEACHER||((ue=E.user)==null?void 0:ue.role)===$.ADMIN)&&e.jsx("span",{className:"text-xs px-1.5 py-0.5 rounded-full bg-primary-100 text-primary-700 border border-primary-200 font-medium",children:"Преподаватель"})]}),e.jsx("p",{className:"text-neutral-700 text-sm mb-1 whitespace-pre-wrap",dangerouslySetInnerHTML:{__html:je.sanitize(E.content,{ALLOWED_TAGS:[]})}}),e.jsxs("div",{className:"flex items-center gap-4 text-xs text-neutral-500",children:[e.jsx("span",{children:new Date(E.createdAt).toLocaleString("ru-RU")}),j(E)&&e.jsxs("button",{onClick:()=>O({isOpen:!0,commentId:E.id}),className:"text-red-600 hover:text-red-700 transition-colors flex items-center gap-1",children:[e.jsx(se,{size:12}),e.jsx("span",{children:"Удалить"})]})]})]})]},E.id)})})]},l.id)}),y&&y.totalPages>1&&e.jsxs("div",{className:"flex flex-col sm:flex-row items-center justify-between mt-6 pt-6 border-t border-neutral-200 gap-4",children:[e.jsxs("div",{className:"text-sm text-neutral-600",children:["Показано ",(y.page-1)*y.limit+1,"-",Math.min(y.page*y.limit,y.total)," из ",y.total," комментариев"]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs("button",{onClick:()=>h(S-1),disabled:S===1,className:"btn-secondary px-4 py-2 disabled:opacity-50 disabled:cursor-not-allowed flex items-center gap-2 transition-all",title:"Предыдущая страница",children:[e.jsx(Ne,{size:16}),e.jsx("span",{className:"hidden sm:inline",children:"Назад"})]}),e.jsxs("div",{className:"flex items-center gap-1 px-3 py-2 bg-primary-50 rounded-lg border border-primary-200",children:[e.jsx("span",{className:"text-sm font-semibold text-primary-700",children:y.page}),e.jsx("span",{className:"text-sm text-primary-500",children:"/"}),e.jsx("span",{className:"text-sm text-primary-600",children:y.totalPages})]}),e.jsxs("button",{onClick:()=>h(S+1),disabled:!y.hasMore,className:"btn-secondary px-4 py-2 disabled:opacity-50 disabled:cursor-not-allowed flex items-center gap-2 transition-all",title:"Следующая страница",children:[e.jsx("span",{className:"hidden sm:inline",children:"Вперед"}),e.jsx(ye,{size:16})]})]})]})]}),e.jsx(we,{isOpen:T.isOpen,onClose:()=>O({isOpen:!1,commentId:null}),onConfirm:()=>{T.commentId&&a.mutate(T.commentId)},title:"Удалить комментарий",message:"Вы уверены, что хотите удалить этот комментарий? Это действие нельзя отменить.",confirmText:"Удалить",cancelText:"Отмена",variant:"danger"})]})}function He({question:s,onAnswer:i,showResult:r,correctAnswer:o}){const[I,k]=L.useState([]),[A,u]=L.useState([]),[S,h]=L.useState([]),[T,O]=L.useState({});L.useEffect(()=>{if(s.metadata){const c=JSON.parse(s.metadata);s.type==="DRAG_DROP"?(k([...c.items]),u(c.targets.map(()=>null))):s.type==="MATCHING"&&h(c.leftItems.map(n=>({left:n,right:null})))}},[s]);const N=(c,n)=>{c.dataTransfer.setData("text/plain",n)},V=(c,n)=>{c.preventDefault();const m=c.dataTransfer.getData("text/plain"),x=[...A];x[n]=m,u(x),k(I.filter(f=>f!==m)),i(x)},M=c=>{c.preventDefault()},y=(c,n)=>{const m=[...S];m[c].right=n,h(m),i(m)},t=(c,n)=>{O({...T,[c]:n}),i(T)},v=()=>{if(s.metadata){const c=JSON.parse(s.metadata);k([...c.items]),u(c.targets.map(()=>null))}},b=()=>{if(s.metadata){const c=JSON.parse(s.metadata);h(c.leftItems.map(n=>({left:n,right:null})))}};if(s.type==="DRAG_DROP"){const c=s.metadata?JSON.parse(s.metadata):null;return c?e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{children:[e.jsx("h3",{className:"text-lg font-semibold text-neutral-900 mb-4",children:s.question}),e.jsxs("button",{onClick:v,className:"text-sm text-primary-600 hover:text-primary-700 mb-4 flex items-center gap-1",children:[e.jsx(be,{className:"h-4 w-4"}),"Сбросить"]})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-6",children:[e.jsxs("div",{children:[e.jsx("h4",{className:"text-sm font-medium text-neutral-700 mb-3",children:"Перетащите элементы:"}),e.jsx("div",{className:"space-y-2",children:I.map((n,m)=>e.jsx("div",{draggable:!0,onDragStart:x=>N(x,n),className:"p-3 bg-primary-100 text-primary-900 rounded-lg cursor-move hover:bg-primary-200 transition-colors",children:n},m))})]}),e.jsxs("div",{children:[e.jsx("h4",{className:"text-sm font-medium text-neutral-700 mb-3",children:"Целевые области:"}),e.jsx("div",{className:"space-y-2",children:c.targets.map((n,m)=>e.jsx("div",{onDrop:x=>V(x,m),onDragOver:M,className:`p-3 border-2 border-dashed rounded-lg min-h-[50px] flex items-center ${A[m]?"border-primary-500 bg-primary-50":"border-neutral-300"}`,children:A[m]?e.jsx("span",{className:"text-primary-900 font-medium",children:A[m]}):e.jsx("span",{className:"text-neutral-400",children:n})},m))})]})]}),r&&o&&e.jsx("div",{className:"mt-4 p-4 rounded-lg bg-neutral-50",children:e.jsxs("p",{className:"text-sm text-neutral-600",children:["Правильный ответ: ",JSON.stringify(o)]})})]}):null}if(s.type==="MATCHING"){const c=s.metadata?JSON.parse(s.metadata):null;return c?e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{children:[e.jsx("h3",{className:"text-lg font-semibold text-neutral-900 mb-4",children:s.question}),e.jsxs("button",{onClick:b,className:"text-sm text-primary-600 hover:text-primary-700 mb-4 flex items-center gap-1",children:[e.jsx(be,{className:"h-4 w-4"}),"Сбросить"]})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-6",children:[e.jsxs("div",{children:[e.jsx("h4",{className:"text-sm font-medium text-neutral-700 mb-3",children:"Левая колонка:"}),e.jsx("div",{className:"space-y-2",children:S.map((n,m)=>e.jsx("div",{className:`p-3 rounded-lg border-2 ${n.right?"border-primary-500 bg-primary-50":"border-neutral-300 bg-neutral-50"}`,children:n.left},m))})]}),e.jsxs("div",{children:[e.jsx("h4",{className:"text-sm font-medium text-neutral-700 mb-3",children:"Правая колонка:"}),e.jsx("div",{className:"space-y-2",children:c.rightItems.map((n,m)=>{const x=S.some(f=>f.right===n);return e.jsx("button",{onClick:()=>{const f=S.findIndex(R=>!R.right);f!==-1&&!x&&y(f,n)},disabled:x,className:`w-full p-3 rounded-lg border-2 text-left transition-colors ${x?"border-primary-500 bg-primary-50 cursor-not-allowed":"border-neutral-300 hover:border-primary-300 hover:bg-primary-50"}`,children:n},m)})})]})]}),r&&o&&e.jsx("div",{className:"mt-4 p-4 rounded-lg bg-neutral-50",children:e.jsxs("p",{className:"text-sm text-neutral-600",children:["Правильные пары: ",JSON.stringify(o)]})})]}):null}if(s.type==="FILL_BLANK"){const c=s.metadata?JSON.parse(s.metadata):null;if(!c)return null;const n=c.text.split("___");return e.jsxs("div",{className:"space-y-4",children:[e.jsx("h3",{className:"text-lg font-semibold text-neutral-900 mb-4",children:s.question}),e.jsx("div",{className:"p-4 bg-neutral-50 rounded-lg",children:n.map((m,x)=>e.jsxs("span",{children:[m,x<n.length-1&&e.jsx("input",{type:"text",value:T[x]||"",onChange:f=>t(x,f.target.value),className:"inline-block mx-2 px-2 py-1 border-2 border-primary-300 rounded focus:outline-none focus:border-primary-500 min-w-[100px]",placeholder:"..."})]},x))}),r&&o&&e.jsx("div",{className:"mt-4 p-4 rounded-lg bg-neutral-50",children:e.jsxs("p",{className:"text-sm text-neutral-600",children:["Правильный ответ: ",JSON.stringify(o)]})})]})}return null}function Qe({lessonId:s,onComplete:i}){const r=te(),[o,I]=L.useState({}),[k,A]=L.useState(!1),[u,S]=L.useState(null),{data:h,isLoading:T}=F(["quiz",s],async()=>(await D.get(`/quizzes/lesson/${s}`)).data.data,{enabled:!!s}),O=Q(async t=>(await D.post(`/quizzes/lesson/${s}/submit`,{answers:t})).data.data,{onSuccess:t=>{S(t),A(!0),r.invalidateQueries(["quiz",s]),i&&i(t)}}),N=(t,v)=>{I(b=>({...b,[t]:typeof v=="string"?v:JSON.stringify(v)}))},V=()=>{if(h&&Object.keys(o).length===h.questions.length){const t={};Object.keys(o).forEach(v=>{t[v]=o[v]}),O.mutate(t)}};if(T)return e.jsxs("div",{className:"card p-6 text-center",children:[e.jsx(fe,{className:"h-8 w-8 animate-spin text-primary-500 mx-auto mb-4"}),e.jsx("p",{className:"text-neutral-600",children:"Загрузка теста..."})]});if(!h)return null;const M=Object.keys(o).length===h.questions.length,y=M&&!k&&!O.isLoading;return e.jsxs("div",{className:"card p-6 md:p-8 animate-fade-scale",children:[e.jsxs("div",{className:"mb-6",children:[e.jsx("h2",{className:"text-2xl md:text-3xl font-bold text-gradient mb-2",children:h.title||"Тест по уроку"}),h.description&&e.jsx("p",{className:"text-neutral-600 mb-4",children:h.description}),e.jsxs("div",{className:"flex items-center gap-4 text-sm text-neutral-500",children:[e.jsxs("span",{children:["Вопросов: ",h.questions.length]}),e.jsxs("span",{children:["Проходной балл: ",h.passingScore,"%"]})]})]}),k&&u?e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:`p-6 rounded-lg border-2 ${u.passed?"bg-green-50 border-green-200":"bg-red-50 border-red-200"}`,children:[e.jsxs("div",{className:"flex items-center gap-3 mb-4",children:[u.passed?e.jsx(H,{className:"h-8 w-8 text-green-600"}):e.jsx(Z,{className:"h-8 w-8 text-red-600"}),e.jsxs("div",{children:[e.jsx("h3",{className:`text-xl font-bold ${u.passed?"text-green-700":"text-red-700"}`,children:u.passed?"Тест пройден!":"Тест не пройден"}),e.jsxs("p",{className:`text-sm ${u.passed?"text-green-600":"text-red-600"}`,children:["Ваш результат: ",u.score,"%"]})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex justify-between text-sm",children:[e.jsx("span",{className:"text-neutral-600",children:"Правильных ответов:"}),e.jsxs("span",{className:"font-semibold",children:[u.correctAnswers," из ",u.totalQuestions]})]}),e.jsxs("div",{className:"flex justify-between text-sm",children:[e.jsx("span",{className:"text-neutral-600",children:"Проходной балл:"}),e.jsxs("span",{className:"font-semibold",children:[u.passingScore,"%"]})]})]})]}),e.jsxs("div",{className:"space-y-4",children:[e.jsx("h3",{className:"text-lg font-semibold text-neutral-900",children:"Правильные ответы:"}),h.questions.map((t,v)=>{var n,m;const b=o[t.id],c=t.type==="MULTIPLE_CHOICE"?(m=(n=t.options)==null?void 0:n.find(x=>x.id===b))==null?void 0:m.isCorrect:b===t.correctAnswer;return e.jsx("div",{className:`p-4 rounded-lg border-2 ${c?"bg-green-50 border-green-200":"bg-red-50 border-red-200"}`,children:e.jsxs("div",{className:"flex items-start gap-2 mb-3",children:[c?e.jsx(H,{className:"h-5 w-5 text-green-600 mt-0.5 flex-shrink-0"}):e.jsx(Z,{className:"h-5 w-5 text-red-600 mt-0.5 flex-shrink-0"}),e.jsxs("div",{className:"flex-1",children:[e.jsxs("p",{className:"font-semibold text-neutral-900 mb-2",children:[v+1,". ",t.question]}),t.type==="MULTIPLE_CHOICE"&&t.options&&e.jsx("div",{className:"space-y-2",children:t.options.map(x=>{const f=x.id===b,R=x.isCorrect;return e.jsx("div",{className:`p-2 rounded ${R?"bg-green-100 border-2 border-green-300":f?"bg-red-100 border-2 border-red-300":"bg-neutral-50 border border-neutral-200"}`,children:e.jsxs("div",{className:"flex items-center gap-2",children:[R&&e.jsx(H,{className:"h-4 w-4 text-green-600"}),f&&!R&&e.jsx(Z,{className:"h-4 w-4 text-red-600"}),e.jsx("span",{className:R?"font-semibold text-green-700":f?"text-red-700":"text-neutral-700",children:x.text})]})},x.id)})}),t.type==="TRUE_FALSE"&&e.jsxs("div",{className:"space-y-2",children:[e.jsx("div",{className:`p-2 rounded ${t.correctAnswer==="true"?"bg-green-100 border-2 border-green-300":"bg-neutral-50 border border-neutral-200"}`,children:e.jsxs("div",{className:"flex items-center gap-2",children:[t.correctAnswer==="true"&&e.jsx(H,{className:"h-4 w-4 text-green-600"}),e.jsx("span",{className:t.correctAnswer==="true"?"font-semibold text-green-700":"text-neutral-700",children:"Верно"})]})}),e.jsx("div",{className:`p-2 rounded ${t.correctAnswer==="false"?"bg-green-100 border-2 border-green-300":"bg-neutral-50 border border-neutral-200"}`,children:e.jsxs("div",{className:"flex items-center gap-2",children:[t.correctAnswer==="false"&&e.jsx(H,{className:"h-4 w-4 text-green-600"}),e.jsx("span",{className:t.correctAnswer==="false"?"font-semibold text-green-700":"text-neutral-700",children:"Неверно"})]})})]})]})]})},t.id)})]})]}):e.jsxs("div",{className:"space-y-6",children:[h.questions.map((t,v)=>e.jsx("div",{className:"space-y-3",children:e.jsxs("div",{className:"flex items-start gap-3",children:[e.jsx("span",{className:"flex items-center justify-center w-8 h-8 rounded-full bg-gradient-primary text-white font-semibold flex-shrink-0",children:v+1}),e.jsxs("div",{className:"flex-1",children:[e.jsx("p",{className:"font-semibold text-neutral-900 mb-3",children:t.question}),t.type==="MULTIPLE_CHOICE"&&t.options&&e.jsx("div",{className:"space-y-2",children:t.options.map(b=>e.jsxs("label",{className:`flex items-center gap-3 p-3 rounded-lg border-2 cursor-pointer transition-all ${o[t.id]===b.id?"border-primary-500 bg-primary-50":"border-neutral-200 hover:border-primary-300 hover:bg-neutral-50"}`,children:[e.jsx("input",{type:"radio",name:t.id,value:b.id,checked:o[t.id]===b.id,onChange:()=>N(t.id,b.id),className:"w-4 h-4 text-primary-500 focus:ring-primary-500"}),e.jsx("span",{className:"text-neutral-700",children:b.text})]},b.id))}),t.type==="TRUE_FALSE"&&e.jsxs("div",{className:"space-y-2",children:[e.jsxs("label",{className:`flex items-center gap-3 p-3 rounded-lg border-2 cursor-pointer transition-all ${o[t.id]==="true"?"border-primary-500 bg-primary-50":"border-neutral-200 hover:border-primary-300 hover:bg-neutral-50"}`,children:[e.jsx("input",{type:"radio",name:t.id,value:"true",checked:o[t.id]==="true",onChange:()=>N(t.id,"true"),className:"w-4 h-4 text-primary-500 focus:ring-primary-500"}),e.jsx("span",{className:"text-neutral-700",children:"Верно"})]}),e.jsxs("label",{className:`flex items-center gap-3 p-3 rounded-lg border-2 cursor-pointer transition-all ${o[t.id]==="false"?"border-primary-500 bg-primary-50":"border-neutral-200 hover:border-primary-300 hover:bg-neutral-50"}`,children:[e.jsx("input",{type:"radio",name:t.id,value:"false",checked:o[t.id]==="false",onChange:()=>N(t.id,"false"),className:"w-4 h-4 text-primary-500 focus:ring-primary-500"}),e.jsx("span",{className:"text-neutral-700",children:"Неверно"})]})]}),(t.type==="DRAG_DROP"||t.type==="MATCHING"||t.type==="FILL_BLANK")&&e.jsx(He,{question:t,onAnswer:b=>N(t.id,b),showResult:k,correctAnswer:t.correctAnswer?JSON.parse(t.correctAnswer):void 0})]})]})},t.id)),e.jsxs("div",{className:"pt-4 border-t border-neutral-200",children:[!M&&e.jsxs("div",{className:"flex items-center gap-2 text-amber-600 mb-4",children:[e.jsx(De,{className:"h-5 w-5"}),e.jsx("span",{className:"text-sm",children:"Ответьте на все вопросы для завершения теста"})]}),e.jsx("button",{onClick:V,disabled:!y,className:"btn-primary w-full md:w-auto disabled:opacity-50 disabled:cursor-not-allowed",children:O.isLoading?e.jsxs("span",{className:"flex items-center gap-2",children:[e.jsx(fe,{className:"h-5 w-5 animate-spin"}),e.jsx("span",{children:"Отправка..."})]}):"Завершить тест"})]})]})]})}function qe(){var J,W,_;const{t:s}=Le(),{courseId:i,lessonId:r}=Ae(),o=Te(),I=te(),{user:k}=ve(),[A,u]=L.useState({isOpen:!1,fileId:null}),{data:S,isLoading:h}=F(["lesson",r],async()=>(await D.get(`/lessons/${r}`)).data.data),{data:T}=F(["practiceExercises",r],async()=>{try{return(await D.get(`/practice/lessons/${r}`)).data.data||[]}catch{return[]}},{enabled:!!r}),{data:O}=F(["flashcardDecks",r],async()=>{try{return(await D.get("/flashcards",{params:{lessonId:r}})).data.data||[]}catch{return[]}},{enabled:!!r}),{data:N}=F(["integrations",r],async()=>{try{return(await D.get("/integrations",{params:{lessonId:r}})).data.data||[]}catch{return[]}},{enabled:!!r}),{data:V}=F(["courseLessons",i],async()=>(await D.get(`/courses/${i}/lessons`)).data.data||[],{enabled:!!i}),M=Q(async a=>(await D.put(`/lessons/${r}/progress`,a)).data,{onSuccess:()=>{I.invalidateQueries(["lesson",r])}}),y=Q(async a=>{await D.delete(`/files/${a}`)},{onSuccess:()=>{I.invalidateQueries(["lesson",r]),u({isOpen:!1,fileId:null})}}),t=a=>k?k.role===$.TEACHER||k.role===$.ADMIN:!1,v=async(a,g,C)=>{a.preventDefault(),a.stopPropagation(),a.nativeEvent&&a.nativeEvent.stopImmediatePropagation();try{let w=C;try{if(/[ĐÑ€Ð£]/.test(C))try{const d=new Uint8Array(C.length);for(let p=0;p<C.length;p++)d[p]=C.charCodeAt(p)&255;w=new TextDecoder("utf-8",{fatal:!1}).decode(d),/[ĐÑ€Ð£]/.test(w)&&(w=decodeURIComponent(escape(C)))}catch{w=decodeURIComponent(escape(C))}else if(C.includes("%"))try{w=decodeURIComponent(C)}catch{w=C}}catch{w=C}if(g.includes("supabase.co")||g.includes("cloudinary.com")||g.startsWith("http")&&!g.includes("/api/files/"))try{const d=await fetch(g,{mode:"cors"});if(!d.ok)throw new Error("Failed to fetch file");const p=await d.blob(),z=window.URL.createObjectURL(p),j=document.createElement("a");j.href=z,j.download=w,j.style.display="none",document.body.appendChild(j),j.click(),setTimeout(()=>{document.body.contains(j)&&document.body.removeChild(j),window.URL.revokeObjectURL(z)},100)}catch(d){console.error("Error fetching cloud file:",d);const p=document.createElement("a");p.href=g,p.download=w,p.target="_blank",p.rel="noopener noreferrer",p.style.display="none",document.body.appendChild(p),p.click(),setTimeout(()=>{document.body.contains(p)&&document.body.removeChild(p)},100)}else{const d=g.replace("/api/files/download/",""),p=await D.get(`/files/download/${d}`,{responseType:"blob"}),z=new Blob([p.data]),j=window.URL.createObjectURL(z),U=document.createElement("a");U.href=j,U.download=w,U.style.display="none",document.body.appendChild(U),U.click(),setTimeout(()=>{document.body.contains(U)&&document.body.removeChild(U),window.URL.revokeObjectURL(j)},100)}}catch(w){console.error("Error downloading file:",w);try{const d=document.createElement("a");d.href=g,d.target="_blank",d.rel="noopener noreferrer",d.style.display="none",document.body.appendChild(d),d.click(),setTimeout(()=>{document.body.contains(d)&&document.body.removeChild(d)},100)}catch(d){console.error("Fallback download also failed:",d)}}return!1},b=a=>{M.mutate({lastPosition:Math.floor(a.playedSeconds)})},c=()=>{M.mutate({completed:!0})};if(h)return e.jsxs("div",{className:"text-center py-12",children:[e.jsx("div",{className:"inline-block relative",children:e.jsx("div",{className:"animate-spin rounded-full h-12 w-12 border-4 border-primary-200 border-t-primary-500"})}),e.jsx("p",{className:"mt-4 text-neutral-600",children:s("common.loading")})]});const n=S;if(!n)return e.jsx("div",{className:"text-center py-12",children:e.jsx("p",{className:"text-neutral-600",children:s("errors.notFound")})});const m=V||[],x=m.findIndex(a=>a.id===r),f=x>0?m[x-1]:null,R=x<m.length-1?m[x+1]:null,G=n.videoUrl?Ve(n.videoUrl):null,B=n.videoUrl?Ce(n.videoUrl):null;return e.jsxs("div",{children:[e.jsxs("button",{onClick:()=>o(`/courses/${i}`),className:"flex items-center text-neutral-600 hover:text-primary-600 mb-6 transition-colors group",children:[e.jsx(Oe,{className:"h-5 w-5 mr-2 group-hover:-translate-x-1 transition-transform"}),"Назад к курсу"]}),e.jsxs("div",{className:"card rounded-lg shadow-soft border border-neutral-200 p-4 md:p-6 mb-6 animate-fade-scale",children:[e.jsx("h1",{className:"text-xl md:text-2xl lg:text-4xl font-bold text-gradient mb-4 break-words",children:n.title}),n.description&&e.jsx("p",{className:"text-neutral-600 mb-6",children:n.description}),((J=n.progress)==null?void 0:J.completed)&&e.jsxs("div",{className:"inline-flex items-center px-3 py-1 rounded-full text-sm font-medium bg-green-100 text-green-700 border border-green-200",children:[e.jsx(H,{className:"h-4 w-4 mr-1 text-green-700"}),s("lessons.completed")]})]}),G&&e.jsxs("div",{className:"card rounded-lg shadow-soft border border-neutral-200 p-4 md:p-6 mb-6 animate-fade-scale",style:{animationDelay:"0.1s"},children:[e.jsx("h2",{className:"text-lg md:text-xl font-semibold text-neutral-900 mb-4",children:s("lessons.videoLesson",{defaultValue:"Видео урок"})}),e.jsx("div",{className:"aspect-video",children:B==="google-drive"?e.jsx("iframe",{src:G||"",width:"100%",height:"100%",allow:"autoplay",style:{border:"none"},allowFullScreen:!0}):e.jsx(Re,{url:n.videoUrl||"",width:"100%",height:"100%",controls:!0,onProgress:b,onEnded:c,config:{youtube:{playerVars:{start:((W=n.progress)==null?void 0:W.lastPosition)||0}},vimeo:{playerOptions:{start:((_=n.progress)==null?void 0:_.lastPosition)||0}}}})})]}),n.files&&n.files.length>0&&e.jsxs("div",{className:"card rounded-lg shadow-soft border border-neutral-200 p-4 md:p-6 mb-6 animate-fade-scale",style:{animationDelay:"0.2s"},children:[e.jsx("h2",{className:"text-lg md:text-xl font-semibold text-neutral-900 mb-4",children:s("lessons.files",{defaultValue:"Файлы урока"})}),e.jsx("div",{className:"space-y-3",children:n.files.map(a=>{const g=/\.(mp4|webm|mov|avi|wmv|flv|mpeg)$/i.test(a.fileName),C=/\.(pdf|doc|docx|xls|xlsx|ppt|pptx|txt)$/i.test(a.fileName),w=/\.(jpg|jpeg|png|gif|webp)$/i.test(a.fileName);return e.jsxs("div",{className:"flex flex-col sm:flex-row items-start sm:items-center justify-between gap-3 sm:gap-0 p-3 md:p-4 border border-neutral-200 rounded-lg hover:bg-neutral-50 hover:border-primary-300 transition-all group",children:[e.jsxs("div",{className:"flex items-center flex-1 min-w-0",children:[e.jsx("div",{className:"flex-shrink-0 mr-3",children:C?e.jsx(X,{className:"h-5 w-5 text-blue-500"}):g?e.jsx(Ie,{className:"h-5 w-5 text-purple-500"}):w?e.jsx(X,{className:"h-5 w-5 text-green-500"}):e.jsx(X,{className:"h-5 w-5 text-primary-500"})}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsx("p",{className:"font-medium text-neutral-900 truncate",title:a.fileName,children:(()=>{try{const d=a.fileName;if(/[ĐÑ€Ð£]/.test(d))try{const p=new Uint8Array(d.length);for(let j=0;j<d.length;j++)p[j]=d.charCodeAt(j)&255;const z=new TextDecoder("utf-8",{fatal:!1}).decode(p);return/[ĐÑ€Ð£]/.test(z)?decodeURIComponent(escape(d)):z}catch{return decodeURIComponent(escape(d))}return d}catch{return a.fileName}})()}),e.jsxs("p",{className:"text-sm text-neutral-500",children:[s("lessons.fileSize",{defaultValue:"Размер"}),": ",(a.fileSize/1024/1024).toFixed(2)," MB",g&&e.jsx("span",{className:"ml-2 text-purple-600",children:"• Видео"}),C&&e.jsx("span",{className:"ml-2 text-blue-600",children:"• Документ"}),w&&e.jsx("span",{className:"ml-2 text-green-600",children:"• Изображение"})]})]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs("button",{type:"button",onClick:d=>{d.preventDefault(),d.stopPropagation(),v(d,a.fileUrl,a.fileName)},className:"btn-secondary px-4 py-2 text-sm flex items-center gap-2",children:[e.jsx(X,{className:"h-4 w-4"}),g?"Смотреть":"Скачать"]}),t()&&e.jsxs("button",{type:"button",onClick:d=>{d.preventDefault(),d.stopPropagation(),u({isOpen:!0,fileId:a.id})},className:"px-3 py-2 text-sm text-red-600 hover:text-red-700 hover:bg-red-50 border border-red-200 rounded-lg transition-colors flex items-center gap-2",title:"Удалить файл",children:[e.jsx(se,{className:"h-4 w-4"}),e.jsx("span",{className:"hidden sm:inline",children:"Удалить"})]})]})]},a.id)})})]}),N&&N.length>0&&e.jsxs("div",{className:"card rounded-lg shadow-soft border border-neutral-200 p-4 md:p-6 mb-6 animate-fade-scale",style:{animationDelay:"0.22s"},children:[e.jsx("h2",{className:"text-lg md:text-xl font-semibold text-neutral-900 mb-4",children:s("lessons.additionalMaterials",{defaultValue:"Дополнительные материалы"})}),e.jsx("div",{className:"space-y-4",children:N.map(a=>e.jsxs("div",{className:"p-4 border border-neutral-200 rounded-lg",children:[e.jsx("h3",{className:"font-semibold text-neutral-900 mb-2",children:a.type}),e.jsxs("a",{href:a.externalUrl,target:"_blank",rel:"noopener noreferrer",className:"btn-secondary text-sm inline-flex items-center gap-2",children:[s("integrations.open")," ",a.type]})]},a.id))})]}),T&&T.length>0&&e.jsxs("div",{className:"card rounded-lg shadow-soft border border-neutral-200 p-4 md:p-6 mb-6 animate-fade-scale",style:{animationDelay:"0.23s"},children:[e.jsx("h2",{className:"text-lg md:text-xl font-semibold text-neutral-900 mb-6",children:s("practice.title")}),e.jsx("div",{className:"space-y-6",children:T.map(a=>e.jsxs("div",{className:"p-4 border border-neutral-200 rounded-lg",children:[e.jsx("h3",{className:"text-lg font-semibold text-neutral-900 mb-2",children:a.title}),a.description&&e.jsx("p",{className:"text-neutral-600 mb-4",children:a.description}),e.jsx("p",{className:"text-sm text-neutral-500 mb-4",children:a.instructions}),e.jsx(ge,{to:`/lessons/${r}/practice`,className:"btn-primary text-sm",children:s("practice.execute",{defaultValue:"Выполнить упражнение"})})]},a.id))})]}),O&&O.length>0&&e.jsxs("div",{className:"card rounded-lg shadow-soft border border-neutral-200 p-4 md:p-6 mb-6 animate-fade-scale",style:{animationDelay:"0.24s"},children:[e.jsx("h2",{className:"text-lg md:text-xl font-semibold text-neutral-900 mb-4",children:s("flashcards.title")}),e.jsx("div",{className:"space-y-4",children:O.map(a=>{var g;return e.jsxs("div",{className:"p-4 border border-neutral-200 rounded-lg",children:[e.jsx("h3",{className:"text-lg font-semibold text-neutral-900 mb-2",children:a.title}),a.description&&e.jsx("p",{className:"text-neutral-600 mb-4 text-sm",children:a.description}),e.jsxs("p",{className:"text-sm text-neutral-500 mb-4",children:[((g=a._count)==null?void 0:g.flashcards)||0," карточек"]}),e.jsx(ge,{to:`/flashcards/${a.id}/study`,className:"btn-primary text-sm",children:s("flashcards.study")})]},a.id)})})]}),e.jsx("div",{className:"mb-6 animate-fade-scale",style:{animationDelay:"0.25s"},children:e.jsx(Qe,{lessonId:r,onComplete:a=>{a.passed&&I.invalidateQueries(["lesson",r])}})}),e.jsx(Fe,{lessonId:r}),e.jsxs("div",{className:"flex flex-col sm:flex-row items-stretch sm:items-center justify-between gap-3 sm:gap-4 mt-6 md:mt-8 animate-fade-scale",style:{animationDelay:"0.3s"},children:[f?e.jsxs("button",{onClick:()=>o(`/courses/${i}/lessons/${f.id}`),className:"btn-secondary group flex items-center gap-3 flex-1",children:[e.jsx(Ne,{className:"h-5 w-5 group-hover:-translate-x-1 transition-transform"}),e.jsxs("div",{className:"flex-1 text-left",children:[e.jsx("div",{className:"text-xs text-neutral-500 mb-1",children:s("lessons.previousLesson",{defaultValue:"Предыдущий урок"})}),e.jsx("div",{className:"font-semibold truncate",children:f.title})]})]}):e.jsx("div",{className:"flex-1"}),R?e.jsxs("button",{onClick:()=>o(`/courses/${i}/lessons/${R.id}`),className:"btn-secondary group flex items-center gap-3 flex-1",children:[e.jsxs("div",{className:"flex-1 text-right",children:[e.jsx("div",{className:"text-xs text-neutral-500 mb-1",children:s("lessons.nextLesson",{defaultValue:"Следующий урок"})}),e.jsx("div",{className:"font-semibold truncate",children:R.title})]}),e.jsx(ye,{className:"h-5 w-5 group-hover:translate-x-1 transition-transform"})]}):e.jsx("div",{className:"flex-1"})]}),e.jsx(we,{isOpen:A.isOpen,onClose:()=>u({isOpen:!1,fileId:null}),onConfirm:()=>{A.fileId&&y.mutate(A.fileId)},title:"Удалить файл",message:"Вы уверены, что хотите удалить этот файл? Это действие нельзя отменить.",confirmText:"Удалить",cancelText:"Отмена",variant:"danger"})]})}export{qe as default};
