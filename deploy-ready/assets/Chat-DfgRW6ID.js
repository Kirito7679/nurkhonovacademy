import{d as K,u as Q,r as s,e as C,f as R,j as e,ap as q,an as y,M as W,ar as V,a_ as E,X,a$ as G,S as J}from"./vendor-D-riqg-X.js";import{u as Y,a as x,A as Z}from"./index-uPHzQqHW.js";import{E as ee}from"./ErrorModal-CzR1kAop.js";function re(){const D=K(),{user:L}=Y(),I=Q(),[m,v]=s.useState(""),[r,p]=s.useState(null),[g,N]=s.useState(!1),[h,c]=s.useState(null),i=s.useRef(null),u=s.useRef(null),S=s.useRef(null),[F,j]=s.useState({isOpen:!1,message:""}),{data:O}=C(["studentTeacher"],async()=>(await x.get("/messages/student/teacher")).data.data),l=O,{data:w,isLoading:k}=C(["chat",l?.id],async()=>l?.id?(await x.get(`/messages/chat/${l.id}`)).data.data:null,{enabled:!!l?.id,refetchInterval:1e4,refetchOnWindowFocus:!1}),z=R(async t=>{const a=new FormData;return a.append("file",t),(await x.post("/messages/upload-file",a,{headers:{"Content-Type":"multipart/form-data"},onUploadProgress:b=>{if(b.total){const H=Math.round(b.loaded*100/b.total);c({fileName:t.name,progress:H})}}})).data.data}),f=R(async t=>{if(!l?.id)throw new Error("Ğ£Ñ‡Ğ¸Ñ‚ĞµĞ»ÑŒ Ğ½Ğµ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½");return(await x.post("/messages/send",{receiverId:l.id,...t})).data.data},{onSuccess:()=>{I.invalidateQueries(["chat",l?.id]),v(""),p(null),c(null),i.current&&(i.current.value=""),u.current&&(u.current.style.height="auto")}}),d=s.useCallback(()=>{const t=u.current;if(t){t.style.height="auto";const a=Math.min(t.scrollHeight,120);t.style.height=`${a}px`}},[]),A=t=>{v(t.target.value),setTimeout(()=>d(),0)};s.useEffect(()=>{u.current&&d()},[l?.id,d]),s.useEffect(()=>{d()},[m,d]);const B=()=>{S.current?.scrollIntoView({behavior:"smooth"})};s.useEffect(()=>{B()},[w?.messages]);const P=async t=>{const a=t.target.files?.[0];if(a){if(a.size>50*1024*1024){j({isOpen:!0,message:"Ğ Ğ°Ğ·Ğ¼ĞµÑ€ Ñ„Ğ°Ğ¹Ğ»Ğ° Ğ½Ğµ Ğ´Ğ¾Ğ»Ğ¶ĞµĞ½ Ğ¿Ñ€ĞµĞ²Ñ‹ÑˆĞ°Ñ‚ÑŒ 50MB"});return}N(!0),c({fileName:a.name,progress:0});try{const n=await z.mutateAsync(a);p({file:a,url:n.fileUrl}),c(null)}catch(n){j({isOpen:!0,message:n.response?.data?.message||"ĞÑˆĞ¸Ğ±ĞºĞ° Ğ¿Ñ€Ğ¸ Ğ·Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞµ Ñ„Ğ°Ğ¹Ğ»Ğ°"}),c(null)}finally{N(!1)}}},T=()=>{p(null),i.current&&(i.current.value="")},M=async t=>{if(t.preventDefault(),!m.trim()&&!r||f.isLoading)return;const a={content:m.trim()||(r?"ğŸ“ Ğ¤Ğ°Ğ¹Ğ»":"")};r&&(a.fileUrl=r.url,a.fileName=r.file.name,a.fileSize=r.file.size),f.mutate(a)},U=t=>t<1024?t+" B":t<1024*1024?(t/1024).toFixed(1)+" KB":(t/(1024*1024)).toFixed(1)+" MB",_=t=>(t.split(".").pop()?.toLowerCase(),e.jsx(E,{className:"h-4 w-4"}));if(!l)return e.jsxs("div",{className:"text-center py-12 animate-fade-scale",children:[e.jsx("p",{className:"text-neutral-600 mb-4",children:"Ğ£ Ğ²Ğ°Ñ Ğ¿Ğ¾ĞºĞ° Ğ½ĞµÑ‚ Ğ¿Ñ€ĞµĞ¿Ğ¾Ğ´Ğ°Ğ²Ğ°Ñ‚ĞµĞ»Ñ"}),e.jsx("p",{className:"text-sm text-neutral-500",children:"ĞŸĞ¾ÑĞ»Ğµ Ğ¾Ğ´Ğ¾Ğ±Ñ€ĞµĞ½Ğ¸Ñ Ğ´Ğ¾ÑÑ‚ÑƒĞ¿Ğ° Ğº ĞºÑƒÑ€ÑÑƒ Ğ²Ñ‹ ÑĞ¼Ğ¾Ğ¶ĞµÑ‚Ğµ Ğ¾Ğ±Ñ‰Ğ°Ñ‚ÑŒÑÑ Ñ Ğ¿Ñ€ĞµĞ¿Ğ¾Ğ´Ğ°Ğ²Ğ°Ñ‚ĞµĞ»ĞµĞ¼"})]});const $=w?.messages||[],o=w?.user||l;return e.jsxs("div",{className:"flex flex-col h-[calc(100vh-8rem)] animate-fade-scale",children:[e.jsxs("div",{className:"card p-4 mb-4 flex items-center gap-3 border-b-2 border-primary-200 bg-gradient-to-r from-white to-blue-50/30 shadow-sm",children:[e.jsx("button",{onClick:()=>D("/dashboard"),className:"p-2.5 text-neutral-600 hover:text-primary-600 hover:bg-primary-50 rounded-xl transition-all duration-200 active:scale-95",children:e.jsx(q,{className:"h-5 w-5"})}),e.jsxs("div",{className:"flex items-center gap-3 flex-1",children:[o.avatarUrl?e.jsx("img",{src:o.avatarUrl,alt:`${o.firstName} ${o.lastName}`,className:"w-12 h-12 rounded-full object-cover ring-2 ring-primary-200 shadow-sm"}):e.jsx("div",{className:"w-12 h-12 rounded-full bg-gradient-to-br from-blue-500 to-purple-600 text-white flex items-center justify-center font-bold text-lg shadow-md ring-2 ring-primary-200",children:o.firstName[0]}),e.jsxs("div",{children:[e.jsxs("h2",{className:"font-semibold text-neutral-900 text-lg",children:[o.firstName," ",o.lastName]}),e.jsx("p",{className:"text-xs text-neutral-600 font-medium",children:"ĞŸÑ€ĞµĞ¿Ğ¾Ğ´Ğ°Ğ²Ğ°Ñ‚ĞµĞ»ÑŒ"})]})]})]}),e.jsxs("div",{className:"flex-1 overflow-y-auto space-y-3 mb-4 px-4 bg-gradient-to-b from-neutral-50/50 to-white",children:[k?e.jsx("div",{className:"flex justify-center py-8",children:e.jsx(y,{className:"h-6 w-6 animate-spin text-primary-500"})}):$.length===0?e.jsxs("div",{className:"text-center py-12 text-neutral-500",children:[e.jsx(W,{className:"h-16 w-16 mx-auto mb-4 text-neutral-300 animate-pulse"}),e.jsx("p",{className:"text-lg font-medium",children:"ĞĞ°Ñ‡Ğ½Ğ¸Ñ‚Ğµ Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğµ Ñ Ğ¿Ñ€ĞµĞ¿Ğ¾Ğ´Ğ°Ğ²Ğ°Ñ‚ĞµĞ»ĞµĞ¼"}),e.jsx("p",{className:"text-sm mt-2",children:"ĞÑ‚Ğ¿Ñ€Ğ°Ğ²ÑŒÑ‚Ğµ Ğ¿ĞµÑ€Ğ²Ğ¾Ğµ ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğµ"})]}):$.map((t,a)=>{const n=t.senderId===L?.id;return e.jsx("div",{className:`flex ${n?"justify-end":"justify-start"} animate-slide-in`,style:{animationDelay:`${a*.05}s`},children:e.jsxs("div",{className:`max-w-[75%] md:max-w-[65%] chat-message-bubble ${n?"chat-message-bubble-own":"chat-message-bubble-other"}`,children:[t.fileUrl&&e.jsxs("a",{href:t.fileUrl.startsWith("http")?t.fileUrl:`${Z.replace("/api","")}${t.fileUrl}`,download:t.fileName,target:"_blank",rel:"noopener noreferrer",className:`flex items-center gap-2 mb-2 p-2.5 rounded-xl transition-all duration-200 hover:scale-[1.02] ${n?"bg-white/20 hover:bg-white/30":"bg-primary-50 hover:bg-primary-100"}`,children:[_(t.fileName||""),e.jsx("span",{className:"text-sm font-medium flex-1 truncate",children:t.fileName}),t.fileSize&&e.jsx("span",{className:`text-xs ${n?"text-white/80":"text-neutral-600"}`,children:U(t.fileSize)}),e.jsx(V,{className:`h-4 w-4 ${n?"text-white":"text-primary-600"}`})]}),t.content&&e.jsx("p",{className:"text-[0.9375rem] leading-relaxed whitespace-pre-wrap break-words",children:t.content}),e.jsx("p",{className:`text-xs mt-2 ${n?"text-white/80":"text-neutral-500"}`,children:new Date(t.createdAt).toLocaleTimeString("ru-RU",{hour:"2-digit",minute:"2-digit"})})]})},t.id)}),e.jsx("div",{ref:S})]}),e.jsxs("form",{onSubmit:M,className:"chat-input-container",children:[h&&!r&&e.jsx(FileUploadProgress,{fileName:h.fileName,progress:h.progress,onCancel:()=>{N(!1),c(null),i.current&&(i.current.value="")}}),r&&!h&&e.jsxs("div",{className:"mb-3 flex items-center gap-3 p-3 bg-gradient-to-r from-primary-50 to-primary-50 rounded-xl border-2 border-primary-200 animate-slide-in",children:[e.jsx(E,{className:"h-5 w-5 text-primary-600 flex-shrink-0"}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsx("p",{className:"text-sm font-semibold text-neutral-900 truncate",children:r.file.name}),e.jsx("p",{className:"text-xs text-neutral-600 mt-0.5",children:U(r.file.size)})]}),e.jsx("button",{type:"button",onClick:T,className:"p-1.5 text-neutral-500 hover:text-red-600 hover:bg-red-50 rounded-lg transition-all duration-200 active:scale-95",children:e.jsx(X,{className:"h-5 w-5"})})]}),e.jsxs("div",{className:"flex items-end gap-2 md:gap-3",children:[e.jsx("input",{ref:i,type:"file",onChange:P,className:"hidden",id:"file-input",disabled:g}),e.jsx("label",{htmlFor:"file-input",className:"chat-attach-btn",children:g?e.jsx(y,{className:"h-5 w-5 md:h-6 md:w-6 animate-spin"}):e.jsx(G,{className:"h-5 w-5 md:h-6 md:w-6"})}),e.jsx("textarea",{ref:u,value:m,onChange:A,placeholder:"",className:"chat-textarea flex-1",rows:1,onKeyDown:t=>{t.key==="Enter"&&!t.shiftKey&&(t.preventDefault(),M(t))},onInput:d}),e.jsx("button",{type:"submit",disabled:!m.trim()&&!r||f.isLoading||g,className:"chat-send-btn",children:f.isLoading?e.jsx(y,{className:"h-5 w-5 md:h-6 md:w-6 animate-spin"}):e.jsx(J,{className:"h-5 w-5 md:h-6 md:w-6"})})]})]}),e.jsx(ee,{isOpen:F.isOpen,onClose:()=>j({isOpen:!1,message:""}),message:F.message})]})}export{re as default};
