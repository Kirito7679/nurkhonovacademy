import{u as ne,f as ie,r as a,h as V,k as B,j as t,a6 as oe,al as v,M as b,t as Q,U as W,an as de,ap as ce,aE as H,X as me,aF as ue,S as xe}from"./vendor-react-BfsyfZ9v.js";import{u as he,A as fe,a as C}from"./index-Da4DAFDw.js";import{u as pe}from"./useDebounce-Db7LaNuF.js";import{E as ge}from"./ErrorModal-C6ndy1k5.js";import"./vendor-other-Dj6_ObJ-.js";import"./vendor-network-Dklq3Edc.js";import"./vendor-i18n-DHwuzpMN.js";function Se(){const{user:S}=he(),h=ne(),P=ie(),[r,f]=a.useState(null),[K,c]=a.useState(null),[d,p]=a.useState(null),[g,O]=a.useState(""),[E,_]=a.useState(""),[n,R]=a.useState(null),[U,M]=a.useState(!1),[F,I]=a.useState(!1),j=a.useRef(null),N=a.useRef(null),w=pe(E,300),k=a.useRef(null),[G,T]=a.useState({isOpen:!1,message:""}),{data:q,isLoading:X}=V(["teacherChats",w],async()=>{const e=w?`?search=${encodeURIComponent(w)}`:"";return(await C.get(`/messages/teacher/chats${e}`)).data.data||[]}),i=q||[],{data:m,isLoading:J}=V(["chat",r],async()=>r?(await C.get(`/messages/chat/${r}`)).data.data:null,{enabled:!!r,refetchInterval:1e4,refetchOnWindowFocus:!1}),Y=B(async e=>{const s=new FormData;return s.append("file",e),(await C.post("/messages/upload-file",s,{headers:{"Content-Type":"multipart/form-data"}})).data.data}),y=B(async e=>{if(!r)throw new Error("Ð¡Ñ‚ÑƒÐ´ÐµÐ½Ñ‚ Ð½Ðµ Ð²Ñ‹Ð±Ñ€Ð°Ð½");return(await C.post("/messages/send",{receiverId:r,...e})).data.data},{onSuccess:()=>{P.invalidateQueries(["chat",r]),P.invalidateQueries(["teacherChats"]),O(""),R(null),j.current&&(j.current.value=""),N.current&&(N.current.style.height="auto")}}),Z=()=>{var e;(e=k.current)==null||e.scrollIntoView({behavior:"smooth"})};a.useEffect(()=>{Z()},[m==null?void 0:m.messages]);const ee=async e=>{var l,x,z;const s=(l=e.target.files)==null?void 0:l[0];if(s){if(s.size>50*1024*1024){T({isOpen:!0,message:"Ð Ð°Ð·Ð¼ÐµÑ€ Ñ„Ð°Ð¹Ð»Ð° Ð½Ðµ Ð´Ð¾Ð»Ð¶ÐµÐ½ Ð¿Ñ€ÐµÐ²Ñ‹ÑˆÐ°Ñ‚ÑŒ 50MB"});return}M(!0);try{const $=await Y.mutateAsync(s);R({file:s,url:$.fileUrl})}catch($){T({isOpen:!0,message:((z=(x=$.response)==null?void 0:x.data)==null?void 0:z.message)||"ÐžÑˆÐ¸Ð±ÐºÐ° Ð¿Ñ€Ð¸ Ð·Ð°Ð³Ñ€ÑƒÐ·ÐºÐµ Ñ„Ð°Ð¹Ð»Ð°"})}finally{M(!1)}}},te=()=>{R(null),j.current&&(j.current.value="")},u=a.useCallback(()=>{const e=N.current;if(e){e.style.height="auto";const s=Math.min(e.scrollHeight,120);e.style.height=`${s}px`}},[]),se=e=>{O(e.target.value),setTimeout(()=>u(),0)};a.useEffect(()=>{N.current&&u()},[r,u]),a.useEffect(()=>{u()},[g,u]);const L=async e=>{if(e.preventDefault(),!g.trim()&&!n||y.isLoading||!r)return;const s={content:g.trim()||(n?"ðŸ“Ž Ð¤Ð°Ð¹Ð»":"")};n&&(s.fileUrl=n.url,s.fileName=n.file.name,s.fileSize=n.file.size),y.mutate(s)},A=e=>e<1024?e+" B":e<1024*1024?(e/1024).toFixed(1)+" KB":(e/(1024*1024)).toFixed(1)+" MB",ae=e=>{var s;return(s=e.split(".").pop())==null||s.toLowerCase(),t.jsx(H,{className:"h-4 w-4"})};a.useEffect(()=>{if(i.length>0&&!r&&!d){const e=i[0];e.chatType==="GROUP"&&e.classId?(c("GROUP"),p(e.classId)):(c("PRIVATE"),f(e.id))}if((r||d)&&i.length>0&&!i.find(s=>s.chatType==="PRIVATE"&&s.id===r||s.chatType==="GROUP"&&s.classId===d)){const s=i[0];s.chatType==="GROUP"&&s.classId?(c("GROUP"),p(s.classId),f(null)):(c("PRIVATE"),f(s.id),p(null))}},[i,r,d]);const re=e=>{e.chatType==="GROUP"&&e.classId?(c("GROUP"),p(e.classId),f(null),h(`/classes/${e.classId}/chat`)):(c("PRIVATE"),f(e.id),p(null),window.innerWidth<768&&I(!0))},le=()=>{I(!1)};a.useEffect(()=>{const e=()=>{window.innerWidth>=768&&I(!1)};return window.addEventListener("resize",e),()=>window.removeEventListener("resize",e)},[]);const o=i.find(e=>e.chatType==="PRIVATE"&&e.id===r||e.chatType==="GROUP"&&e.classId===d),D=(m==null?void 0:m.messages)||[];return t.jsxs("div",{className:"flex flex-col md:flex-row h-[calc(100vh-8rem)] gap-4 animate-fade-scale",children:[t.jsxs("div",{className:`w-full md:w-80 card p-0 overflow-hidden flex flex-col ${F?"hidden md:flex":"flex"}`,children:[t.jsxs("div",{className:"p-4 border-b border-neutral-200",children:[t.jsx("h2",{className:"text-lg font-semibold text-neutral-900 mb-3",children:"Ð§Ð°Ñ‚Ñ‹"}),t.jsxs("div",{className:"relative",children:[t.jsx(oe,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 h-4 w-4 text-neutral-400 pointer-events-none z-10"}),t.jsx("input",{type:"text",value:E,onChange:e=>_(e.target.value),placeholder:"ÐŸÐ¾Ð¸ÑÐº ÑÑ‚ÑƒÐ´ÐµÐ½Ñ‚Ð¾Ð²...",className:"input-field pl-10 w-full"})]})]}),t.jsx("div",{className:"flex-1 overflow-y-auto",children:X?t.jsx("div",{className:"flex justify-center py-8",children:t.jsx(v,{className:"h-6 w-6 animate-spin text-primary-500"})}):i.length===0?t.jsxs("div",{className:"text-center py-8 text-neutral-500",children:[t.jsx(b,{className:"h-12 w-12 mx-auto mb-4 text-neutral-400"}),t.jsx("p",{children:w?"Ð§Ð°Ñ‚Ñ‹ Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½Ñ‹":"ÐÐµÑ‚ Ñ‡Ð°Ñ‚Ð¾Ð²"})]}):t.jsx("div",{className:"divide-y divide-neutral-100",children:i.map((e,s)=>{const l=e.chatType==="PRIVATE"&&r===e.id||e.chatType==="GROUP"&&d===e.classId;return t.jsx("div",{className:`w-full p-4 hover:bg-gradient-to-r hover:from-primary-50 hover:to-blue-50/50 transition-all duration-200 cursor-pointer group ${l?"bg-gradient-to-r from-primary-100 to-blue-100/50 border-l-4 border-primary-500 shadow-sm":""} animate-slide-in`,style:{animationDelay:`${s*.03}s`},children:t.jsxs("div",{className:"flex items-center gap-3",children:[t.jsxs("button",{onClick:()=>re(e),className:"flex items-center gap-3 flex-1 text-left",children:[e.chatType==="GROUP"?t.jsx("div",{className:"w-12 h-12 rounded-full bg-gradient-to-br from-green-500 to-emerald-600 text-white flex items-center justify-center font-bold text-lg shadow-md ring-2 ring-primary-200 group-hover:ring-primary-400 transition-all",children:t.jsx(Q,{className:"h-6 w-6"})}):e.avatarUrl?t.jsx("img",{src:e.avatarUrl,alt:`${e.firstName} ${e.lastName}`,className:"w-12 h-12 rounded-full object-cover ring-2 ring-primary-200 shadow-sm group-hover:ring-primary-400 transition-all"}):t.jsx("div",{className:"w-12 h-12 rounded-full bg-gradient-to-br from-blue-500 to-purple-600 text-white flex items-center justify-center font-bold text-lg shadow-md ring-2 ring-primary-200 group-hover:ring-primary-400 transition-all",children:e.firstName[0]}),t.jsxs("div",{className:"flex-1 min-w-0",children:[t.jsxs("div",{className:"flex items-center justify-between mb-1",children:[t.jsx("h3",{className:"font-semibold text-neutral-900 truncate group-hover:text-primary-700 transition-colors",children:e.chatType==="GROUP"?e.className:`${e.firstName} ${e.lastName}`}),e.unreadCount&&e.unreadCount>0&&t.jsx("span",{className:"bg-gradient-to-br from-primary-500 to-blue-600 text-white text-xs font-bold rounded-full w-6 h-6 flex items-center justify-center flex-shrink-0 shadow-md animate-pulse",children:e.unreadCount})]}),e.chatType==="GROUP"&&e.studentCount!==void 0&&t.jsxs("p",{className:"text-xs text-primary-600 mb-1 font-medium",children:[e.studentCount," ",e.studentCount===1?"ÑÑ‚ÑƒÐ´ÐµÐ½Ñ‚":"ÑÑ‚ÑƒÐ´ÐµÐ½Ñ‚Ð¾Ð²"]}),e.lastMessage?t.jsxs(t.Fragment,{children:[t.jsxs("p",{className:"text-sm text-neutral-600 truncate group-hover:text-neutral-800 transition-colors",children:[e.chatType==="GROUP"&&e.lastMessage.senderName?t.jsxs("span",{className:"font-medium",children:[e.lastMessage.senderName,": "]}):null,e.lastMessage.content]}),t.jsx("p",{className:"text-xs text-neutral-500 mt-1 font-medium",children:new Date(e.lastMessage.createdAt).toLocaleDateString("ru-RU",{day:"numeric",month:"short",hour:"2-digit",minute:"2-digit"})})]}):t.jsx("p",{className:"text-sm text-neutral-500 group-hover:text-neutral-700 transition-colors",children:e.chatType==="GROUP"?"Ð“Ñ€ÑƒÐ¿Ð¿Ð¾Ð²Ð¾Ð¹ Ñ‡Ð°Ñ‚":`Ð¢ÐµÐ»ÐµÑ„Ð¾Ð½: ${e.phone}`})]})]}),e.chatType==="PRIVATE"&&t.jsx("button",{onClick:x=>{x.stopPropagation(),h(`/teacher/students/${e.id}`)},className:"p-2.5 text-neutral-600 hover:text-primary-600 hover:bg-primary-100 rounded-xl transition-all duration-200 flex-shrink-0 active:scale-95",title:"ÐžÑ‚ÐºÑ€Ñ‹Ñ‚ÑŒ Ð¿Ñ€Ð¾Ñ„Ð¸Ð»ÑŒ ÑÑ‚ÑƒÐ´ÐµÐ½Ñ‚Ð°",children:t.jsx(W,{className:"h-5 w-5"})}),e.chatType==="GROUP"&&e.classId&&t.jsx("button",{onClick:x=>{x.stopPropagation(),h(`/classes/${e.classId}`)},className:"p-2.5 text-neutral-600 hover:text-primary-600 hover:bg-primary-100 rounded-xl transition-all duration-200 flex-shrink-0 active:scale-95",title:"ÐžÑ‚ÐºÑ€Ñ‹Ñ‚ÑŒ ÐºÐ»Ð°ÑÑ",children:t.jsx(Q,{className:"h-5 w-5"})})]})},e.chatType==="GROUP"?`group-${e.classId}`:e.id)})})})]}),t.jsx("div",{className:`flex-1 flex flex-col card p-0 overflow-hidden ${F?"flex":"hidden md:flex"}`,children:K==="GROUP"&&d?t.jsx("div",{className:"flex-1 flex items-center justify-center text-neutral-500",children:t.jsxs("div",{className:"text-center",children:[t.jsx(b,{className:"h-16 w-16 mx-auto mb-4 text-neutral-400"}),t.jsx("p",{className:"mb-4",children:"Ð“Ñ€ÑƒÐ¿Ð¿Ð¾Ð²Ð¾Ð¹ Ñ‡Ð°Ñ‚ ÐºÐ»Ð°ÑÑÐ°"}),t.jsx("button",{onClick:()=>h(`/classes/${d}/chat`),className:"btn-primary",children:"ÐžÑ‚ÐºÑ€Ñ‹Ñ‚ÑŒ Ð³Ñ€ÑƒÐ¿Ð¿Ð¾Ð²Ð¾Ð¹ Ñ‡Ð°Ñ‚"})]})}):r&&o?t.jsxs(t.Fragment,{children:[t.jsxs("div",{className:"p-4 border-b-2 border-primary-100 bg-gradient-to-r from-white to-blue-50/30 flex items-center justify-between shadow-sm",children:[t.jsxs("div",{className:"flex items-center gap-3 flex-1",children:[t.jsx("button",{onClick:le,className:"md:hidden p-2.5 text-neutral-600 hover:text-primary-600 hover:bg-primary-50 rounded-xl transition-all duration-200 active:scale-95",title:"Ð’ÐµÑ€Ð½ÑƒÑ‚ÑŒÑÑ Ðº ÑÐ¿Ð¸ÑÐºÑƒ",children:t.jsx(de,{className:"h-5 w-5"})}),o.avatarUrl?t.jsx("img",{src:o.avatarUrl,alt:`${o.firstName} ${o.lastName}`,className:"w-12 h-12 rounded-full object-cover ring-2 ring-primary-200 shadow-sm"}):t.jsx("div",{className:"w-12 h-12 rounded-full bg-gradient-to-br from-blue-500 to-purple-600 text-white flex items-center justify-center font-bold text-lg shadow-md ring-2 ring-primary-200",children:o.firstName[0]}),t.jsxs("div",{children:[t.jsxs("h2",{className:"font-semibold text-neutral-900 text-lg",children:[o.firstName," ",o.lastName]}),t.jsx("p",{className:"text-xs text-neutral-600 font-medium",children:"Ð¡Ñ‚ÑƒÐ´ÐµÐ½Ñ‚"})]})]}),t.jsx("button",{onClick:()=>h(`/teacher/students/${o.id}`),className:"p-2.5 text-neutral-600 hover:text-primary-600 hover:bg-primary-50 rounded-xl transition-all duration-200 active:scale-95",title:"ÐžÑ‚ÐºÑ€Ñ‹Ñ‚ÑŒ Ð¿Ñ€Ð¾Ñ„Ð¸Ð»ÑŒ ÑÑ‚ÑƒÐ´ÐµÐ½Ñ‚Ð°",children:t.jsx(W,{className:"h-5 w-5"})})]}),t.jsxs("div",{className:"flex-1 overflow-y-auto space-y-3 p-4 bg-gradient-to-b from-neutral-50/50 to-white",children:[J?t.jsx("div",{className:"flex justify-center py-8",children:t.jsx(v,{className:"h-6 w-6 animate-spin text-primary-500"})}):D.length===0?t.jsxs("div",{className:"text-center py-12 text-neutral-500",children:[t.jsx(b,{className:"h-16 w-16 mx-auto mb-4 text-neutral-300 animate-pulse"}),t.jsx("p",{className:"text-lg font-medium",children:"ÐÐ°Ñ‡Ð½Ð¸Ñ‚Ðµ Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ðµ ÑÐ¾ ÑÑ‚ÑƒÐ´ÐµÐ½Ñ‚Ð¾Ð¼"}),t.jsx("p",{className:"text-sm mt-2",children:"ÐžÑ‚Ð¿Ñ€Ð°Ð²ÑŒÑ‚Ðµ Ð¿ÐµÑ€Ð²Ð¾Ðµ ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ðµ"})]}):D.map((e,s)=>{const l=e.senderId===(S==null?void 0:S.id);return t.jsx("div",{className:`flex ${l?"justify-end":"justify-start"} animate-slide-in`,style:{animationDelay:`${s*.05}s`},children:t.jsxs("div",{className:`max-w-[75%] md:max-w-[65%] chat-message-bubble ${l?"chat-message-bubble-own":"chat-message-bubble-other"}`,children:[e.fileUrl&&t.jsxs("a",{href:e.fileUrl.startsWith("http")?e.fileUrl:`${fe.replace("/api","")}${e.fileUrl}`,download:e.fileName,target:"_blank",rel:"noopener noreferrer",className:`flex items-center gap-2 mb-2 p-2.5 rounded-xl transition-all duration-200 hover:scale-[1.02] ${l?"bg-white/20 hover:bg-white/30":"bg-primary-50 hover:bg-primary-100"}`,children:[ae(e.fileName||""),t.jsx("span",{className:"text-sm font-medium flex-1 truncate",children:e.fileName}),e.fileSize&&t.jsx("span",{className:`text-xs ${l?"text-white/80":"text-neutral-600"}`,children:A(e.fileSize)}),t.jsx(ce,{className:`h-4 w-4 ${l?"text-white":"text-primary-600"}`})]}),e.content&&t.jsx("p",{className:"text-[0.9375rem] leading-relaxed whitespace-pre-wrap break-words",children:e.content}),t.jsx("p",{className:`text-xs mt-2 ${l?"text-white/80":"text-neutral-500"}`,children:new Date(e.createdAt).toLocaleTimeString("ru-RU",{hour:"2-digit",minute:"2-digit"})})]})},e.id)}),t.jsx("div",{ref:k})]}),t.jsxs("form",{onSubmit:L,className:"chat-input-container",children:[n&&t.jsxs("div",{className:"mb-3 flex items-center gap-3 p-3 bg-gradient-to-r from-primary-50 to-blue-50 rounded-xl border-2 border-primary-200 animate-slide-in",children:[t.jsx(H,{className:"h-5 w-5 text-primary-600 flex-shrink-0"}),t.jsxs("div",{className:"flex-1 min-w-0",children:[t.jsx("p",{className:"text-sm font-semibold text-neutral-900 truncate",children:n.file.name}),t.jsx("p",{className:"text-xs text-neutral-600 mt-0.5",children:A(n.file.size)})]}),t.jsx("button",{type:"button",onClick:te,className:"p-1.5 text-neutral-500 hover:text-red-600 hover:bg-red-50 rounded-lg transition-all duration-200 active:scale-95",children:t.jsx(me,{className:"h-5 w-5"})})]}),t.jsxs("div",{className:"flex items-end gap-2 md:gap-3",children:[t.jsx("input",{ref:j,type:"file",onChange:ee,className:"hidden",id:"file-input-teacher",disabled:U}),t.jsx("label",{htmlFor:"file-input-teacher",className:"chat-attach-btn",children:U?t.jsx(v,{className:"h-5 w-5 md:h-6 md:w-6 animate-spin"}):t.jsx(ue,{className:"h-5 w-5 md:h-6 md:w-6"})}),t.jsx("textarea",{ref:N,value:g,onChange:se,placeholder:"",className:"chat-textarea flex-1",rows:1,onKeyDown:e=>{e.key==="Enter"&&!e.shiftKey&&(e.preventDefault(),L(e))},onInput:u}),t.jsx("button",{type:"submit",disabled:!g.trim()&&!n||y.isLoading||U,className:"chat-send-btn",children:y.isLoading?t.jsx(v,{className:"h-5 w-5 md:h-6 md:w-6 animate-spin"}):t.jsx(xe,{className:"h-5 w-5 md:h-6 md:w-6"})})]})]})]}):t.jsx("div",{className:"flex-1 flex items-center justify-center text-neutral-500",children:t.jsxs("div",{className:"text-center",children:[t.jsx(b,{className:"h-16 w-16 mx-auto mb-4 text-neutral-400"}),t.jsx("p",{children:"Ð’Ñ‹Ð±ÐµÑ€Ð¸Ñ‚Ðµ ÑÑ‚ÑƒÐ´ÐµÐ½Ñ‚Ð° Ð´Ð»Ñ Ð½Ð°Ñ‡Ð°Ð»Ð° Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ñ"})]})})}),t.jsx(ge,{isOpen:G.isOpen,onClose:()=>T({isOpen:!1,message:""}),message:G.message})]})}export{Se as default};
