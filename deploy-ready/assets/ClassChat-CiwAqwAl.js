import{af as I,d as L,u as Q,r as i,e as T,f as k,j as e,aq as g,as as K,M as P,b1 as $,X as q,b2 as B,S as H}from"./vendor-BwEBtozQ.js";import{u as V,c as X,a as h}from"./index-_CiEywzY.js";import{E as _}from"./ErrorModal-D-tfKWNy.js";function Y(){const{id:t}=I(),y=L(),{user:m}=V(),x=Q(),[f,b]=i.useState(""),[n,p]=i.useState(null),[v,w]=i.useState(!1),C=i.useRef(null),R=i.useRef(null),M=i.useRef(null),[S,u]=i.useState({isOpen:!1,message:""}),{socket:c,isConnected:N}=X(),{data:o,isLoading:F}=T(["classChat",t],async()=>t?(await h.get(`/classes/${t}/messages`)).data.data:null,{enabled:!!t});i.useEffect(()=>{if(c&&N&&t){c.emit("join-class-chat",t);const s=l=>{x.setQueryData(["classChat",t],r=>r&&{...r,messages:[...r.messages,l]})},a=({messageId:l})=>{x.setQueryData(["classChat",t],r=>r&&{...r,messages:r.messages.filter(d=>d.id!==l)})};return c.on("new-class-message",s),c.on("class-message-deleted",a),()=>{c.emit("leave-class-chat",t),c.off("new-class-message",s),c.off("class-message-deleted",a)}}},[c,N,t,x]),i.useEffect(()=>{M.current?.scrollIntoView({behavior:"smooth"})},[o?.messages]);const j=k(async s=>(await h.post(`/classes/${t}/messages`,s)).data.data,{onSuccess:()=>{b(""),p(null),x.invalidateQueries(["classChat",t])},onError:s=>{u({isOpen:!0,message:s.response?.data?.message||"Ошибка при отправке сообщения"})}}),O=k(async s=>{await h.delete(`/classes/messages/${s}`)},{onSuccess:()=>{x.invalidateQueries(["classChat",t])},onError:s=>{u({isOpen:!0,message:s.response?.data?.message||"Ошибка при удалении сообщения"})}}),D=async s=>{const a=s.target.files?.[0];if(a){if(a.size>10*1024*1024){u({isOpen:!0,message:"Размер файла не должен превышать 10MB"});return}w(!0);try{const l=new FormData;l.append("file",a);const r=await h.post("/messages/upload-file",l,{headers:{"Content-Type":"multipart/form-data"}});r.data.data&&p({file:a,url:r.data.data.fileUrl})}catch(l){u({isOpen:!0,message:l.response?.data?.message||"Ошибка при загрузке файла"})}finally{w(!1)}}},E=()=>{if(!f.trim()&&!n)return;const s={content:f.trim()||"Файл"};n&&(s.fileUrl=n.url,s.fileName=n.file.name,s.fileSize=n.file.size),j.mutate(s)},U=s=>{s.key==="Enter"&&!s.shiftKey&&(s.preventDefault(),E())},z=s=>s.senderId===m?.id||m?.role==="ADMIN"||m?.role==="TEACHER"&&o?.class.teacher.id===m?.id,A=s=>{const a=new Date(s),r=new Date().getTime()-a.getTime(),d=Math.floor(r/6e4);return d<1?"только что":d<60?`${d} мин назад`:d<1440?`${Math.floor(d/60)} ч назад`:a.toLocaleDateString("ru-RU",{day:"numeric",month:"short",hour:"2-digit",minute:"2-digit"})};return F?e.jsx("div",{className:"flex items-center justify-center h-screen",children:e.jsxs("div",{className:"text-center",children:[e.jsx(g,{className:"h-8 w-8 animate-spin text-primary-600 mx-auto mb-4"}),e.jsx("p",{className:"text-neutral-600",children:"Загрузка чата..."})]})}):o?e.jsxs("div",{className:"flex flex-col h-[calc(100vh-8rem)]",children:[e.jsxs("div",{className:"flex items-center gap-4 mb-4 pb-4 border-b border-neutral-200",children:[e.jsx("button",{onClick:()=>y(`/classes/${t}`),className:"p-2 text-neutral-600 hover:text-primary-600 hover:bg-primary-50 rounded transition-colors",children:e.jsx(K,{className:"h-5 w-5"})}),e.jsxs("div",{className:"flex-1",children:[e.jsx("h1",{className:"text-xl font-semibold text-neutral-900",children:o.class.name}),e.jsxs("p",{className:"text-sm text-neutral-600",children:["Групповой чат • ",o.messages.length," сообщений"]})]}),!N&&e.jsx("span",{className:"text-xs text-yellow-600 bg-yellow-50 px-2 py-1 rounded",children:"Подключение..."})]}),e.jsxs("div",{className:"flex-1 overflow-y-auto space-y-4 mb-4 pr-2",children:[o.messages.length===0?e.jsxs("div",{className:"text-center py-12",children:[e.jsx(P,{className:"h-16 w-16 text-neutral-300 mx-auto mb-4"}),e.jsx("p",{className:"text-neutral-600",children:"Нет сообщений. Начните общение!"})]}):o.messages.map(s=>{const a=s.senderId===m?.id;return e.jsxs("div",{className:`flex gap-3 ${a?"flex-row-reverse":""}`,children:[e.jsx("div",{className:"flex-shrink-0",children:e.jsx("div",{className:"w-10 h-10 rounded-full bg-primary-100 flex items-center justify-center",children:s.sender.avatarUrl?e.jsx("img",{src:s.sender.avatarUrl,alt:`${s.sender.firstName} ${s.sender.lastName}`,className:"w-10 h-10 rounded-full object-cover"}):e.jsxs("span",{className:"text-primary-600 font-semibold text-sm",children:[s.sender.firstName[0],s.sender.lastName[0]]})})}),e.jsxs("div",{className:`flex-1 ${a?"items-end":""} flex flex-col`,children:[e.jsxs("div",{className:"flex items-center gap-2 mb-1",children:[e.jsxs("span",{className:"text-sm font-semibold text-neutral-900",children:[s.sender.firstName," ",s.sender.lastName]}),s.sender.role==="TEACHER"||s.sender.role==="ADMIN"?e.jsx("span",{className:"text-xs px-2 py-0.5 bg-primary-100 text-primary-700 rounded",children:"Преподаватель"}):null,e.jsx("span",{className:"text-xs text-neutral-500",children:A(s.createdAt)})]}),e.jsxs("div",{className:`rounded-lg p-3 ${a?"bg-primary-600 text-white":"bg-neutral-100 text-neutral-900"}`,children:[e.jsx("p",{className:"whitespace-pre-wrap break-words",children:s.content}),s.fileUrl&&e.jsx("div",{className:"mt-2",children:e.jsxs("a",{href:s.fileUrl,target:"_blank",rel:"noopener noreferrer",className:"inline-flex items-center gap-2 text-sm hover:underline",children:[e.jsx($,{className:"h-4 w-4"}),e.jsx("span",{children:s.fileName||"Файл"}),s.fileSize&&e.jsxs("span",{className:"text-xs opacity-75",children:["(",(s.fileSize/1024).toFixed(1)," KB)"]})]})})]}),z(s)&&e.jsx("button",{onClick:()=>O.mutate(s.id),className:"mt-1 text-xs text-red-600 hover:text-red-700 self-start",children:"Удалить"})]})]},s.id)}),e.jsx("div",{ref:M})]}),n&&e.jsxs("div",{className:"mb-2 p-3 bg-neutral-50 rounded-lg flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx($,{className:"h-5 w-5 text-primary-600"}),e.jsx("span",{className:"text-sm text-neutral-700",children:n.file.name}),e.jsxs("span",{className:"text-xs text-neutral-500",children:["(",(n.file.size/1024).toFixed(1)," KB)"]})]}),e.jsx("button",{onClick:()=>p(null),className:"text-neutral-400 hover:text-neutral-600",children:e.jsx(q,{className:"h-4 w-4"})})]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx("button",{onClick:()=>C.current?.click(),disabled:v,className:"p-2 text-neutral-600 hover:text-primary-600 hover:bg-primary-50 rounded transition-colors disabled:opacity-50",children:v?e.jsx(g,{className:"h-5 w-5 animate-spin"}):e.jsx(B,{className:"h-5 w-5"})}),e.jsx("input",{ref:C,type:"file",className:"hidden",onChange:D}),e.jsx("textarea",{ref:R,value:f,onChange:s=>b(s.target.value),onKeyPress:U,placeholder:"Напишите сообщение...",rows:1,className:"flex-1 input-field resize-none"}),e.jsx("button",{onClick:E,disabled:!f.trim()&&!n||j.isLoading,className:"btn-primary px-4 py-2 disabled:opacity-50 disabled:cursor-not-allowed",children:j.isLoading?e.jsx(g,{className:"h-5 w-5 animate-spin"}):e.jsx(H,{className:"h-5 w-5"})})]}),e.jsx(_,{isOpen:S.isOpen,message:S.message,onClose:()=>u({isOpen:!1,message:""})})]}):e.jsxs("div",{className:"card p-12 text-center",children:[e.jsx("h3",{className:"text-xl font-semibold text-neutral-700 mb-2",children:"Чат не найден"}),e.jsx("button",{onClick:()=>y("/teacher/classes"),className:"btn-primary mt-4",children:"Вернуться к классам"})]})}export{Y as default};
