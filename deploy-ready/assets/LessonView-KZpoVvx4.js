import{u as Y,r as D,e as _,V as G,f as F,j as e,S as ee,M as xe,aj as se,ak as pe,al as ue,T as X,C as ne,h as le,$ as B,a0 as he,a1 as be,am as te,an as ae,D as V,ao as W,z as fe,k as ge,ae as je,d as Ne,ap as ye,aq as ve,ar as J,s as we,L as re}from"./vendor-D-riqg-X.js";import{u as ie,b as Ce,R as E,C as de,a as R}from"./index-citKsecZ.js";const Se=s=>{const i=/^.*(youtu.be\/|v\/|u\/\w\/|embed\/|watch\?v=|&v=)([^#&?]*).*/,n=s.match(i);return n&&n[2].length===11?n[2]:null},ke=s=>{const i=/(?:vimeo\.com\/|player\.vimeo\.com\/video\/)(\d+)/,n=s.match(i);return n?n[1]:null},Ee=s=>{const i=/drive\.google\.com\/file\/d\/([a-zA-Z0-9_-]+)/,n=s.match(i);return n?n[1]:null},ce=s=>{if(!s)return"other";const i=s.toLowerCase();return i.includes("youtube.com")||i.includes("youtu.be")?"youtube":i.includes("vimeo.com")?"vimeo":i.includes("drive.google.com")?"google-drive":i.includes("vk.com/video")?"vk":/\.(mp4|webm|ogg|mov|avi|wmv|flv)(\?.*)?$/i.test(s)?"direct":"other"},Re=s=>{if(!s)return null;switch(ce(s)){case"youtube":{const n=Se(s);return n?`https://www.youtube.com/embed/${n}`:null}case"vimeo":{const n=ke(s);return n?`https://player.vimeo.com/video/${n}`:null}case"google-drive":{const n=Ee(s);return n?`https://drive.google.com/file/d/${n}/preview`:null}case"vk":return s;case"direct":case"other":return s;default:return s}},K=he({content:be().min(1,"Комментарий не может быть пустым").max(1e3,"Комментарий слишком длинный")});function De({lessonId:s}){const{user:i}=ie(),n=Y(),{socket:m}=Ce(),[I,w]=D.useState(null),[L,h]=D.useState(null),[C,b]=D.useState(1),[A,T]=D.useState({isOpen:!1,commentId:null});D.useEffect(()=>{if(m)return m.emit("join-lesson",s),m.on("new-comment",()=>{n.invalidateQueries(["comments",s])}),()=>{m&&(m.emit("leave-lesson",s),m.off("new-comment"))}},[m,s,n]);const{data:O,isLoading:P}=_(["comments",s,C],async()=>(await R.get(`/comments/lesson/${s}?page=${C}&limit=10`)).data,{refetchOnWindowFocus:!1}),$=O?.data?.comments||[],j=O?.data?.pagination,{register:t,handleSubmit:N,reset:g,formState:{errors:c}}=G({resolver:B(K)}),{register:r,handleSubmit:o,reset:x,formState:{errors:S}}=G({resolver:B(K)}),{register:z,handleSubmit:H,reset:Q,formState:{errors:a},setValue:k}=G({resolver:B(K)}),f=F(async l=>(await R.post(`/comments/lesson/${s}`,l)).data,{onSuccess:()=>{n.invalidateQueries(["comments",s]),g(),w(null),x(),C!==1&&b(1)}}),y=F(async l=>{await R.delete(`/comments/${l}`)},{onSuccess:()=>{n.invalidateQueries(["comments",s])}}),d=F(async l=>(await R.put(`/comments/${l.commentId}`,{content:l.content})).data,{onSuccess:()=>{n.invalidateQueries(["comments",s]),h(null),Q()}}),p=l=>{f.mutate(l)},M=(l,u)=>{f.mutate({...l,parentId:u})},v=(l,u)=>{d.mutate({commentId:u,content:l.content})},U=l=>{h(l.id),k("content",l.content)},oe=l=>{if(!i||l.userId!==i.id)return!1;const u=Date.now()-new Date(l.createdAt).getTime(),me=15*60*1e3;return u<=me},Z=l=>i?l.userId===i.id||i.role===E.TEACHER||i.role===E.ADMIN:!1,q=l=>i?i.role===E.TEACHER||i.role===E.ADMIN||i.role===E.CURATOR:!1;return e.jsxs("div",{className:"card p-6 md:p-8 animate-fade-scale",style:{animationDelay:"0.4s"},children:[e.jsx("h2",{className:"text-xl md:text-2xl font-semibold text-neutral-900 mb-6",children:"Комментарии и вопросы"}),i?.role===E.STUDENT&&e.jsx("form",{onSubmit:N(p),className:"mb-6",children:e.jsxs("div",{className:"flex gap-3",children:[e.jsxs("div",{className:"flex-1",children:[e.jsx("textarea",{...t("content"),placeholder:"Оставьте комментарий или вопрос...",className:"input-field resize-none",rows:3}),c.content&&e.jsx("p",{className:"mt-1 text-sm text-red-600",children:c.content.message})]}),e.jsx("button",{type:"submit",disabled:f.isLoading,className:"btn-primary px-6 py-3 h-fit disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center",children:f.isLoading?e.jsx("span",{className:"animate-spin",children:"⟳"}):e.jsx(ee,{className:"h-5 w-5"})})]})}),P?e.jsxs("div",{className:"text-center py-8",children:[e.jsx("div",{className:"inline-block animate-spin rounded-full h-8 w-8 border-4 border-primary-200 border-t-primary-500"}),e.jsx("p",{className:"mt-4 text-neutral-600",children:"Загрузка комментариев..."})]}):$.length===0?e.jsxs("div",{className:"text-center py-8",children:[e.jsx(xe,{className:"mx-auto h-12 w-12 text-neutral-400 mb-4"}),e.jsx("p",{className:"text-neutral-600",children:"Нет комментариев"}),e.jsx("p",{className:"text-sm text-neutral-500 mt-2",children:"Будьте первым, кто оставит комментарий!"})]}):e.jsxs("div",{className:"space-y-4",children:[$.map(l=>e.jsxs("div",{className:"border border-neutral-200 rounded-lg p-4 bg-white animate-slide-in hover:shadow-sm transition-shadow",children:[e.jsxs("div",{className:"flex items-start gap-3 mb-3",children:[e.jsx("div",{className:"flex-shrink-0 w-10 h-10 rounded-full bg-gradient-primary text-white flex items-center justify-center font-bold",children:l.user?.firstName?.[0]||"U"}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-1",children:[e.jsxs("span",{className:"font-semibold text-neutral-900",children:[l.user?.firstName," ",l.user?.lastName]}),(l.user?.role===E.TEACHER||l.user?.role===E.ADMIN||l.user?.role===E.CURATOR)&&e.jsx("span",{className:"text-xs px-2 py-0.5 rounded-full bg-primary-100 text-primary-700 border border-primary-200 font-medium",children:"Преподаватель"})]}),L===l.id?e.jsxs("form",{onSubmit:H(u=>v(u,l.id)),className:"mb-2",children:[e.jsx("textarea",{...z("content"),className:"input-field text-sm resize-none",rows:3}),a.content&&e.jsx("p",{className:"mt-1 text-xs text-red-600",children:a.content.message}),e.jsxs("div",{className:"flex gap-2 mt-2",children:[e.jsx("button",{type:"submit",disabled:d.isLoading,className:"btn-primary px-3 py-1 text-sm disabled:opacity-50",children:"Сохранить"}),e.jsx("button",{type:"button",onClick:()=>{h(null),Q()},className:"btn-secondary px-3 py-1 text-sm",children:"Отмена"})]})]}):e.jsx("p",{className:"text-neutral-700 text-sm mb-2 whitespace-pre-wrap",dangerouslySetInnerHTML:{__html:se.sanitize(l.content,{ALLOWED_TAGS:[]})}}),e.jsxs("div",{className:"flex items-center gap-4 text-xs text-neutral-500",children:[e.jsx("span",{children:new Date(l.createdAt).toLocaleString("ru-RU")}),oe(l)&&L!==l.id&&e.jsxs("button",{onClick:()=>U(l),className:"text-primary-600 hover:text-primary-700 transition-colors flex items-center gap-1",children:[e.jsx(pe,{size:14}),e.jsx("span",{children:"Редактировать"})]}),q()&&e.jsxs("button",{onClick:()=>w(I===l.id?null:l.id),className:"text-primary-600 hover:text-primary-700 transition-colors flex items-center gap-1",children:[e.jsx(ue,{size:14}),e.jsx("span",{children:"Ответить"})]}),Z(l)&&e.jsxs("button",{onClick:()=>T({isOpen:!0,commentId:l.id}),className:"text-red-600 hover:text-red-700 transition-colors flex items-center gap-1",children:[e.jsx(X,{size:14}),e.jsx("span",{children:"Удалить"})]})]})]})]}),I===l.id&&q()&&e.jsxs("form",{onSubmit:o(u=>M(u,l.id)),className:"mt-3 ml-12 md:ml-14 border-l-2 border-primary-300 pl-4",children:[e.jsxs("div",{className:"flex gap-2",children:[e.jsx("textarea",{...r("content"),placeholder:"Ответить...",className:"input-field flex-1 text-sm resize-none",rows:2}),e.jsx("button",{type:"submit",disabled:f.isLoading,className:"btn-primary px-4 py-2 h-fit disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center",children:f.isLoading?e.jsx("span",{className:"animate-spin",children:"⟳"}):e.jsx(ee,{className:"h-4 w-4"})})]}),S.content&&e.jsx("p",{className:"mt-1 text-xs text-red-600",children:S.content.message})]}),l.replies&&l.replies.length>0&&e.jsx("div",{className:"mt-3 ml-12 md:ml-14 space-y-3 border-l-2 border-primary-200 pl-4",children:l.replies.map(u=>e.jsxs("div",{className:"flex items-start gap-3",children:[e.jsx("div",{className:"flex-shrink-0 w-8 h-8 rounded-full bg-gradient-primary text-white flex items-center justify-center font-bold text-sm",children:u.user?.firstName?.[0]||"T"}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-1",children:[e.jsxs("span",{className:"font-semibold text-neutral-900 text-sm",children:[u.user?.firstName," ",u.user?.lastName]}),(u.user?.role===E.TEACHER||u.user?.role===E.ADMIN||u.user?.role===E.CURATOR)&&e.jsx("span",{className:"text-xs px-1.5 py-0.5 rounded-full bg-primary-100 text-primary-700 border border-primary-200 font-medium",children:"Преподаватель"})]}),e.jsx("p",{className:"text-neutral-700 text-sm mb-1 whitespace-pre-wrap",dangerouslySetInnerHTML:{__html:se.sanitize(u.content,{ALLOWED_TAGS:[]})}}),e.jsxs("div",{className:"flex items-center gap-4 text-xs text-neutral-500",children:[e.jsx("span",{children:new Date(u.createdAt).toLocaleString("ru-RU")}),Z(u)&&e.jsxs("button",{onClick:()=>T({isOpen:!0,commentId:u.id}),className:"text-red-600 hover:text-red-700 transition-colors flex items-center gap-1",children:[e.jsx(X,{size:12}),e.jsx("span",{children:"Удалить"})]})]})]})]},u.id))})]},l.id)),j&&j.totalPages>1&&e.jsxs("div",{className:"flex flex-col sm:flex-row items-center justify-between mt-6 pt-6 border-t border-neutral-200 gap-4",children:[e.jsxs("div",{className:"text-sm text-neutral-600",children:["Показано ",(j.page-1)*j.limit+1,"-",Math.min(j.page*j.limit,j.total)," из ",j.total," комментариев"]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs("button",{onClick:()=>b(C-1),disabled:C===1,className:"btn-secondary px-4 py-2 disabled:opacity-50 disabled:cursor-not-allowed flex items-center gap-2 transition-all",title:"Предыдущая страница",children:[e.jsx(ne,{size:16}),e.jsx("span",{className:"hidden sm:inline",children:"Назад"})]}),e.jsxs("div",{className:"flex items-center gap-1 px-3 py-2 bg-primary-50 rounded-lg border border-primary-200",children:[e.jsx("span",{className:"text-sm font-semibold text-primary-700",children:j.page}),e.jsx("span",{className:"text-sm text-primary-500",children:"/"}),e.jsx("span",{className:"text-sm text-primary-600",children:j.totalPages})]}),e.jsxs("button",{onClick:()=>b(C+1),disabled:!j.hasMore,className:"btn-secondary px-4 py-2 disabled:opacity-50 disabled:cursor-not-allowed flex items-center gap-2 transition-all",title:"Следующая страница",children:[e.jsx("span",{className:"hidden sm:inline",children:"Вперед"}),e.jsx(le,{size:16})]})]})]})]}),e.jsx(de,{isOpen:A.isOpen,onClose:()=>T({isOpen:!1,commentId:null}),onConfirm:()=>{A.commentId&&y.mutate(A.commentId)},title:"Удалить комментарий",message:"Вы уверены, что хотите удалить этот комментарий? Это действие нельзя отменить.",confirmText:"Удалить",cancelText:"Отмена",variant:"danger"})]})}function Le({question:s,onAnswer:i,showResult:n,correctAnswer:m}){const[I,w]=D.useState([]),[L,h]=D.useState([]),[C,b]=D.useState([]),[A,T]=D.useState({});D.useEffect(()=>{if(s.metadata){const c=JSON.parse(s.metadata);s.type==="DRAG_DROP"?(w([...c.items]),h(c.targets.map(()=>null))):s.type==="MATCHING"&&b(c.leftItems.map(r=>({left:r,right:null})))}},[s]);const O=(c,r)=>{c.dataTransfer.setData("text/plain",r)},P=(c,r)=>{c.preventDefault();const o=c.dataTransfer.getData("text/plain"),x=[...L];x[r]=o,h(x),w(I.filter(S=>S!==o)),i(x)},$=c=>{c.preventDefault()},j=(c,r)=>{const o=[...C];o[c].right=r,b(o),i(o)},t=(c,r)=>{T({...A,[c]:r}),i(A)},N=()=>{if(s.metadata){const c=JSON.parse(s.metadata);w([...c.items]),h(c.targets.map(()=>null))}},g=()=>{if(s.metadata){const c=JSON.parse(s.metadata);b(c.leftItems.map(r=>({left:r,right:null})))}};if(s.type==="DRAG_DROP"){const c=s.metadata?JSON.parse(s.metadata):null;return c?e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{children:[e.jsx("h3",{className:"text-lg font-semibold text-neutral-900 mb-4",children:s.question}),e.jsxs("button",{onClick:N,className:"text-sm text-primary-600 hover:text-primary-700 mb-4 flex items-center gap-1",children:[e.jsx(te,{className:"h-4 w-4"}),"Сбросить"]})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-6",children:[e.jsxs("div",{children:[e.jsx("h4",{className:"text-sm font-medium text-neutral-700 mb-3",children:"Перетащите элементы:"}),e.jsx("div",{className:"space-y-2",children:I.map((r,o)=>e.jsx("div",{draggable:!0,onDragStart:x=>O(x,r),className:"p-3 bg-primary-100 text-primary-900 rounded-lg cursor-move hover:bg-primary-200 transition-colors",children:r},o))})]}),e.jsxs("div",{children:[e.jsx("h4",{className:"text-sm font-medium text-neutral-700 mb-3",children:"Целевые области:"}),e.jsx("div",{className:"space-y-2",children:c.targets.map((r,o)=>e.jsx("div",{onDrop:x=>P(x,o),onDragOver:$,className:`p-3 border-2 border-dashed rounded-lg min-h-[50px] flex items-center ${L[o]?"border-primary-500 bg-primary-50":"border-neutral-300"}`,children:L[o]?e.jsx("span",{className:"text-primary-900 font-medium",children:L[o]}):e.jsx("span",{className:"text-neutral-400",children:r})},o))})]})]}),n&&m&&e.jsx("div",{className:"mt-4 p-4 rounded-lg bg-neutral-50",children:e.jsxs("p",{className:"text-sm text-neutral-600",children:["Правильный ответ: ",JSON.stringify(m)]})})]}):null}if(s.type==="MATCHING"){const c=s.metadata?JSON.parse(s.metadata):null;return c?e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{children:[e.jsx("h3",{className:"text-lg font-semibold text-neutral-900 mb-4",children:s.question}),e.jsxs("button",{onClick:g,className:"text-sm text-primary-600 hover:text-primary-700 mb-4 flex items-center gap-1",children:[e.jsx(te,{className:"h-4 w-4"}),"Сбросить"]})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-6",children:[e.jsxs("div",{children:[e.jsx("h4",{className:"text-sm font-medium text-neutral-700 mb-3",children:"Левая колонка:"}),e.jsx("div",{className:"space-y-2",children:C.map((r,o)=>e.jsx("div",{className:`p-3 rounded-lg border-2 ${r.right?"border-primary-500 bg-primary-50":"border-neutral-300 bg-neutral-50"}`,children:r.left},o))})]}),e.jsxs("div",{children:[e.jsx("h4",{className:"text-sm font-medium text-neutral-700 mb-3",children:"Правая колонка:"}),e.jsx("div",{className:"space-y-2",children:c.rightItems.map((r,o)=>{const x=C.some(S=>S.right===r);return e.jsx("button",{onClick:()=>{const S=C.findIndex(z=>!z.right);S!==-1&&!x&&j(S,r)},disabled:x,className:`w-full p-3 rounded-lg border-2 text-left transition-colors ${x?"border-primary-500 bg-primary-50 cursor-not-allowed":"border-neutral-300 hover:border-primary-300 hover:bg-primary-50"}`,children:r},o)})})]})]}),n&&m&&e.jsx("div",{className:"mt-4 p-4 rounded-lg bg-neutral-50",children:e.jsxs("p",{className:"text-sm text-neutral-600",children:["Правильные пары: ",JSON.stringify(m)]})})]}):null}if(s.type==="FILL_BLANK"){const c=s.metadata?JSON.parse(s.metadata):null;if(!c)return null;const r=c.text.split("___");return e.jsxs("div",{className:"space-y-4",children:[e.jsx("h3",{className:"text-lg font-semibold text-neutral-900 mb-4",children:s.question}),e.jsx("div",{className:"p-4 bg-neutral-50 rounded-lg",children:r.map((o,x)=>e.jsxs("span",{children:[o,x<r.length-1&&e.jsx("input",{type:"text",value:A[x]||"",onChange:S=>t(x,S.target.value),className:"inline-block mx-2 px-2 py-1 border-2 border-primary-300 rounded focus:outline-none focus:border-primary-500 min-w-[100px]",placeholder:"..."})]},x))}),n&&m&&e.jsx("div",{className:"mt-4 p-4 rounded-lg bg-neutral-50",children:e.jsxs("p",{className:"text-sm text-neutral-600",children:["Правильный ответ: ",JSON.stringify(m)]})})]})}return null}function Ae({lessonId:s,onComplete:i}){const n=Y(),[m,I]=D.useState({}),[w,L]=D.useState(!1),[h,C]=D.useState(null),{data:b,isLoading:A}=_(["quiz",s],async()=>(await R.get(`/quizzes/lesson/${s}`)).data.data,{enabled:!!s}),T=F(async t=>(await R.post(`/quizzes/lesson/${s}/submit`,{answers:t})).data.data,{onSuccess:t=>{C(t),L(!0),n.invalidateQueries(["quiz",s]),i&&i(t)}}),O=(t,N)=>{I(g=>({...g,[t]:typeof N=="string"?N:JSON.stringify(N)}))},P=()=>{if(b&&Object.keys(m).length===b.questions.length){const t={};Object.keys(m).forEach(N=>{t[N]=m[N]}),T.mutate(t)}};if(A)return e.jsxs("div",{className:"card p-6 text-center",children:[e.jsx(ae,{className:"h-8 w-8 animate-spin text-primary-500 mx-auto mb-4"}),e.jsx("p",{className:"text-neutral-600",children:"Загрузка теста..."})]});if(!b)return null;const $=Object.keys(m).length===b.questions.length,j=$&&!w&&!T.isLoading;return e.jsxs("div",{className:"card p-6 md:p-8 animate-fade-scale",children:[e.jsxs("div",{className:"mb-6",children:[e.jsx("h2",{className:"text-2xl md:text-3xl font-bold text-gradient mb-2",children:b.title||"Тест по уроку"}),b.description&&e.jsx("p",{className:"text-neutral-600 mb-4",children:b.description}),e.jsxs("div",{className:"flex items-center gap-4 text-sm text-neutral-500",children:[e.jsxs("span",{children:["Вопросов: ",b.questions.length]}),e.jsxs("span",{children:["Проходной балл: ",b.passingScore,"%"]})]})]}),w&&h?e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:`p-6 rounded-lg border-2 ${h.passed?"bg-green-50 border-green-200":"bg-red-50 border-red-200"}`,children:[e.jsxs("div",{className:"flex items-center gap-3 mb-4",children:[h.passed?e.jsx(V,{className:"h-8 w-8 text-green-600"}):e.jsx(W,{className:"h-8 w-8 text-red-600"}),e.jsxs("div",{children:[e.jsx("h3",{className:`text-xl font-bold ${h.passed?"text-green-700":"text-red-700"}`,children:h.passed?"Тест пройден!":"Тест не пройден"}),e.jsxs("p",{className:`text-sm ${h.passed?"text-green-600":"text-red-600"}`,children:["Ваш результат: ",h.score,"%"]})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex justify-between text-sm",children:[e.jsx("span",{className:"text-neutral-600",children:"Правильных ответов:"}),e.jsxs("span",{className:"font-semibold",children:[h.correctAnswers," из ",h.totalQuestions]})]}),e.jsxs("div",{className:"flex justify-between text-sm",children:[e.jsx("span",{className:"text-neutral-600",children:"Проходной балл:"}),e.jsxs("span",{className:"font-semibold",children:[h.passingScore,"%"]})]})]})]}),e.jsxs("div",{className:"space-y-4",children:[e.jsx("h3",{className:"text-lg font-semibold text-neutral-900",children:"Правильные ответы:"}),b.questions.map((t,N)=>{const g=m[t.id],c=t.type==="MULTIPLE_CHOICE"?t.options?.find(r=>r.id===g)?.isCorrect:g===t.correctAnswer;return e.jsx("div",{className:`p-4 rounded-lg border-2 ${c?"bg-green-50 border-green-200":"bg-red-50 border-red-200"}`,children:e.jsxs("div",{className:"flex items-start gap-2 mb-3",children:[c?e.jsx(V,{className:"h-5 w-5 text-green-600 mt-0.5 flex-shrink-0"}):e.jsx(W,{className:"h-5 w-5 text-red-600 mt-0.5 flex-shrink-0"}),e.jsxs("div",{className:"flex-1",children:[e.jsxs("p",{className:"font-semibold text-neutral-900 mb-2",children:[N+1,". ",t.question]}),t.type==="MULTIPLE_CHOICE"&&t.options&&e.jsx("div",{className:"space-y-2",children:t.options.map(r=>{const o=r.id===g,x=r.isCorrect;return e.jsx("div",{className:`p-2 rounded ${x?"bg-green-100 border-2 border-green-300":o?"bg-red-100 border-2 border-red-300":"bg-neutral-50 border border-neutral-200"}`,children:e.jsxs("div",{className:"flex items-center gap-2",children:[x&&e.jsx(V,{className:"h-4 w-4 text-green-600"}),o&&!x&&e.jsx(W,{className:"h-4 w-4 text-red-600"}),e.jsx("span",{className:x?"font-semibold text-green-700":o?"text-red-700":"text-neutral-700",children:r.text})]})},r.id)})}),t.type==="TRUE_FALSE"&&e.jsxs("div",{className:"space-y-2",children:[e.jsx("div",{className:`p-2 rounded ${t.correctAnswer==="true"?"bg-green-100 border-2 border-green-300":"bg-neutral-50 border border-neutral-200"}`,children:e.jsxs("div",{className:"flex items-center gap-2",children:[t.correctAnswer==="true"&&e.jsx(V,{className:"h-4 w-4 text-green-600"}),e.jsx("span",{className:t.correctAnswer==="true"?"font-semibold text-green-700":"text-neutral-700",children:"Верно"})]})}),e.jsx("div",{className:`p-2 rounded ${t.correctAnswer==="false"?"bg-green-100 border-2 border-green-300":"bg-neutral-50 border border-neutral-200"}`,children:e.jsxs("div",{className:"flex items-center gap-2",children:[t.correctAnswer==="false"&&e.jsx(V,{className:"h-4 w-4 text-green-600"}),e.jsx("span",{className:t.correctAnswer==="false"?"font-semibold text-green-700":"text-neutral-700",children:"Неверно"})]})})]})]})]})},t.id)})]})]}):e.jsxs("div",{className:"space-y-6",children:[b.questions.map((t,N)=>e.jsx("div",{className:"space-y-3",children:e.jsxs("div",{className:"flex items-start gap-3",children:[e.jsx("span",{className:"flex items-center justify-center w-8 h-8 rounded-full bg-gradient-primary text-white font-semibold flex-shrink-0",children:N+1}),e.jsxs("div",{className:"flex-1",children:[e.jsx("p",{className:"font-semibold text-neutral-900 mb-3",children:t.question}),t.type==="MULTIPLE_CHOICE"&&t.options&&e.jsx("div",{className:"space-y-2",children:t.options.map(g=>e.jsxs("label",{className:`flex items-center gap-3 p-3 rounded-lg border-2 cursor-pointer transition-all ${m[t.id]===g.id?"border-primary-500 bg-primary-50":"border-neutral-200 hover:border-primary-300 hover:bg-neutral-50"}`,children:[e.jsx("input",{type:"radio",name:t.id,value:g.id,checked:m[t.id]===g.id,onChange:()=>O(t.id,g.id),className:"w-4 h-4 text-primary-500 focus:ring-primary-500"}),e.jsx("span",{className:"text-neutral-700",children:g.text})]},g.id))}),t.type==="TRUE_FALSE"&&e.jsxs("div",{className:"space-y-2",children:[e.jsxs("label",{className:`flex items-center gap-3 p-3 rounded-lg border-2 cursor-pointer transition-all ${m[t.id]==="true"?"border-primary-500 bg-primary-50":"border-neutral-200 hover:border-primary-300 hover:bg-neutral-50"}`,children:[e.jsx("input",{type:"radio",name:t.id,value:"true",checked:m[t.id]==="true",onChange:()=>O(t.id,"true"),className:"w-4 h-4 text-primary-500 focus:ring-primary-500"}),e.jsx("span",{className:"text-neutral-700",children:"Верно"})]}),e.jsxs("label",{className:`flex items-center gap-3 p-3 rounded-lg border-2 cursor-pointer transition-all ${m[t.id]==="false"?"border-primary-500 bg-primary-50":"border-neutral-200 hover:border-primary-300 hover:bg-neutral-50"}`,children:[e.jsx("input",{type:"radio",name:t.id,value:"false",checked:m[t.id]==="false",onChange:()=>O(t.id,"false"),className:"w-4 h-4 text-primary-500 focus:ring-primary-500"}),e.jsx("span",{className:"text-neutral-700",children:"Неверно"})]})]}),(t.type==="DRAG_DROP"||t.type==="MATCHING"||t.type==="FILL_BLANK")&&e.jsx(Le,{question:t,onAnswer:g=>O(t.id,g),showResult:w,correctAnswer:t.correctAnswer?JSON.parse(t.correctAnswer):void 0})]})]})},t.id)),e.jsxs("div",{className:"pt-4 border-t border-neutral-200",children:[!$&&e.jsxs("div",{className:"flex items-center gap-2 text-amber-600 mb-4",children:[e.jsx(fe,{className:"h-5 w-5"}),e.jsx("span",{className:"text-sm",children:"Ответьте на все вопросы для завершения теста"})]}),e.jsx("button",{onClick:P,disabled:!j,className:"btn-primary w-full md:w-auto disabled:opacity-50 disabled:cursor-not-allowed",children:T.isLoading?e.jsxs("span",{className:"flex items-center gap-2",children:[e.jsx(ae,{className:"h-5 w-5 animate-spin"}),e.jsx("span",{children:"Отправка..."})]}):"Завершить тест"})]})]})]})}function Ie(){const{t:s}=ge(),{courseId:i,lessonId:n}=je(),m=Ne(),I=Y(),{user:w}=ie(),[L,h]=D.useState({isOpen:!1,fileId:null}),{data:C,isLoading:b}=_(["lesson",n],async()=>(await R.get(`/lessons/${n}`)).data.data),{data:A}=_(["practiceExercises",n],async()=>{try{return(await R.get(`/practice/lessons/${n}`)).data.data||[]}catch{return[]}},{enabled:!!n}),{data:T}=_(["flashcardDecks",n],async()=>{try{return(await R.get("/flashcards",{params:{lessonId:n}})).data.data||[]}catch{return[]}},{enabled:!!n}),{data:O}=_(["integrations",n],async()=>{try{return(await R.get("/integrations",{params:{lessonId:n}})).data.data||[]}catch{return[]}},{enabled:!!n}),{data:P}=_(["courseLessons",i],async()=>(await R.get(`/courses/${i}/lessons`)).data.data||[],{enabled:!!i}),$=F(async a=>(await R.put(`/lessons/${n}/progress`,a)).data,{onSuccess:()=>{I.invalidateQueries(["lesson",n])}}),j=F(async a=>{await R.delete(`/files/${a}`)},{onSuccess:()=>{I.invalidateQueries(["lesson",n]),h({isOpen:!1,fileId:null})}}),t=a=>w?w.role===E.TEACHER||w.role===E.ADMIN||w.role===E.CURATOR:!1,N=async(a,k,f)=>{a.preventDefault(),a.stopPropagation(),a.nativeEvent&&a.nativeEvent.stopImmediatePropagation();try{let y=f;try{if(/[ĐÑ€Ð£]/.test(f))try{const d=new Uint8Array(f.length);for(let p=0;p<f.length;p++)d[p]=f.charCodeAt(p)&255;y=new TextDecoder("utf-8",{fatal:!1}).decode(d),/[ĐÑ€Ð£]/.test(y)&&(y=decodeURIComponent(escape(f)))}catch{y=decodeURIComponent(escape(f))}else if(f.includes("%"))try{y=decodeURIComponent(f)}catch{y=f}}catch{y=f}if(k.includes("supabase.co")||k.includes("cloudinary.com")||k.startsWith("http")&&!k.includes("/api/files/"))try{const d=await fetch(k,{mode:"cors"});if(!d.ok)throw new Error("Failed to fetch file");const p=await d.blob(),M=window.URL.createObjectURL(p),v=document.createElement("a");v.href=M,v.download=y,v.style.display="none",document.body.appendChild(v),v.click(),setTimeout(()=>{document.body.contains(v)&&document.body.removeChild(v),window.URL.revokeObjectURL(M)},100)}catch(d){console.error("Error fetching cloud file:",d);const p=document.createElement("a");p.href=k,p.download=y,p.target="_blank",p.rel="noopener noreferrer",p.style.display="none",document.body.appendChild(p),p.click(),setTimeout(()=>{document.body.contains(p)&&document.body.removeChild(p)},100)}else{const d=k.replace("/api/files/download/",""),p=await R.get(`/files/download/${d}`,{responseType:"blob"}),M=new Blob([p.data]),v=window.URL.createObjectURL(M),U=document.createElement("a");U.href=v,U.download=y,U.style.display="none",document.body.appendChild(U),U.click(),setTimeout(()=>{document.body.contains(U)&&document.body.removeChild(U),window.URL.revokeObjectURL(v)},100)}}catch(y){console.error("Error downloading file:",y);try{const d=document.createElement("a");d.href=k,d.target="_blank",d.rel="noopener noreferrer",d.style.display="none",document.body.appendChild(d),d.click(),setTimeout(()=>{document.body.contains(d)&&document.body.removeChild(d)},100)}catch(d){console.error("Fallback download also failed:",d)}}return!1},g=a=>{$.mutate({lastPosition:Math.floor(a.playedSeconds)})},c=()=>{$.mutate({completed:!0})};if(b)return e.jsxs("div",{className:"text-center py-12",children:[e.jsx("div",{className:"inline-block relative",children:e.jsx("div",{className:"animate-spin rounded-full h-12 w-12 border-4 border-primary-200 border-t-primary-500"})}),e.jsx("p",{className:"mt-4 text-neutral-600",children:s("common.loading")})]});const r=C;if(!r)return e.jsx("div",{className:"text-center py-12",children:e.jsx("p",{className:"text-neutral-600",children:s("errors.notFound")})});const o=P||[],x=o.findIndex(a=>a.id===n),S=x>0?o[x-1]:null,z=x<o.length-1?o[x+1]:null,H=r.videoUrl?Re(r.videoUrl):null,Q=r.videoUrl?ce(r.videoUrl):null;return e.jsxs("div",{children:[e.jsxs("button",{onClick:()=>m(`/courses/${i}`),className:"flex items-center text-neutral-600 hover:text-primary-600 mb-6 transition-colors group",children:[e.jsx(ye,{className:"h-5 w-5 mr-2 group-hover:-translate-x-1 transition-transform"}),"Назад к курсу"]}),e.jsxs("div",{className:"card rounded-lg shadow-soft border border-neutral-200 p-4 md:p-6 mb-6 animate-fade-scale",children:[e.jsx("h1",{className:"text-xl md:text-2xl lg:text-4xl font-bold text-gradient mb-4 break-words",children:r.title}),r.description&&e.jsx("p",{className:"text-neutral-600 mb-6",children:r.description}),r.progress?.completed&&e.jsxs("div",{className:"inline-flex items-center px-3 py-1 rounded-full text-sm font-medium bg-green-100 text-green-700 border border-green-200",children:[e.jsx(V,{className:"h-4 w-4 mr-1 text-green-700"}),s("lessons.completed")]})]}),H&&e.jsxs("div",{className:"card rounded-lg shadow-soft border border-neutral-200 p-4 md:p-6 mb-6 animate-fade-scale",style:{animationDelay:"0.1s"},children:[e.jsx("h2",{className:"text-lg md:text-xl font-semibold text-neutral-900 mb-4",children:s("lessons.videoLesson",{defaultValue:"Видео урок"})}),e.jsx("div",{className:"aspect-video",children:Q==="google-drive"?e.jsx("iframe",{src:H||"",width:"100%",height:"100%",allow:"autoplay",style:{border:"none"},allowFullScreen:!0}):e.jsx(ve,{url:r.videoUrl||"",width:"100%",height:"100%",controls:!0,onProgress:g,onEnded:c,config:{youtube:{playerVars:{start:r.progress?.lastPosition||0}},vimeo:{playerOptions:{start:r.progress?.lastPosition||0}}}})})]}),r.files&&r.files.length>0&&e.jsxs("div",{className:"card rounded-lg shadow-soft border border-neutral-200 p-4 md:p-6 mb-6 animate-fade-scale",style:{animationDelay:"0.2s"},children:[e.jsx("h2",{className:"text-lg md:text-xl font-semibold text-neutral-900 mb-4",children:s("lessons.files",{defaultValue:"Файлы урока"})}),e.jsx("div",{className:"space-y-3",children:r.files.map(a=>{const k=/\.(mp4|webm|mov|avi|wmv|flv|mpeg)$/i.test(a.fileName),f=/\.(pdf|doc|docx|xls|xlsx|ppt|pptx|txt)$/i.test(a.fileName),y=/\.(jpg|jpeg|png|gif|webp)$/i.test(a.fileName);return e.jsxs("div",{className:"flex flex-col sm:flex-row items-start sm:items-center justify-between gap-3 sm:gap-0 p-3 md:p-4 border border-neutral-200 rounded-lg hover:bg-neutral-50 hover:border-primary-300 transition-all group",children:[e.jsxs("div",{className:"flex items-center flex-1 min-w-0",children:[e.jsx("div",{className:"flex-shrink-0 mr-3",children:f?e.jsx(J,{className:"h-5 w-5 text-blue-500"}):k?e.jsx(we,{className:"h-5 w-5 text-purple-500"}):y?e.jsx(J,{className:"h-5 w-5 text-green-500"}):e.jsx(J,{className:"h-5 w-5 text-primary-500"})}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsx("p",{className:"font-medium text-neutral-900 truncate",title:a.fileName,children:(()=>{try{const d=a.fileName;if(/[ĐÑ€Ð£]/.test(d))try{const p=new Uint8Array(d.length);for(let v=0;v<d.length;v++)p[v]=d.charCodeAt(v)&255;const M=new TextDecoder("utf-8",{fatal:!1}).decode(p);return/[ĐÑ€Ð£]/.test(M)?decodeURIComponent(escape(d)):M}catch{return decodeURIComponent(escape(d))}return d}catch{return a.fileName}})()}),e.jsxs("p",{className:"text-sm text-neutral-500",children:[s("lessons.fileSize",{defaultValue:"Размер"}),": ",(a.fileSize/1024/1024).toFixed(2)," MB",k&&e.jsx("span",{className:"ml-2 text-purple-600",children:"• Видео"}),f&&e.jsx("span",{className:"ml-2 text-blue-600",children:"• Документ"}),y&&e.jsx("span",{className:"ml-2 text-green-600",children:"• Изображение"})]})]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs("button",{type:"button",onClick:d=>{d.preventDefault(),d.stopPropagation(),N(d,a.fileUrl,a.fileName)},className:"btn-secondary px-4 py-2 text-sm flex items-center gap-2",children:[e.jsx(J,{className:"h-4 w-4"}),k?"Смотреть":"Скачать"]}),t()&&e.jsxs("button",{type:"button",onClick:d=>{d.preventDefault(),d.stopPropagation(),h({isOpen:!0,fileId:a.id})},className:"px-3 py-2 text-sm text-red-600 hover:text-red-700 hover:bg-red-50 border border-red-200 rounded-lg transition-colors flex items-center gap-2",title:"Удалить файл",children:[e.jsx(X,{className:"h-4 w-4"}),e.jsx("span",{className:"hidden sm:inline",children:"Удалить"})]})]})]},a.id)})})]}),O&&O.length>0&&e.jsxs("div",{className:"card rounded-lg shadow-soft border border-neutral-200 p-4 md:p-6 mb-6 animate-fade-scale",style:{animationDelay:"0.22s"},children:[e.jsx("h2",{className:"text-lg md:text-xl font-semibold text-neutral-900 mb-4",children:s("lessons.additionalMaterials",{defaultValue:"Дополнительные материалы"})}),e.jsx("div",{className:"space-y-4",children:O.map(a=>e.jsxs("div",{className:"p-4 border border-neutral-200 rounded-lg",children:[e.jsx("h3",{className:"font-semibold text-neutral-900 mb-2",children:a.type}),e.jsxs("a",{href:a.externalUrl,target:"_blank",rel:"noopener noreferrer",className:"btn-secondary text-sm inline-flex items-center gap-2",children:[s("integrations.open")," ",a.type]})]},a.id))})]}),A&&A.length>0&&e.jsxs("div",{className:"card rounded-lg shadow-soft border border-neutral-200 p-4 md:p-6 mb-6 animate-fade-scale",style:{animationDelay:"0.23s"},children:[e.jsx("h2",{className:"text-lg md:text-xl font-semibold text-neutral-900 mb-6",children:s("practice.title")}),e.jsx("div",{className:"space-y-6",children:A.map(a=>e.jsxs("div",{className:"p-4 border border-neutral-200 rounded-lg",children:[e.jsx("h3",{className:"text-lg font-semibold text-neutral-900 mb-2",children:a.title}),a.description&&e.jsx("p",{className:"text-neutral-600 mb-4",children:a.description}),e.jsx("p",{className:"text-sm text-neutral-500 mb-4",children:a.instructions}),e.jsx(re,{to:`/lessons/${n}/practice`,className:"btn-primary text-sm",children:s("practice.execute",{defaultValue:"Выполнить упражнение"})})]},a.id))})]}),T&&T.length>0&&e.jsxs("div",{className:"card rounded-lg shadow-soft border border-neutral-200 p-4 md:p-6 mb-6 animate-fade-scale",style:{animationDelay:"0.24s"},children:[e.jsx("h2",{className:"text-lg md:text-xl font-semibold text-neutral-900 mb-4",children:s("flashcards.title")}),e.jsx("div",{className:"space-y-4",children:T.map(a=>e.jsxs("div",{className:"p-4 border border-neutral-200 rounded-lg",children:[e.jsx("h3",{className:"text-lg font-semibold text-neutral-900 mb-2",children:a.title}),a.description&&e.jsx("p",{className:"text-neutral-600 mb-4 text-sm",children:a.description}),e.jsxs("p",{className:"text-sm text-neutral-500 mb-4",children:[a._count?.flashcards||0," карточек"]}),e.jsx(re,{to:`/flashcards/${a.id}/study`,className:"btn-primary text-sm",children:s("flashcards.study")})]},a.id))})]}),e.jsx("div",{className:"mb-6 animate-fade-scale",style:{animationDelay:"0.25s"},children:e.jsx(Ae,{lessonId:n,onComplete:a=>{a.passed&&I.invalidateQueries(["lesson",n])}})}),e.jsx(De,{lessonId:n}),e.jsxs("div",{className:"flex flex-col sm:flex-row items-stretch sm:items-center justify-between gap-3 sm:gap-4 mt-6 md:mt-8 animate-fade-scale",style:{animationDelay:"0.3s"},children:[S?e.jsxs("button",{onClick:()=>m(`/courses/${i}/lessons/${S.id}`),className:"btn-secondary group flex items-center gap-3 flex-1",children:[e.jsx(ne,{className:"h-5 w-5 group-hover:-translate-x-1 transition-transform"}),e.jsxs("div",{className:"flex-1 text-left",children:[e.jsx("div",{className:"text-xs text-neutral-500 mb-1",children:s("lessons.previousLesson",{defaultValue:"Предыдущий урок"})}),e.jsx("div",{className:"font-semibold truncate",children:S.title})]})]}):e.jsx("div",{className:"flex-1"}),z?e.jsxs("button",{onClick:()=>m(`/courses/${i}/lessons/${z.id}`),className:"btn-secondary group flex items-center gap-3 flex-1",children:[e.jsxs("div",{className:"flex-1 text-right",children:[e.jsx("div",{className:"text-xs text-neutral-500 mb-1",children:s("lessons.nextLesson",{defaultValue:"Следующий урок"})}),e.jsx("div",{className:"font-semibold truncate",children:z.title})]}),e.jsx(le,{className:"h-5 w-5 group-hover:translate-x-1 transition-transform"})]}):e.jsx("div",{className:"flex-1"})]}),e.jsx(de,{isOpen:L.isOpen,onClose:()=>h({isOpen:!1,fileId:null}),onConfirm:()=>{L.fileId&&j.mutate(L.fileId)},title:"Удалить файл",message:"Вы уверены, что хотите удалить этот файл? Это действие нельзя отменить.",confirmText:"Удалить",cancelText:"Отмена",variant:"danger"})]})}export{Ie as default};
