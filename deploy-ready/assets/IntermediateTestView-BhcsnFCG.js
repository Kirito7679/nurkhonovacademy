import{ae as O,d as $,u as P,r as i,e as Q,f as R,j as e,ap as v,D as U,ao as X,a4 as D}from"./vendor-D-riqg-X.js";import{a as y}from"./index-BdrAEdvH.js";import{E as F}from"./ErrorModal-CzR1kAop.js";function B(){const{courseId:c,testId:l}=O(),d=$(),u=P(),[h,j]=i.useState({}),[f,w]=i.useState({}),[N,S]=i.useState(0),[C,L]=i.useState(!1),[n,E]=i.useState(null),[b,g]=i.useState({isOpen:!1,message:""}),{data:a,isLoading:k}=Q(["test",l],async()=>(await y.get(`/tests/${l}`)).data.data),m=R(async s=>(await y.post(`/tests/${l}/submit`,s)).data.data,{onSuccess:s=>{E(s),L(!0),u.invalidateQueries(["test",l]),u.invalidateQueries("user")},onError:s=>{g({isOpen:!0,message:s.response?.data?.message||"Ошибка при отправке теста"})}});i.useEffect(()=>{if(!a?.timeLimit)return;const s=setInterval(()=>{S(t=>t+1)},1e3);return()=>clearInterval(s)},[a?.timeLimit]);const M=(s,t,r)=>{j(r?x=>{const p=x[s]||[];return p.includes(t)?{...x,[s]:p.filter(I=>I!==t)}:{...x,[s]:[...p,t]}}:{...prev,[s]:[t]})},T=(s,t)=>{w(r=>({...r,[s]:t}))},A=()=>{if(!a)return;const s=a.questions?.map(t=>({questionId:t.id,optionIds:h[t.id]||[],textAnswer:f[t.id]||void 0}))||[];m.mutate({testId:l,answers:s,timeSpent:N})};if(k)return e.jsxs("div",{className:"text-center py-12",children:[e.jsx("div",{className:"inline-block relative",children:e.jsx("div",{className:"animate-spin rounded-full h-12 w-12 border-4 border-primary-200 border-t-primary-500"})}),e.jsx("p",{className:"mt-4 text-neutral-600",children:"Загрузка теста..."})]});if(!a)return e.jsx("div",{className:"text-center py-12",children:e.jsx("p",{className:"text-neutral-600",children:"Тест не найден"})});if(C&&n)return e.jsxs("div",{children:[e.jsxs("button",{onClick:()=>d(`/courses/${c}`),className:"flex items-center text-neutral-600 hover:text-primary-600 mb-6 transition-colors",children:[e.jsx(v,{className:"h-5 w-5 mr-2"}),"Назад к курсу"]}),e.jsxs("div",{className:"card p-8 text-center",children:[n.passed?e.jsx(U,{className:"h-16 w-16 text-green-500 mx-auto mb-4"}):e.jsx(X,{className:"h-16 w-16 text-red-500 mx-auto mb-4"}),e.jsx("h1",{className:"text-2xl font-bold text-neutral-900 mb-2",children:n.passed?"Тест пройден!":"Тест не пройден"}),e.jsxs("div",{className:"mt-6 space-y-2",children:[e.jsxs("p",{className:"text-lg",children:[e.jsx("span",{className:"font-semibold",children:"Результат:"})," ",n.percentage.toFixed(1),"%"]}),e.jsxs("p",{className:"text-lg",children:[e.jsx("span",{className:"font-semibold",children:"Баллов:"})," ",n.score]}),n.timeSpent&&e.jsxs("p",{className:"text-lg",children:[e.jsx("span",{className:"font-semibold",children:"Время:"})," ",Math.floor(n.timeSpent/60),":",(n.timeSpent%60).toString().padStart(2,"0")]})]}),e.jsx("button",{onClick:()=>d(`/courses/${c}`),className:"btn-primary mt-6",children:"Вернуться к курсу"})]})]});const o=a.timeLimit?a.timeLimit*60-N:null;return e.jsxs("div",{children:[e.jsxs("button",{onClick:()=>d(`/courses/${c}`),className:"flex items-center text-neutral-600 hover:text-primary-600 mb-6 transition-colors",children:[e.jsx(v,{className:"h-5 w-5 mr-2"}),"Назад к курсу"]}),e.jsx("div",{className:"card p-6 mb-6",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("h1",{className:"text-2xl font-bold text-neutral-900",children:a.title}),a.description&&e.jsx("p",{className:"text-neutral-600 mt-2",children:a.description})]}),o!==null&&e.jsxs("div",{className:"flex items-center gap-2 text-lg font-semibold",children:[e.jsx(D,{className:"h-5 w-5"}),e.jsxs("span",{children:[Math.floor(o/60),":",(o%60).toString().padStart(2,"0")]})]})]})}),e.jsx("div",{className:"space-y-6",children:a.questions?.map((s,t)=>e.jsxs("div",{className:"card p-6",children:[e.jsxs("div",{className:"flex items-start gap-3 mb-4",children:[e.jsx("span",{className:"flex-shrink-0 w-8 h-8 rounded-full bg-primary-100 text-primary-700 flex items-center justify-center font-semibold",children:t+1}),e.jsxs("div",{className:"flex-1",children:[e.jsx("p",{className:"font-medium text-neutral-900 mb-2",children:s.question}),e.jsxs("p",{className:"text-sm text-neutral-600",children:[s.type==="SINGLE"?"Выберите один ответ":s.type==="MULTIPLE"?"Выберите несколько ответов":"Введите текстовый ответ"," • Баллов: ",s.points]})]})]}),s.type==="TEXT"?e.jsx("textarea",{value:f[s.id]||"",onChange:r=>T(s.id,r.target.value),className:"input-field",rows:4,placeholder:"Введите ваш ответ..."}):e.jsx("div",{className:"space-y-2",children:s.options?.map(r=>e.jsxs("label",{className:"flex items-center gap-3 p-3 border border-neutral-200 rounded-lg hover:bg-neutral-50 cursor-pointer",children:[e.jsx("input",{type:s.type==="MULTIPLE"?"checkbox":"radio",name:s.id,checked:(h[s.id]||[]).includes(r.id),onChange:()=>M(s.id,r.id,s.type==="MULTIPLE"),className:"w-4 h-4 text-primary-600"}),e.jsx("span",{className:"flex-1",children:r.text})]},r.id))})]},s.id))}),e.jsx("div",{className:"mt-6 flex justify-end",children:e.jsx("button",{onClick:A,disabled:m.isLoading,className:"btn-primary disabled:opacity-50",children:m.isLoading?"Отправка...":"Отправить тест"})}),e.jsx(F,{isOpen:b.isOpen,message:b.message,onClose:()=>g({isOpen:!1,message:""})})]})}export{B as default};
