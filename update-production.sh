#!/bin/bash

# –°–∫—Ä–∏–ø—Ç –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –ø—Ä–æ–¥–∞–∫—à–µ–Ω–∞ –±–µ–∑ –ø–æ—Ç–µ—Ä–∏ –¥–∞–Ω–Ω—ã—Ö

echo "üîÑ –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –∫ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—é –ø—Ä–æ–¥–∞–∫—à–µ–Ω–∞..."
echo ""

# –¶–≤–µ—Ç–∞ –¥–ª—è –≤—ã–≤–æ–¥–∞
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
RED='\033[0;31m'
NC='\033[0m' # No Color

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞–ª–∏—á–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π
echo "üìã –ü—Ä–æ–≤–µ—Ä–∫–∞ –∏–∑–º–µ–Ω–µ–Ω–∏–π..."

cd backend
if [ -f "prisma/dev.db" ]; then
    echo -e "${YELLOW}‚ö†Ô∏è  –û–±–Ω–∞—Ä—É–∂–µ–Ω–∞ –ª–æ–∫–∞–ª—å–Ω–∞—è –±–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö${NC}"
    echo "üí° –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –Ω–∞ –ø—Ä–æ–¥–∞–∫—à–µ–Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –æ—Ç–¥–µ–ª—å–Ω–∞—è –±–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö"
    echo ""
fi

# –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ –º–∏–≥—Ä–∞—Ü–∏–π
echo "üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ –º–∏–≥—Ä–∞—Ü–∏–π..."
npx prisma migrate status > /dev/null 2>&1
if [ $? -eq 0 ]; then
    echo -e "${GREEN}‚úÖ –ú–∏–≥—Ä–∞—Ü–∏–∏ –≤ –ø–æ—Ä—è–¥–∫–µ${NC}"
else
    echo -e "${YELLOW}‚ö†Ô∏è  –ï—Å—Ç—å –Ω–µ–ø—Ä–∏–º–µ–Ω–µ–Ω–Ω—ã–µ –º–∏–≥—Ä–∞—Ü–∏–∏${NC}"
    echo "üí° –ù–∞ –ø—Ä–æ–¥–∞–∫—à–µ–Ω–µ –≤—ã–ø–æ–ª–Ω–∏—Ç–µ: npx prisma migrate deploy"
fi

echo ""
echo "üì¶ –°–±–æ—Ä–∫–∞ –ø—Ä–æ–µ–∫—Ç–∞..."

# –°–±–æ—Ä–∫–∞ —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥–∞
echo "1Ô∏è‚É£  –°–±–æ—Ä–∫–∞ —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥–∞..."
cd ../frontend
npm install
npm run build

if [ $? -eq 0 ]; then
    echo -e "${GREEN}‚úÖ –§—Ä–æ–Ω—Ç–µ–Ω–¥ —Å–æ–±—Ä–∞–Ω${NC}"
    echo "üìÅ –§–∞–π–ª—ã –≥–æ—Ç–æ–≤—ã –≤: frontend/dist/"
else
    echo -e "${RED}‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–±–æ—Ä–∫–µ —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥–∞${NC}"
    exit 1
fi

# –°–±–æ—Ä–∫–∞ –±—ç–∫–µ–Ω–¥–∞
echo ""
echo "2Ô∏è‚É£  –°–±–æ—Ä–∫–∞ –±—ç–∫–µ–Ω–¥–∞..."
cd ../backend
npm install
npm run build

if [ $? -eq 0 ]; then
    echo -e "${GREEN}‚úÖ –ë—ç–∫–µ–Ω–¥ —Å–æ–±—Ä–∞–Ω${NC}"
    echo "üìÅ –§–∞–π–ª—ã –≥–æ—Ç–æ–≤—ã –≤: backend/dist/"
else
    echo -e "${RED}‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–±–æ—Ä–∫–µ –±—ç–∫–µ–Ω–¥–∞${NC}"
    exit 1
fi

echo ""
echo -e "${GREEN}‚ú® –°–±–æ—Ä–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞!${NC}"
echo ""
echo "üìã –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏ –Ω–∞ –ø—Ä–æ–¥–∞–∫—à–µ–Ω–µ:"
echo ""
echo "1. –°–æ–∑–¥–∞–π—Ç–µ —Ä–µ–∑–µ—Ä–≤–Ω—É—é –∫–æ–ø–∏—é –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö:"
echo "   cp prisma/dev.db prisma/dev.db.backup-\$(date +%Y%m%d)"
echo ""
echo "2. –ó–∞–≥—Ä—É–∑–∏—Ç–µ –Ω–æ–≤—ã–µ —Ñ–∞–π–ª—ã:"
echo "   - frontend/dist/ ‚Üí –∑–∞–º–µ–Ω–∏—Ç–µ —Å—Ç–∞—Ä—ã–µ —Ñ–∞–π–ª—ã"
echo "   - backend/dist/ ‚Üí –∑–∞–º–µ–Ω–∏—Ç–µ —Å—Ç–∞—Ä—ã–π –∫–æ–¥"
echo "   - backend/prisma/migrations/ ‚Üí –µ—Å–ª–∏ –±—ã–ª–∏ –Ω–æ–≤—ã–µ –º–∏–≥—Ä–∞—Ü–∏–∏"
echo ""
echo "3. –ü—Ä–∏–º–µ–Ω–∏—Ç–µ –º–∏–≥—Ä–∞—Ü–∏–∏ (–µ—Å–ª–∏ –±—ã–ª–∏ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Å—Ö–µ–º—ã):"
echo "   cd backend"
echo "   npx prisma migrate deploy"
echo "   npx prisma generate"
echo ""
echo "4. –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç–µ —Å–µ—Ä–≤–µ—Ä"
echo ""
echo "üìñ –ü–æ–¥—Ä–æ–±–Ω–∞—è –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è: –û–ë–ù–û–í–õ–ï–ù–ò–ï_–ë–ï–ó_–ü–û–¢–ï–†–ò_–î–ê–ù–ù–´–•.md"
