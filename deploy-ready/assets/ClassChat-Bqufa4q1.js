import{a6 as T,u as K,a as D,r as d,b as P,d as R,j as s,ae as y,ag as B,M as q,aI as F,X as H,aJ as J,S as V}from"./vendor-react-CYnsZ-uh.js";import{u as X,a as h}from"./index-B_lpl_ns.js";import{E as _}from"./ErrorModal-BhYSOHfb.js";import{u as G}from"./useSocket-kWQQDm03.js";import"./vendor-other-G1F3Ub8s.js";function ae(){const{id:r}=T(),b=K(),{user:t}=X(),x=D(),[f,v]=d.useState(""),[o,N]=d.useState(null),[w,C]=d.useState(!1),M=d.useRef(null),O=d.useRef(null),S=d.useRef(null),[E,u]=d.useState({isOpen:!1,message:""}),{socket:m,isConnected:j}=G(),{data:i,isLoading:I}=P(["classChat",r],async()=>r?(await h.get(`/classes/${r}/messages`)).data.data:null,{enabled:!!r});d.useEffect(()=>{if(m&&j&&r){m.emit("join-class-chat",r);const e=l=>{x.setQueryData(["classChat",r],n=>n&&{...n,messages:[...n.messages,l]})},a=({messageId:l})=>{x.setQueryData(["classChat",r],n=>n&&{...n,messages:n.messages.filter(c=>c.id!==l)})};return m.on("new-class-message",e),m.on("class-message-deleted",a),()=>{m.emit("leave-class-chat",r),m.off("new-class-message",e),m.off("class-message-deleted",a)}}},[m,j,r,x]),d.useEffect(()=>{var e;(e=S.current)==null||e.scrollIntoView({behavior:"smooth"})},[i==null?void 0:i.messages]);const g=R(async e=>(await h.post(`/classes/${r}/messages`,e)).data.data,{onSuccess:()=>{v(""),N(null),x.invalidateQueries(["classChat",r])},onError:e=>{var a,l;u({isOpen:!0,message:((l=(a=e.response)==null?void 0:a.data)==null?void 0:l.message)||"Ошибка при отправке сообщения"})}}),U=R(async e=>{await h.delete(`/classes/messages/${e}`)},{onSuccess:()=>{x.invalidateQueries(["classChat",r])},onError:e=>{var a,l;u({isOpen:!0,message:((l=(a=e.response)==null?void 0:a.data)==null?void 0:l.message)||"Ошибка при удалении сообщения"})}}),z=async e=>{var l,n,c;const a=(l=e.target.files)==null?void 0:l[0];if(a){if(a.size>10*1024*1024){u({isOpen:!0,message:"Размер файла не должен превышать 10MB"});return}C(!0);try{const p=new FormData;p.append("file",a);const $=await h.post("/messages/upload-file",p,{headers:{"Content-Type":"multipart/form-data"}});$.data.data&&N({file:a,url:$.data.data.fileUrl})}catch(p){u({isOpen:!0,message:((c=(n=p.response)==null?void 0:n.data)==null?void 0:c.message)||"Ошибка при загрузке файла"})}finally{C(!1)}}},k=()=>{if(!f.trim()&&!o)return;const e={content:f.trim()||"Файл"};o&&(e.fileUrl=o.url,e.fileName=o.file.name,e.fileSize=o.file.size),g.mutate(e)},A=e=>{e.key==="Enter"&&!e.shiftKey&&(e.preventDefault(),k())},L=e=>e.senderId===(t==null?void 0:t.id)||(t==null?void 0:t.role)==="ADMIN"||(t==null?void 0:t.role)==="TEACHER"&&(i==null?void 0:i.class.teacher.id)===(t==null?void 0:t.id),Q=e=>{const a=new Date(e),n=new Date().getTime()-a.getTime(),c=Math.floor(n/6e4);return c<1?"только что":c<60?`${c} мин назад`:c<1440?`${Math.floor(c/60)} ч назад`:a.toLocaleDateString("ru-RU",{day:"numeric",month:"short",hour:"2-digit",minute:"2-digit"})};return I?s.jsx("div",{className:"flex items-center justify-center h-screen",children:s.jsxs("div",{className:"text-center",children:[s.jsx(y,{className:"h-8 w-8 animate-spin text-primary-600 mx-auto mb-4"}),s.jsx("p",{className:"text-neutral-600",children:"Загрузка чата..."})]})}):i?s.jsxs("div",{className:"flex flex-col h-[calc(100vh-8rem)]",children:[s.jsxs("div",{className:"flex items-center gap-4 mb-4 pb-4 border-b border-neutral-200",children:[s.jsx("button",{onClick:()=>b(`/classes/${r}`),className:"p-2 text-neutral-600 hover:text-primary-600 hover:bg-primary-50 rounded transition-colors",children:s.jsx(B,{className:"h-5 w-5"})}),s.jsxs("div",{className:"flex-1",children:[s.jsx("h1",{className:"text-xl font-semibold text-neutral-900",children:i.class.name}),s.jsxs("p",{className:"text-sm text-neutral-600",children:["Групповой чат • ",i.messages.length," сообщений"]})]}),!j&&s.jsx("span",{className:"text-xs text-yellow-600 bg-yellow-50 px-2 py-1 rounded",children:"Подключение..."})]}),s.jsxs("div",{className:"flex-1 overflow-y-auto space-y-4 mb-4 pr-2",children:[i.messages.length===0?s.jsxs("div",{className:"text-center py-12",children:[s.jsx(q,{className:"h-16 w-16 text-neutral-300 mx-auto mb-4"}),s.jsx("p",{className:"text-neutral-600",children:"Нет сообщений. Начните общение!"})]}):i.messages.map(e=>{const a=e.senderId===(t==null?void 0:t.id);return s.jsxs("div",{className:`flex gap-3 ${a?"flex-row-reverse":""}`,children:[s.jsx("div",{className:"flex-shrink-0",children:s.jsx("div",{className:"w-10 h-10 rounded-full bg-primary-100 flex items-center justify-center",children:e.sender.avatarUrl?s.jsx("img",{src:e.sender.avatarUrl,alt:`${e.sender.firstName} ${e.sender.lastName}`,className:"w-10 h-10 rounded-full object-cover"}):s.jsxs("span",{className:"text-primary-600 font-semibold text-sm",children:[e.sender.firstName[0],e.sender.lastName[0]]})})}),s.jsxs("div",{className:`flex-1 ${a?"items-end":""} flex flex-col`,children:[s.jsxs("div",{className:"flex items-center gap-2 mb-1",children:[s.jsxs("span",{className:"text-sm font-semibold text-neutral-900",children:[e.sender.firstName," ",e.sender.lastName]}),e.sender.role==="TEACHER"||e.sender.role==="ADMIN"?s.jsx("span",{className:"text-xs px-2 py-0.5 bg-primary-100 text-primary-700 rounded",children:"Преподаватель"}):null,s.jsx("span",{className:"text-xs text-neutral-500",children:Q(e.createdAt)})]}),s.jsxs("div",{className:`rounded-lg p-3 ${a?"bg-primary-600 text-white":"bg-neutral-100 text-neutral-900"}`,children:[s.jsx("p",{className:"whitespace-pre-wrap break-words",children:e.content}),e.fileUrl&&s.jsx("div",{className:"mt-2",children:s.jsxs("a",{href:e.fileUrl,target:"_blank",rel:"noopener noreferrer",className:"inline-flex items-center gap-2 text-sm hover:underline",children:[s.jsx(F,{className:"h-4 w-4"}),s.jsx("span",{children:e.fileName||"Файл"}),e.fileSize&&s.jsxs("span",{className:"text-xs opacity-75",children:["(",(e.fileSize/1024).toFixed(1)," KB)"]})]})})]}),L(e)&&s.jsx("button",{onClick:()=>U.mutate(e.id),className:"mt-1 text-xs text-red-600 hover:text-red-700 self-start",children:"Удалить"})]})]},e.id)}),s.jsx("div",{ref:S})]}),o&&s.jsxs("div",{className:"mb-2 p-3 bg-neutral-50 rounded-lg flex items-center justify-between",children:[s.jsxs("div",{className:"flex items-center gap-2",children:[s.jsx(F,{className:"h-5 w-5 text-primary-600"}),s.jsx("span",{className:"text-sm text-neutral-700",children:o.file.name}),s.jsxs("span",{className:"text-xs text-neutral-500",children:["(",(o.file.size/1024).toFixed(1)," KB)"]})]}),s.jsx("button",{onClick:()=>N(null),className:"text-neutral-400 hover:text-neutral-600",children:s.jsx(H,{className:"h-4 w-4"})})]}),s.jsxs("div",{className:"flex gap-2",children:[s.jsx("button",{onClick:()=>{var e;return(e=M.current)==null?void 0:e.click()},disabled:w,className:"p-2 text-neutral-600 hover:text-primary-600 hover:bg-primary-50 rounded transition-colors disabled:opacity-50",children:w?s.jsx(y,{className:"h-5 w-5 animate-spin"}):s.jsx(J,{className:"h-5 w-5"})}),s.jsx("input",{ref:M,type:"file",className:"hidden",onChange:z}),s.jsx("textarea",{ref:O,value:f,onChange:e=>v(e.target.value),onKeyPress:A,placeholder:"Напишите сообщение...",rows:1,className:"flex-1 input-field resize-none"}),s.jsx("button",{onClick:k,disabled:!f.trim()&&!o||g.isLoading,className:"btn-primary px-4 py-2 disabled:opacity-50 disabled:cursor-not-allowed",children:g.isLoading?s.jsx(y,{className:"h-5 w-5 animate-spin"}):s.jsx(V,{className:"h-5 w-5"})})]}),s.jsx(_,{isOpen:E.isOpen,message:E.message,onClose:()=>u({isOpen:!1,message:""})})]}):s.jsxs("div",{className:"card p-12 text-center",children:[s.jsx("h3",{className:"text-xl font-semibold text-neutral-700 mb-2",children:"Чат не найден"}),s.jsx("button",{onClick:()=>b("/teacher/classes"),className:"btn-primary mt-4",children:"Вернуться к классам"})]})}export{ae as default};
