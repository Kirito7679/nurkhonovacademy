#!/bin/bash

# –°–∫—Ä–∏–ø—Ç –¥–ª—è –ø–æ–¥–≥–æ—Ç–æ–≤–∫–∏ –ø–æ–ª–Ω–æ—Å—Ç—å—é –≥–æ—Ç–æ–≤–æ–≥–æ –ø–∞–∫–µ—Ç–∞ –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ –Ω–∞ —Å–µ—Ä–≤–µ—Ä

echo "üì¶ –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –ø–æ–ª–Ω–æ—Å—Ç—å—é –≥–æ—Ç–æ–≤–æ–≥–æ –ø–∞–∫–µ—Ç–∞..."
echo ""

# –¶–≤–µ—Ç–∞
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m'

# –°–æ–∑–¥–∞–µ–º –ø–∞–ø–∫—É –¥–ª—è –≥–æ—Ç–æ–≤–æ–≥–æ –ø–∞–∫–µ—Ç–∞
PACKAGE_DIR="READY_TO_UPLOAD"
rm -rf "$PACKAGE_DIR"
mkdir -p "$PACKAGE_DIR"

echo "1Ô∏è‚É£  –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥–∞..."

cd frontend

# –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ .env.production
if [ ! -f ".env.production" ]; then
    echo -e "${YELLOW}‚ö†Ô∏è  –°–æ–∑–¥–∞—é .env.production...${NC}"
    echo "VITE_API_URL=https://academy.dilmurodnukhonov.uz/api" > .env.production
fi

# –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –µ—Å–ª–∏ –Ω—É–∂–Ω–æ
if [ ! -d "node_modules" ]; then
    echo "üì• –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥–∞..."
    npm install > /dev/null 2>&1
fi

# –°–æ–±–∏—Ä–∞–µ–º –ø—Ä–æ–µ–∫—Ç
echo "üî® –°–±–æ—Ä–∫–∞ —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥–∞..."
npm run build:skip-check > /dev/null 2>&1 || npx vite build > /dev/null 2>&1

if [ $? -eq 0 ]; then
    echo -e "${GREEN}‚úÖ –§—Ä–æ–Ω—Ç–µ–Ω–¥ —Å–æ–±—Ä–∞–Ω${NC}"
else
    echo "‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–±–æ—Ä–∫–µ —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥–∞!"
    exit 1
fi

# –ö–æ–ø–∏—Ä—É–µ–º —Ñ–∞–π–ª—ã —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥–∞ –≤ –∫–æ—Ä–µ–Ω—å –ø–∞–∫–µ—Ç–∞
echo "üìã –ö–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ —Ñ–∞–π–ª–æ–≤ —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥–∞..."
cp -r dist/* "../$PACKAGE_DIR/"
cp .htaccess "../$PACKAGE_DIR/" 2>/dev/null || {
    cat > "../$PACKAGE_DIR/.htaccess" << 'EOF'
<IfModule mod_rewrite.c>
  RewriteEngine On
  
  # –ï—Å–ª–∏ —Ñ–∞–π–ª –∏–ª–∏ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—è —Å—É—â–µ—Å—Ç–≤—É—é—Ç, –∏—Å–ø–æ–ª—å–∑—É–µ–º –∏—Ö
  RewriteCond %{REQUEST_FILENAME} !-f
  RewriteCond %{REQUEST_FILENAME} !-d
  
  # –ò–Ω–∞—á–µ –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª—è–µ–º –Ω–∞ index.html –¥–ª—è SPA —Ä–æ—É—Ç–∏–Ω–≥–∞
  RewriteRule . /index.html [L]
</IfModule>
EOF
}

cd ..

echo ""
echo "2Ô∏è‚É£  –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –±—ç–∫–µ–Ω–¥–∞..."

cd backend

# –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –µ—Å–ª–∏ –Ω—É–∂–Ω–æ
if [ ! -d "node_modules" ]; then
    echo "üì• –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π –±—ç–∫–µ–Ω–¥–∞..."
    npm install > /dev/null 2>&1
fi

# –°–æ–±–∏—Ä–∞–µ–º –±—ç–∫–µ–Ω–¥
echo "üî® –°–±–æ—Ä–∫–∞ –±—ç–∫–µ–Ω–¥–∞..."
npm run build > /dev/null 2>&1 || {
    echo -e "${YELLOW}‚ö†Ô∏è  –ï—Å—Ç—å –æ—à–∏–±–∫–∏ TypeScript, –Ω–æ –ø—Ä–æ–¥–æ–ª–∂–∞–µ–º...${NC}"
}

# –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º Prisma Client
echo "üîß –ì–µ–Ω–µ—Ä–∞—Ü–∏—è Prisma Client..."
npx prisma generate > /dev/null 2>&1

# –°–æ–∑–¥–∞–µ–º –ø–∞–ø–∫—É backend-api –≤ –ø–∞–∫–µ—Ç–µ
mkdir -p "../$PACKAGE_DIR/backend-api"

# –ö–æ–ø–∏—Ä—É–µ–º —Ñ–∞–π–ª—ã –±—ç–∫–µ–Ω–¥–∞
echo "üìã –ö–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ —Ñ–∞–π–ª–æ–≤ –±—ç–∫–µ–Ω–¥–∞..."
cp -r dist "../$PACKAGE_DIR/backend-api/" 2>/dev/null || true
cp -r prisma "../$PACKAGE_DIR/backend-api/" 2>/dev/null || true
cp package.json "../$PACKAGE_DIR/backend-api/" 2>/dev/null || true

# –°–æ–∑–¥–∞–µ–º –≥–æ—Ç–æ–≤—ã–π .env —Ñ–∞–π–ª
echo "üìù –°–æ–∑–¥–∞–Ω–∏–µ —Ñ–∞–π–ª–∞ .env..."
cat > "../$PACKAGE_DIR/backend-api/.env" << 'EOF'
DATABASE_URL="file:./prisma/dev.db"
JWT_SECRET="nurkhonov-academy-secret-key-2024-change-this-in-production"
PORT=5001
NODE_ENV=production
EOF

cd ..

echo ""
echo "3Ô∏è‚É£  –°–æ–∑–¥–∞–Ω–∏–µ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–π..."

# –°–æ–∑–¥–∞–µ–º –ø—Ä–æ—Å—Ç—É—é –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—é
cat > "$PACKAGE_DIR/–ò–ù–°–¢–†–£–ö–¶–ò–Ø.txt" << 'EOF'
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  ‚úÖ –ì–û–¢–û–í–´–ô –ü–ê–ö–ï–¢ –î–õ–Ø –ó–ê–ì–†–£–ó–ö–ò –ù–ê –°–ï–†–í–ï–†
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

üì¶ –ß–¢–û –î–ï–õ–ê–¢–¨:

1Ô∏è‚É£  –ó–ê–ì–†–£–ó–ò–¢–¨ –í–°–Å –°–û–î–ï–†–ñ–ò–ú–û–ï —ç—Ç–æ–π –ø–∞–ø–∫–∏ –≤:
    ‚Üí public_html/academy/ (–∏–ª–∏ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é –≤–∞—à–µ–≥–æ –ø–æ–¥–¥–æ–º–µ–Ω–∞)

2Ô∏è‚É£  –ù–ê–°–¢–†–û–ò–¢–¨ NODE.JS –ü–†–ò–õ–û–ñ–ï–ù–ò–ï:
    - –í –ø–∞–Ω–µ–ª–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Ö–æ—Å—Ç–∏–Ω–≥–æ–º
    - –†–∞–∑–¥–µ–ª "Node.js –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è"
    - –°–æ–∑–¥–∞—Ç—å –Ω–æ–≤–æ–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ:
      * –ü—É—Ç—å: backend-api/dist/app.js
      * –ü–æ—Ä—Ç: –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏
      * –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è: –∏–∑ backend-api/.env

3Ô∏è‚É£  –£–°–¢–ê–ù–û–í–ò–¢–¨ –ó–ê–í–ò–°–ò–ú–û–°–¢–ò –ë–≠–ö–ï–ù–î–ê:
    –ß–µ—Ä–µ–∑ SSH –∏–ª–∏ Terminal:
    cd backend-api
    npm install --production
    npx prisma migrate deploy
    npx prisma generate

4Ô∏è‚É£  –ü–†–û–í–ï–†–ò–¢–¨:
    https://academy.dilmurodnukhonov.uz/api/health
    –î–æ–ª–∂–Ω–æ –≤–µ—Ä–Ω—É—Ç—å: {"success":true,"message":"Server is running"}

‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  –°–¢–†–£–ö–¢–£–†–ê –ü–ê–ö–ï–¢–ê:
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

üìÅ READY_TO_UPLOAD/
‚îú‚îÄ‚îÄ index.html          ‚Üê –§—Ä–æ–Ω—Ç–µ–Ω–¥
‚îú‚îÄ‚îÄ .htaccess          ‚Üê –î–ª—è —Ä–æ—É—Ç–∏–Ω–≥–∞
‚îú‚îÄ‚îÄ assets/            ‚Üê –§—Ä–æ–Ω—Ç–µ–Ω–¥ (—Å—Ç–∏–ª–∏ –∏ —Å–∫—Ä–∏–ø—Ç—ã)
‚îî‚îÄ‚îÄ backend-api/        ‚Üê –ë—ç–∫–µ–Ω–¥
    ‚îú‚îÄ‚îÄ dist/          ‚Üê –ö–æ–¥ —Å–µ—Ä–≤–µ—Ä–∞
    ‚îú‚îÄ‚îÄ prisma/        ‚Üê –ú–∏–≥—Ä–∞—Ü–∏–∏ –∏ —Å—Ö–µ–º–∞
    ‚îú‚îÄ‚îÄ package.json   ‚Üê –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
    ‚îî‚îÄ‚îÄ .env           ‚Üê –ù–∞—Å—Ç—Ä–æ–π–∫–∏ (–≥–æ—Ç–æ–≤—ã–π!)

‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

‚ö†Ô∏è  –í–ê–ñ–ù–û:
   - –ó–∞–≥—Ä—É–∂–∞–π—Ç–µ –í–°–Å —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ —ç—Ç–æ–π –ø–∞–ø–∫–∏
   - –ù–µ —Å–æ–∑–¥–∞–≤–∞–π—Ç–µ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –ø–∞–ø–∫–∏
   - –§–∞–π–ª .env —É–∂–µ –≥–æ—Ç–æ–≤, –Ω–æ –º–æ–∂–Ω–æ –∏–∑–º–µ–Ω–∏—Ç—å JWT_SECRET

‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
EOF

echo ""
echo -e "${GREEN}‚ú® –ì–æ—Ç–æ–≤–æ!${NC}"
echo ""
echo "üìÅ –ü–∞–∫–µ—Ç –ø–æ–¥–≥–æ—Ç–æ–≤–ª–µ–Ω –≤ –ø–∞–ø–∫–µ: $PACKAGE_DIR"
echo ""
echo "üìã –°—Ç—Ä—É–∫—Ç—É—Ä–∞:"
echo "   $PACKAGE_DIR/"
echo "   ‚îú‚îÄ‚îÄ index.html"
echo "   ‚îú‚îÄ‚îÄ .htaccess"
echo "   ‚îú‚îÄ‚îÄ assets/"
echo "   ‚îî‚îÄ‚îÄ backend-api/"
echo "       ‚îú‚îÄ‚îÄ dist/"
echo "       ‚îú‚îÄ‚îÄ prisma/"
echo "       ‚îú‚îÄ‚îÄ package.json"
echo "       ‚îî‚îÄ‚îÄ .env (–≥–æ—Ç–æ–≤—ã–π!)"
echo ""
echo "üöÄ –ü—Ä–æ—Å—Ç–æ –∑–∞–≥—Ä—É–∑–∏—Ç–µ –í–°–Å —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ –ø–∞–ø–∫–∏ $PACKAGE_DIR/ –Ω–∞ —Å–µ—Ä–≤–µ—Ä!"
echo ""

