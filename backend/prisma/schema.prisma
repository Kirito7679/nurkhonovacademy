// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id            String   @id @default(uuid())
  firstName     String
  lastName      String
  phone         String   @unique
  email         String?
  password      String
  avatarUrl     String?
  telegram      String? // Telegram username or link
  role          String   @default("STUDENT") // STUDENT, TEACHER, ADMIN, MODERATOR, ASSISTANT, CURATOR
  language      String   @default("ru") // ru, en, uz, kk - язык интерфейса
  isPaidTeacher Boolean  @default(false) // Оплачена ли регистрация учителя
  coins         Int      @default(0) // Коины для геймификации
  city          String? // Город
  region        String? // Регион
  country       String? // Страна
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  // Relations
  coursesAsTeacher  Course[]            @relation("CourseTeacher")
  studentCourses    StudentCourse[]
  progress          StudentProgress[]
  comments          Comment[]
  notifications     Notification[]
  quizResults       QuizResult[]
  sentMessages      Message[]           @relation("MessageSender")
  receivedMessages  Message[]           @relation("MessageReceiver")
  activityLogs      ActivityLog[]
  flashcardDecks    FlashcardDeck[]
  flashcardProgress FlashcardProgress[]
  practiceResults   PracticeResult[]

  // Group Classes relations
  teacherClasses Class[]        @relation("TeacherClasses")
  studentClasses ClassStudent[] @relation("StudentClasses")
  classMessages  ClassMessage[] @relation("ClassMessageSender")

  // Intermediate tests
  intermediateTestResults IntermediateTestResult[] @relation("IntermediateTestResults")

  // Story views
  storyViews StoryView[] @relation("StoryViews")

  @@map("users")
}

model Course {
  id               String   @id @default(uuid())
  title            String
  description      String?
  thumbnailUrl     String?
  price            Float    @default(0)
  trialLessonId    String?
  teacherId        String
  isVisible        Boolean  @default(true) // Видим ли курс для студентов (если false, виден только назначенным студентам)
  language         String   @default("ru") // ru, en, uz, kk - язык курса
  subscriptionType String? // FREE, TRIAL, PAID - тип подписки
  trialPeriodDays  Int? // Количество дней пробного периода
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  // Relations
  teacher           User                  @relation("CourseTeacher", fields: [teacherId], references: [id], onDelete: Cascade)
  modules           Module[]
  lessons           Lesson[]
  studentCourses    StudentCourse[]
  flashcardDecks    FlashcardDeck[]
  integrations      ExternalIntegration[]
  intermediateTests IntermediateTest[]

  @@map("courses")
}

model Module {
  id          String   @id @default(uuid())
  courseId    String
  title       String
  description String?
  order       Int      @default(0)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  course  Course   @relation(fields: [courseId], references: [id], onDelete: Cascade)
  lessons Lesson[]

  @@index([courseId])
  @@map("modules")
}

model Lesson {
  id          String   @id @default(uuid())
  courseId    String
  moduleId    String? // Optional for backward compatibility
  title       String
  description String?
  order       Int      @default(0)
  videoUrl    String? // YouTube embed URL
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  course            Course                @relation(fields: [courseId], references: [id], onDelete: Cascade)
  module            Module?               @relation(fields: [moduleId], references: [id], onDelete: SetNull)
  files             LessonFile[]
  progress          StudentProgress[]
  comments          Comment[]
  quiz              Quiz?
  flashcardDecks    FlashcardDeck[]
  practiceExercises PracticeExercise[]
  integrations      ExternalIntegration[]

  @@index([courseId])
  @@index([moduleId])
  @@map("lessons")
}

model LessonFile {
  id        String   @id @default(uuid())
  lessonId  String
  fileName  String
  fileUrl   String
  fileSize  Int // in bytes
  createdAt DateTime @default(now())

  // Relations
  lesson Lesson @relation(fields: [lessonId], references: [id], onDelete: Cascade)

  @@index([lessonId])
  @@map("lesson_files")
}

model StudentCourse {
  id                  String    @id @default(uuid())
  studentId           String
  courseId            String
  status              String    @default("PENDING") // PENDING, APPROVED, REJECTED
  purchaseRequestedAt DateTime  @default(now())
  approvedAt          DateTime?
  approvedBy          String? // teacherId who approved
  accessStartDate     DateTime? // Дата начала доступа к курсу
  accessEndDate       DateTime? // Дата окончания доступа к курсу (null = бессрочный доступ)

  // Relations
  student User   @relation(fields: [studentId], references: [id], onDelete: Cascade)
  course  Course @relation(fields: [courseId], references: [id], onDelete: Cascade)

  @@unique([studentId, courseId])
  @@index([studentId])
  @@index([courseId])
  @@map("student_courses")
}

model StudentProgress {
  id           String    @id @default(uuid())
  studentId    String
  lessonId     String
  completed    Boolean   @default(false)
  watchedAt    DateTime?
  lastPosition Int?      @default(0) // video position in seconds

  // Relations
  student User   @relation(fields: [studentId], references: [id], onDelete: Cascade)
  lesson  Lesson @relation(fields: [lessonId], references: [id], onDelete: Cascade)

  @@unique([studentId, lessonId])
  @@index([studentId])
  @@index([lessonId])
  @@map("student_progress")
}

model Comment {
  id        String   @id @default(uuid())
  lessonId  String
  userId    String
  content   String
  parentId  String? // For replies (null for top-level comments)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  lesson  Lesson    @relation(fields: [lessonId], references: [id], onDelete: Cascade)
  user    User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  parent  Comment?  @relation("CommentReplies", fields: [parentId], references: [id], onDelete: Cascade)
  replies Comment[] @relation("CommentReplies")

  @@index([lessonId])
  @@index([userId])
  @@index([parentId])
  @@map("comments")
}

model Notification {
  id        String   @id @default(uuid())
  userId    String // User who should receive the notification
  type      String // COMMENT, COURSE_REQUEST, COURSE_APPROVED, COURSE_REJECTED
  title     String
  message   String
  link      String? // URL to navigate to
  read      Boolean  @default(false)
  createdAt DateTime @default(now())

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([read])
  @@index([createdAt])
  @@map("notifications")
}

model Quiz {
  id           String   @id @default(uuid())
  lessonId     String   @unique
  title        String?
  description  String?
  passingScore Int      @default(70) // Minimum score percentage to pass
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  // Relations
  lesson    Lesson         @relation(fields: [lessonId], references: [id], onDelete: Cascade)
  questions QuizQuestion[]
  results   QuizResult[]

  @@index([lessonId])
  @@map("quizzes")
}

model QuizQuestion {
  id        String   @id @default(uuid())
  quizId    String
  question  String
  type      String   @default("MULTIPLE_CHOICE") // MULTIPLE_CHOICE, TRUE_FALSE, DRAG_DROP, MATCHING, FILL_BLANK
  order     Int      @default(0)
  metadata  String? // JSON string for complex question data (drag-drop items, matching pairs, etc.)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  quiz          Quiz         @relation(fields: [quizId], references: [id], onDelete: Cascade)
  options       QuizOption[]
  correctAnswer String? // For TRUE_FALSE: "true" or "false", for others: JSON string

  @@index([quizId])
  @@map("quiz_questions")
}

model QuizOption {
  id         String   @id @default(uuid())
  questionId String
  text       String
  isCorrect  Boolean  @default(false)
  order      Int      @default(0)
  createdAt  DateTime @default(now())

  // Relations
  question QuizQuestion @relation(fields: [questionId], references: [id], onDelete: Cascade)

  @@index([questionId])
  @@map("quiz_options")
}

model QuizResult {
  id          String   @id @default(uuid())
  quizId      String
  studentId   String
  score       Int // Percentage score
  passed      Boolean  @default(false)
  answers     String // JSON string of student answers
  completedAt DateTime @default(now())

  // Relations
  quiz    Quiz @relation(fields: [quizId], references: [id], onDelete: Cascade)
  student User @relation(fields: [studentId], references: [id], onDelete: Cascade)

  @@index([quizId])
  @@index([studentId])
  @@index([completedAt])
  @@map("quiz_results")
}

model Message {
  id         String    @id @default(uuid())
  senderId   String
  receiverId String
  content    String
  fileUrl    String? // URL to attached file
  fileName   String? // Original filename
  fileSize   Int? // File size in bytes
  read       Boolean   @default(false)
  readAt     DateTime?
  createdAt  DateTime  @default(now())

  // Relations
  sender   User @relation("MessageSender", fields: [senderId], references: [id], onDelete: Cascade)
  receiver User @relation("MessageReceiver", fields: [receiverId], references: [id], onDelete: Cascade)

  @@index([senderId])
  @@index([receiverId])
  @@index([createdAt])
  @@index([senderId, receiverId])
  @@map("messages")
}

model ActivityLog {
  id         String   @id @default(uuid())
  userId     String
  action     String // CREATE, UPDATE, DELETE, LOGIN, LOGOUT, VIEW, etc.
  entityType String? // COURSE, LESSON, USER, etc.
  entityId   String? // ID of the affected entity
  details    String? // JSON string with additional details
  ipAddress  String?
  userAgent  String?
  createdAt  DateTime @default(now())

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([action])
  @@index([entityType])
  @@index([createdAt])
  @@index([userId, createdAt])
  @@map("activity_logs")
}

model FlashcardDeck {
  id          String   @id @default(uuid())
  courseId    String?
  lessonId    String?
  title       String
  description String?
  createdBy   String
  isPublic    Boolean  @default(false)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  course     Course?             @relation(fields: [courseId], references: [id], onDelete: SetNull)
  lesson     Lesson?             @relation(fields: [lessonId], references: [id], onDelete: SetNull)
  creator    User                @relation(fields: [createdBy], references: [id], onDelete: Cascade)
  flashcards Flashcard[]
  progress   FlashcardProgress[]

  @@index([courseId])
  @@index([lessonId])
  @@index([createdBy])
  @@map("flashcard_decks")
}

model Flashcard {
  id        String   @id @default(uuid())
  deckId    String
  front     String // Front side of the card
  back      String // Back side of the card
  order     Int      @default(0)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  deck     FlashcardDeck       @relation(fields: [deckId], references: [id], onDelete: Cascade)
  progress FlashcardProgress[]

  @@index([deckId])
  @@map("flashcards")
}

model FlashcardProgress {
  id           String    @id @default(uuid())
  userId       String
  deckId       String
  cardId       String
  difficulty   String    @default("NEW") // NEW, EASY, MEDIUM, HARD
  lastReviewed DateTime?
  nextReview   DateTime?
  reviewCount  Int       @default(0)
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt

  // Relations
  user User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  deck FlashcardDeck @relation(fields: [deckId], references: [id], onDelete: Cascade)
  card Flashcard     @relation(fields: [cardId], references: [id], onDelete: Cascade)

  @@unique([userId, cardId])
  @@index([userId])
  @@index([deckId])
  @@index([cardId])
  @@index([nextReview])
  @@map("flashcard_progress")
}

model PracticeExercise {
  id           String   @id @default(uuid())
  lessonId     String
  title        String
  description  String?
  type         String // CODING, WRITING, SPEAKING, LISTENING, etc.
  instructions String
  solution     String? // Expected solution or answer
  autoCheck    Boolean  @default(false) // Can be automatically checked
  maxAttempts  Int      @default(3)
  order        Int      @default(0)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  // Relations
  lesson  Lesson           @relation(fields: [lessonId], references: [id], onDelete: Cascade)
  results PracticeResult[]

  @@index([lessonId])
  @@map("practice_exercises")
}

model PracticeResult {
  id            String    @id @default(uuid())
  exerciseId    String
  studentId     String
  answer        String // Student's answer
  score         Int? // Score if auto-checked
  feedback      String? // Automated or manual feedback
  status        String    @default("SUBMITTED") // SUBMITTED, REVIEWED, APPROVED, REJECTED
  reviewedBy    String? // Teacher/Moderator who reviewed
  reviewedAt    DateTime?
  attemptNumber Int       @default(1)
  submittedAt   DateTime  @default(now())

  // Relations
  exercise PracticeExercise @relation(fields: [exerciseId], references: [id], onDelete: Cascade)
  student  User             @relation(fields: [studentId], references: [id], onDelete: Cascade)

  @@index([exerciseId])
  @@index([studentId])
  @@index([status])
  @@index([submittedAt])
  @@map("practice_results")
}

model ExternalIntegration {
  id          String   @id @default(uuid())
  userId      String?
  courseId    String?
  lessonId    String?
  type        String // GOOGLE_DOCS, QUIZLET, YOUTUBE, etc.
  externalId  String // ID in external service
  externalUrl String // URL to external resource
  metadata    String? // JSON string with additional data
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  course Course? @relation(fields: [courseId], references: [id], onDelete: SetNull)
  lesson Lesson? @relation(fields: [lessonId], references: [id], onDelete: SetNull)

  @@index([userId])
  @@index([courseId])
  @@index([lessonId])
  @@index([type])
  @@map("external_integrations")
}

// Group Classes Models
model Class {
  id          String  @id @default(uuid())
  name        String // "Английский для начинающих - Группа A"
  description String? // Описание класса
  teacherId   String
  teacher     User    @relation("TeacherClasses", fields: [teacherId], references: [id], onDelete: Cascade)

  // Настройки
  maxStudents Int         @default(10)
  level       String? // "Beginner", "Intermediate", "Advanced"
  language    String? // "English", "Russian", etc.
  status      ClassStatus @default(ACTIVE) // ACTIVE, COMPLETED, CANCELLED, ARCHIVED

  // Связи
  students ClassStudent[]
  messages ClassMessage[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([teacherId])
  @@index([status])
  @@map("classes")
}

enum ClassStatus {
  ACTIVE
  COMPLETED
  CANCELLED
  ARCHIVED
}

// Студенты в классе
model ClassStudent {
  id        String @id @default(uuid())
  classId   String
  class     Class  @relation(fields: [classId], references: [id], onDelete: Cascade)
  studentId String
  student   User   @relation("StudentClasses", fields: [studentId], references: [id], onDelete: Cascade)

  // Статус
  status     EnrollmentStatus @default(PENDING) // PENDING, APPROVED, REJECTED
  enrolledAt DateTime         @default(now())
  approvedAt DateTime?

  @@unique([classId, studentId])
  @@index([classId])
  @@index([studentId])
  @@index([status])
  @@map("class_students")
}

enum EnrollmentStatus {
  PENDING
  APPROVED
  REJECTED
}

// Групповой чат класса
model ClassMessage {
  id        String   @id @default(uuid())
  classId   String
  class     Class    @relation(fields: [classId], references: [id], onDelete: Cascade)
  senderId  String
  sender    User     @relation("ClassMessageSender", fields: [senderId], references: [id], onDelete: Cascade)
  content   String
  fileUrl   String? // URL к прикрепленному файлу
  fileName  String? // Оригинальное имя файла
  fileSize  Int? // Размер файла в байтах
  createdAt DateTime @default(now())

  @@index([classId])
  @@index([senderId])
  @@index([createdAt])
  @@map("class_messages")
}

// Промежуточные тесты
model IntermediateTest {
  id           String   @id @default(uuid())
  courseId     String
  title        String
  description  String?
  order        Int      @default(0)
  passingScore Int      @default(70) // Процент для прохождения
  timeLimit    Int? // Лимит времени в минутах (опционально)
  isActive     Boolean  @default(true)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  course    Course                     @relation(fields: [courseId], references: [id], onDelete: Cascade)
  questions IntermediateTestQuestion[]
  results   IntermediateTestResult[]

  @@index([courseId])
  @@map("intermediate_tests")
}

model IntermediateTestQuestion {
  id        String   @id @default(uuid())
  testId    String
  question  String
  type      String   @default("SINGLE") // SINGLE, MULTIPLE, TEXT
  order     Int      @default(0)
  points    Int      @default(1)
  createdAt DateTime @default(now())

  test    IntermediateTest         @relation(fields: [testId], references: [id], onDelete: Cascade)
  options IntermediateTestOption[]
  answers IntermediateTestAnswer[]

  @@index([testId])
  @@map("intermediate_test_questions")
}

model IntermediateTestOption {
  id         String   @id @default(uuid())
  questionId String
  text       String
  isCorrect  Boolean  @default(false)
  order      Int      @default(0)
  createdAt  DateTime @default(now())

  question IntermediateTestQuestion @relation(fields: [questionId], references: [id], onDelete: Cascade)

  @@index([questionId])
  @@map("intermediate_test_options")
}

model IntermediateTestResult {
  id         String   @id @default(uuid())
  testId     String
  studentId  String
  score      Int // Количество баллов
  percentage Float // Процент правильных ответов
  passed     Boolean // Прошел ли тест
  timeSpent  Int? // Время прохождения в секундах
  createdAt  DateTime @default(now())

  test    IntermediateTest         @relation(fields: [testId], references: [id], onDelete: Cascade)
  student User                     @relation("IntermediateTestResults", fields: [studentId], references: [id], onDelete: Cascade)
  answers IntermediateTestAnswer[]

  @@index([testId])
  @@index([studentId])
  @@map("intermediate_test_results")
}

model IntermediateTestAnswer {
  id         String   @id @default(uuid())
  resultId   String
  questionId String
  optionIds  String[] // ID выбранных опций (для множественного выбора)
  textAnswer String? // Текстовый ответ (для текстовых вопросов)
  isCorrect  Boolean
  points     Int      @default(0)
  createdAt  DateTime @default(now())

  result   IntermediateTestResult   @relation(fields: [resultId], references: [id], onDelete: Cascade)
  question IntermediateTestQuestion @relation(fields: [questionId], references: [id], onDelete: Cascade)

  @@index([resultId])
  @@index([questionId])
  @@map("intermediate_test_answers")
}

// Сторисы
model Story {
  id        String    @id @default(uuid())
  title     String?
  imageUrl  String
  videoUrl  String?
  link      String? // Ссылка при клике на сторис
  isActive  Boolean   @default(true)
  expiresAt DateTime? // Дата истечения сториса
  order     Int       @default(0)
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt

  views StoryView[]

  @@index([isActive, expiresAt])
  @@map("stories")
}

model StoryView {
  id       String   @id @default(uuid())
  storyId  String
  userId   String
  viewedAt DateTime @default(now())

  story Story @relation(fields: [storyId], references: [id], onDelete: Cascade)
  user  User  @relation("StoryViews", fields: [userId], references: [id], onDelete: Cascade)

  @@unique([storyId, userId])
  @@index([storyId])
  @@index([userId])
  @@map("story_views")
}

// Баннеры
model Banner {
  id        String    @id @default(uuid())
  title     String?
  imageUrl  String
  link      String? // Ссылка при клике на баннер
  position  String    @default("TOP") // TOP, BOTTOM, SIDEBAR
  isActive  Boolean   @default(true)
  order     Int       @default(0)
  startDate DateTime? // Дата начала показа
  endDate   DateTime? // Дата окончания показа
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt

  @@index([isActive, position])
  @@map("banners")
}
