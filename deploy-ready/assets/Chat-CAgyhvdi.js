import{u as _,f as q,r,h as k,k as L,j as e,am as W,ak as F,M as V,ao as X,aD as I,X as G,aE as J,S as Y}from"./vendor-react-BKQy8cua.js";import{u as Z,a as N,A as ee}from"./index-B1iTD4yI.js";import{E as te}from"./ErrorModal-DDNSR7rT.js";import"./vendor-other-Bzl34R3H.js";import"./vendor-network-CoR7wtyb.js";import"./vendor-i18n-DHwuzpMN.js";import"./vendor-state-BcnB54Y8.js";function ce(){const O=_(),{user:j}=Z(),z=q(),[f,M]=r.useState(""),[l,w]=r.useState(null),[b,y]=r.useState(!1),[p,d]=r.useState(null),o=r.useRef(null),x=r.useRef(null),U=r.useRef(null),[C,v]=r.useState({isOpen:!1,message:""}),{data:A}=k(["studentTeacher"],async()=>(await N.get("/messages/student/teacher")).data.data),a=A,{data:i,isLoading:B}=k(["chat",a==null?void 0:a.id],async()=>a!=null&&a.id?(await N.get(`/messages/chat/${a.id}`)).data.data:null,{enabled:!!(a!=null&&a.id),refetchInterval:1e4,refetchOnWindowFocus:!1}),P=L(async t=>{const s=new FormData;return s.append("file",t),(await N.post("/messages/upload-file",s,{headers:{"Content-Type":"multipart/form-data"},onUploadProgress:u=>{if(u.total){const g=Math.round(u.loaded*100/u.total);d({fileName:t.name,progress:g})}}})).data.data}),h=L(async t=>{if(!(a!=null&&a.id))throw new Error("Ğ£Ñ‡Ğ¸Ñ‚ĞµĞ»ÑŒ Ğ½Ğµ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½");return(await N.post("/messages/send",{receiverId:a.id,...t})).data.data},{onSuccess:()=>{z.invalidateQueries(["chat",a==null?void 0:a.id]),M(""),w(null),d(null),o.current&&(o.current.value=""),x.current&&(x.current.style.height="auto")}}),m=r.useCallback(()=>{const t=x.current;if(t){t.style.height="auto";const s=Math.min(t.scrollHeight,120);t.style.height=`${s}px`}},[]),R=t=>{M(t.target.value),setTimeout(()=>m(),0)};r.useEffect(()=>{x.current&&m()},[a==null?void 0:a.id,m]),r.useEffect(()=>{m()},[f,m]);const T=()=>{var t;(t=U.current)==null||t.scrollIntoView({behavior:"smooth"})};r.useEffect(()=>{T()},[i==null?void 0:i.messages]);const H=async t=>{var n,u,g;const s=(n=t.target.files)==null?void 0:n[0];if(s){if(s.size>50*1024*1024){v({isOpen:!0,message:"Ğ Ğ°Ğ·Ğ¼ĞµÑ€ Ñ„Ğ°Ğ¹Ğ»Ğ° Ğ½Ğµ Ğ´Ğ¾Ğ»Ğ¶ĞµĞ½ Ğ¿Ñ€ĞµĞ²Ñ‹ÑˆĞ°Ñ‚ÑŒ 50MB"});return}y(!0),d({fileName:s.name,progress:0});try{const S=await P.mutateAsync(s);w({file:s,url:S.fileUrl}),d(null)}catch(S){v({isOpen:!0,message:((g=(u=S.response)==null?void 0:u.data)==null?void 0:g.message)||"ĞÑˆĞ¸Ğ±ĞºĞ° Ğ¿Ñ€Ğ¸ Ğ·Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞµ Ñ„Ğ°Ğ¹Ğ»Ğ°"}),d(null)}finally{y(!1)}}},K=()=>{w(null),o.current&&(o.current.value="")},$=async t=>{if(t.preventDefault(),!f.trim()&&!l||h.isLoading)return;const s={content:f.trim()||(l?"ğŸ“ Ğ¤Ğ°Ğ¹Ğ»":"")};l&&(s.fileUrl=l.url,s.fileName=l.file.name,s.fileSize=l.file.size),h.mutate(s)},E=t=>t<1024?t+" B":t<1024*1024?(t/1024).toFixed(1)+" KB":(t/(1024*1024)).toFixed(1)+" MB",Q=t=>{var s;return(s=t.split(".").pop())==null||s.toLowerCase(),e.jsx(I,{className:"h-4 w-4"})};if(!a)return e.jsxs("div",{className:"text-center py-12 animate-fade-scale",children:[e.jsx("p",{className:"text-neutral-600 mb-4",children:"Ğ£ Ğ²Ğ°Ñ Ğ¿Ğ¾ĞºĞ° Ğ½ĞµÑ‚ Ğ¿Ñ€ĞµĞ¿Ğ¾Ğ´Ğ°Ğ²Ğ°Ñ‚ĞµĞ»Ñ"}),e.jsx("p",{className:"text-sm text-neutral-500",children:"ĞŸĞ¾ÑĞ»Ğµ Ğ¾Ğ´Ğ¾Ğ±Ñ€ĞµĞ½Ğ¸Ñ Ğ´Ğ¾ÑÑ‚ÑƒĞ¿Ğ° Ğº ĞºÑƒÑ€ÑÑƒ Ğ²Ñ‹ ÑĞ¼Ğ¾Ğ¶ĞµÑ‚Ğµ Ğ¾Ğ±Ñ‰Ğ°Ñ‚ÑŒÑÑ Ñ Ğ¿Ñ€ĞµĞ¿Ğ¾Ğ´Ğ°Ğ²Ğ°Ñ‚ĞµĞ»ĞµĞ¼"})]});const D=(i==null?void 0:i.messages)||[],c=(i==null?void 0:i.user)||a;return e.jsxs("div",{className:"flex flex-col h-[calc(100vh-8rem)] animate-fade-scale",children:[e.jsxs("div",{className:"card p-4 mb-4 flex items-center gap-3 border-b-2 border-primary-200 bg-gradient-to-r from-white to-blue-50/30 shadow-sm",children:[e.jsx("button",{onClick:()=>O("/dashboard"),className:"p-2.5 text-neutral-600 hover:text-primary-600 hover:bg-primary-50 rounded-xl transition-all duration-200 active:scale-95",children:e.jsx(W,{className:"h-5 w-5"})}),e.jsxs("div",{className:"flex items-center gap-3 flex-1",children:[c.avatarUrl?e.jsx("img",{src:c.avatarUrl,alt:`${c.firstName} ${c.lastName}`,className:"w-12 h-12 rounded-full object-cover ring-2 ring-primary-200 shadow-sm"}):e.jsx("div",{className:"w-12 h-12 rounded-full bg-gradient-to-br from-blue-500 to-purple-600 text-white flex items-center justify-center font-bold text-lg shadow-md ring-2 ring-primary-200",children:c.firstName[0]}),e.jsxs("div",{children:[e.jsxs("h2",{className:"font-semibold text-neutral-900 text-lg",children:[c.firstName," ",c.lastName]}),e.jsx("p",{className:"text-xs text-neutral-600 font-medium",children:"ĞŸÑ€ĞµĞ¿Ğ¾Ğ´Ğ°Ğ²Ğ°Ñ‚ĞµĞ»ÑŒ"})]})]})]}),e.jsxs("div",{className:"flex-1 overflow-y-auto space-y-3 mb-4 px-4 bg-gradient-to-b from-neutral-50/50 to-white",children:[B?e.jsx("div",{className:"flex justify-center py-8",children:e.jsx(F,{className:"h-6 w-6 animate-spin text-primary-500"})}):D.length===0?e.jsxs("div",{className:"text-center py-12 text-neutral-500",children:[e.jsx(V,{className:"h-16 w-16 mx-auto mb-4 text-neutral-300 animate-pulse"}),e.jsx("p",{className:"text-lg font-medium",children:"ĞĞ°Ñ‡Ğ½Ğ¸Ñ‚Ğµ Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğµ Ñ Ğ¿Ñ€ĞµĞ¿Ğ¾Ğ´Ğ°Ğ²Ğ°Ñ‚ĞµĞ»ĞµĞ¼"}),e.jsx("p",{className:"text-sm mt-2",children:"ĞÑ‚Ğ¿Ñ€Ğ°Ğ²ÑŒÑ‚Ğµ Ğ¿ĞµÑ€Ğ²Ğ¾Ğµ ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğµ"})]}):D.map((t,s)=>{const n=t.senderId===(j==null?void 0:j.id);return e.jsx("div",{className:`flex ${n?"justify-end":"justify-start"} animate-slide-in`,style:{animationDelay:`${s*.05}s`},children:e.jsxs("div",{className:`max-w-[75%] md:max-w-[65%] chat-message-bubble ${n?"chat-message-bubble-own":"chat-message-bubble-other"}`,children:[t.fileUrl&&e.jsxs("a",{href:t.fileUrl.startsWith("http")?t.fileUrl:`${ee.replace("/api","")}${t.fileUrl}`,download:t.fileName,target:"_blank",rel:"noopener noreferrer",className:`flex items-center gap-2 mb-2 p-2.5 rounded-xl transition-all duration-200 hover:scale-[1.02] ${n?"bg-white/20 hover:bg-white/30":"bg-primary-50 hover:bg-primary-100"}`,children:[Q(t.fileName||""),e.jsx("span",{className:"text-sm font-medium flex-1 truncate",children:t.fileName}),t.fileSize&&e.jsx("span",{className:`text-xs ${n?"text-white/80":"text-neutral-600"}`,children:E(t.fileSize)}),e.jsx(X,{className:`h-4 w-4 ${n?"text-white":"text-primary-600"}`})]}),t.content&&e.jsx("p",{className:"text-[0.9375rem] leading-relaxed whitespace-pre-wrap break-words",children:t.content}),e.jsx("p",{className:`text-xs mt-2 ${n?"text-white/80":"text-neutral-500"}`,children:new Date(t.createdAt).toLocaleTimeString("ru-RU",{hour:"2-digit",minute:"2-digit"})})]})},t.id)}),e.jsx("div",{ref:U})]}),e.jsxs("form",{onSubmit:$,className:"chat-input-container",children:[p&&!l&&e.jsx(FileUploadProgress,{fileName:p.fileName,progress:p.progress,onCancel:()=>{y(!1),d(null),o.current&&(o.current.value="")}}),l&&!p&&e.jsxs("div",{className:"mb-3 flex items-center gap-3 p-3 bg-gradient-to-r from-primary-50 to-primary-50 rounded-xl border-2 border-primary-200 animate-slide-in",children:[e.jsx(I,{className:"h-5 w-5 text-primary-600 flex-shrink-0"}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsx("p",{className:"text-sm font-semibold text-neutral-900 truncate",children:l.file.name}),e.jsx("p",{className:"text-xs text-neutral-600 mt-0.5",children:E(l.file.size)})]}),e.jsx("button",{type:"button",onClick:K,className:"p-1.5 text-neutral-500 hover:text-red-600 hover:bg-red-50 rounded-lg transition-all duration-200 active:scale-95",children:e.jsx(G,{className:"h-5 w-5"})})]}),e.jsxs("div",{className:"flex items-end gap-2 md:gap-3",children:[e.jsx("input",{ref:o,type:"file",onChange:H,className:"hidden",id:"file-input",disabled:b}),e.jsx("label",{htmlFor:"file-input",className:"chat-attach-btn",children:b?e.jsx(F,{className:"h-5 w-5 md:h-6 md:w-6 animate-spin"}):e.jsx(J,{className:"h-5 w-5 md:h-6 md:w-6"})}),e.jsx("textarea",{ref:x,value:f,onChange:R,placeholder:"",className:"chat-textarea flex-1",rows:1,onKeyDown:t=>{t.key==="Enter"&&!t.shiftKey&&(t.preventDefault(),$(t))},onInput:m}),e.jsx("button",{type:"submit",disabled:!f.trim()&&!l||h.isLoading||b,className:"chat-send-btn",children:h.isLoading?e.jsx(F,{className:"h-5 w-5 md:h-6 md:w-6 animate-spin"}):e.jsx(Y,{className:"h-5 w-5 md:h-6 md:w-6"})})]})]}),e.jsx(te,{isOpen:C.isOpen,onClose:()=>v({isOpen:!1,message:""}),message:C.message})]})}export{ce as default};
