import{d as re,u as le,r as a,e as A,f as D,j as t,a7 as ne,aq as w,M as y,q as z,U as V,as as ie,au as oe,b0 as B,X as de,b1 as ce,S as me}from"./vendor-DlLoZmjg.js";import{u as ue,A as xe,a as b}from"./index-DILgJ4JJ.js";import{u as he}from"./useDebounce-DGNjYN_-.js";import{E as fe}from"./ErrorModal-BVlsXXns.js";function we(){const{user:Q}=ue(),u=re(),I=le(),[r,x]=a.useState(null),[q,c]=a.useState(null),[d,h]=a.useState(null),[f,T]=a.useState(""),[$,W]=a.useState(""),[n,v]=a.useState(null),[R,P]=a.useState(!1),[O,C]=a.useState(!1),p=a.useRef(null),g=a.useRef(null),j=he($,300),E=a.useRef(null),[M,S]=a.useState({isOpen:!1,message:""}),{data:H,isLoading:K}=A(["teacherChats",j],async()=>{const e=j?`?search=${encodeURIComponent(j)}`:"";return(await b.get(`/messages/teacher/chats${e}`)).data.data||[]}),i=H||[],{data:F,isLoading:_}=A(["chat",r],async()=>r?(await b.get(`/messages/chat/${r}`)).data.data:null,{enabled:!!r,refetchInterval:1e4,refetchOnWindowFocus:!1}),X=D(async e=>{const s=new FormData;return s.append("file",e),(await b.post("/messages/upload-file",s,{headers:{"Content-Type":"multipart/form-data"}})).data.data}),N=D(async e=>{if(!r)throw new Error("Ð¡Ñ‚ÑƒÐ´ÐµÐ½Ñ‚ Ð½Ðµ Ð²Ñ‹Ð±Ñ€Ð°Ð½");return(await b.post("/messages/send",{receiverId:r,...e})).data.data},{onSuccess:()=>{I.invalidateQueries(["chat",r]),I.invalidateQueries(["teacherChats"]),T(""),v(null),p.current&&(p.current.value=""),g.current&&(g.current.style.height="auto")}}),J=()=>{E.current?.scrollIntoView({behavior:"smooth"})};a.useEffect(()=>{J()},[F?.messages]);const Y=async e=>{const s=e.target.files?.[0];if(s){if(s.size>50*1024*1024){S({isOpen:!0,message:"Ð Ð°Ð·Ð¼ÐµÑ€ Ñ„Ð°Ð¹Ð»Ð° Ð½Ðµ Ð´Ð¾Ð»Ð¶ÐµÐ½ Ð¿Ñ€ÐµÐ²Ñ‹ÑˆÐ°Ñ‚ÑŒ 50MB"});return}P(!0);try{const l=await X.mutateAsync(s);v({file:s,url:l.fileUrl})}catch(l){S({isOpen:!0,message:l.response?.data?.message||"ÐžÑˆÐ¸Ð±ÐºÐ° Ð¿Ñ€Ð¸ Ð·Ð°Ð³Ñ€ÑƒÐ·ÐºÐµ Ñ„Ð°Ð¹Ð»Ð°"})}finally{P(!1)}}},Z=()=>{v(null),p.current&&(p.current.value="")},m=a.useCallback(()=>{const e=g.current;if(e){e.style.height="auto";const s=Math.min(e.scrollHeight,120);e.style.height=`${s}px`}},[]),ee=e=>{T(e.target.value),setTimeout(()=>m(),0)};a.useEffect(()=>{g.current&&m()},[r,m]),a.useEffect(()=>{m()},[f,m]);const G=async e=>{if(e.preventDefault(),!f.trim()&&!n||N.isLoading||!r)return;const s={content:f.trim()||(n?"ðŸ“Ž Ð¤Ð°Ð¹Ð»":"")};n&&(s.fileUrl=n.url,s.fileName=n.file.name,s.fileSize=n.file.size),N.mutate(s)},k=e=>e<1024?e+" B":e<1024*1024?(e/1024).toFixed(1)+" KB":(e/(1024*1024)).toFixed(1)+" MB",te=e=>(e.split(".").pop()?.toLowerCase(),t.jsx(B,{className:"h-4 w-4"}));a.useEffect(()=>{if(i.length>0&&!r&&!d){const e=i[0];e.chatType==="GROUP"&&e.classId?(c("GROUP"),h(e.classId)):(c("PRIVATE"),x(e.id))}if((r||d)&&i.length>0&&!i.find(s=>s.chatType==="PRIVATE"&&s.id===r||s.chatType==="GROUP"&&s.classId===d)){const s=i[0];s.chatType==="GROUP"&&s.classId?(c("GROUP"),h(s.classId),x(null)):(c("PRIVATE"),x(s.id),h(null))}},[i,r,d]);const se=e=>{e.chatType==="GROUP"&&e.classId?(c("GROUP"),h(e.classId),x(null),u(`/classes/${e.classId}/chat`)):(c("PRIVATE"),x(e.id),h(null),window.innerWidth<768&&C(!0))},ae=()=>{C(!1)};a.useEffect(()=>{const e=()=>{window.innerWidth>=768&&C(!1)};return window.addEventListener("resize",e),()=>window.removeEventListener("resize",e)},[]);const o=i.find(e=>e.chatType==="PRIVATE"&&e.id===r||e.chatType==="GROUP"&&e.classId===d),L=F?.messages||[];return t.jsxs("div",{className:"flex flex-col md:flex-row h-[calc(100vh-8rem)] gap-4 animate-fade-scale",children:[t.jsxs("div",{className:`w-full md:w-80 card p-0 overflow-hidden flex flex-col ${O?"hidden md:flex":"flex"}`,children:[t.jsxs("div",{className:"p-4 border-b border-neutral-200",children:[t.jsx("h2",{className:"text-lg font-semibold text-neutral-900 mb-3",children:"Ð§Ð°Ñ‚Ñ‹"}),t.jsxs("div",{className:"relative",children:[t.jsx(ne,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 h-4 w-4 text-neutral-400 pointer-events-none z-10"}),t.jsx("input",{type:"text",value:$,onChange:e=>W(e.target.value),placeholder:"ÐŸÐ¾Ð¸ÑÐº ÑÑ‚ÑƒÐ´ÐµÐ½Ñ‚Ð¾Ð²...",className:"input-field pl-10 w-full"})]})]}),t.jsx("div",{className:"flex-1 overflow-y-auto",children:K?t.jsx("div",{className:"flex justify-center py-8",children:t.jsx(w,{className:"h-6 w-6 animate-spin text-primary-500"})}):i.length===0?t.jsxs("div",{className:"text-center py-8 text-neutral-500",children:[t.jsx(y,{className:"h-12 w-12 mx-auto mb-4 text-neutral-400"}),t.jsx("p",{children:j?"Ð§Ð°Ñ‚Ñ‹ Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½Ñ‹":"ÐÐµÑ‚ Ñ‡Ð°Ñ‚Ð¾Ð²"})]}):t.jsx("div",{className:"divide-y divide-neutral-100",children:i.map((e,s)=>{const l=e.chatType==="PRIVATE"&&r===e.id||e.chatType==="GROUP"&&d===e.classId;return t.jsx("div",{className:`w-full p-4 hover:bg-gradient-to-r hover:from-primary-50 hover:to-blue-50/50 transition-all duration-200 cursor-pointer group ${l?"bg-gradient-to-r from-primary-100 to-blue-100/50 border-l-4 border-primary-500 shadow-sm":""} animate-slide-in`,style:{animationDelay:`${s*.03}s`},children:t.jsxs("div",{className:"flex items-center gap-3",children:[t.jsxs("button",{onClick:()=>se(e),className:"flex items-center gap-3 flex-1 text-left",children:[e.chatType==="GROUP"?t.jsx("div",{className:"w-12 h-12 rounded-full bg-gradient-to-br from-green-500 to-emerald-600 text-white flex items-center justify-center font-bold text-lg shadow-md ring-2 ring-primary-200 group-hover:ring-primary-400 transition-all",children:t.jsx(z,{className:"h-6 w-6"})}):e.avatarUrl?t.jsx("img",{src:e.avatarUrl,alt:`${e.firstName} ${e.lastName}`,className:"w-12 h-12 rounded-full object-cover ring-2 ring-primary-200 shadow-sm group-hover:ring-primary-400 transition-all"}):t.jsx("div",{className:"w-12 h-12 rounded-full bg-gradient-to-br from-blue-500 to-purple-600 text-white flex items-center justify-center font-bold text-lg shadow-md ring-2 ring-primary-200 group-hover:ring-primary-400 transition-all",children:e.firstName[0]}),t.jsxs("div",{className:"flex-1 min-w-0",children:[t.jsxs("div",{className:"flex items-center justify-between mb-1",children:[t.jsx("h3",{className:"font-semibold text-neutral-900 truncate group-hover:text-primary-700 transition-colors",children:e.chatType==="GROUP"?e.className:`${e.firstName} ${e.lastName}`}),e.unreadCount&&e.unreadCount>0&&t.jsx("span",{className:"bg-gradient-to-br from-primary-500 to-blue-600 text-white text-xs font-bold rounded-full w-6 h-6 flex items-center justify-center flex-shrink-0 shadow-md animate-pulse",children:e.unreadCount})]}),e.chatType==="GROUP"&&e.studentCount!==void 0&&t.jsxs("p",{className:"text-xs text-primary-600 mb-1 font-medium",children:[e.studentCount," ",e.studentCount===1?"ÑÑ‚ÑƒÐ´ÐµÐ½Ñ‚":"ÑÑ‚ÑƒÐ´ÐµÐ½Ñ‚Ð¾Ð²"]}),e.lastMessage?t.jsxs(t.Fragment,{children:[t.jsxs("p",{className:"text-sm text-neutral-600 truncate group-hover:text-neutral-800 transition-colors",children:[e.chatType==="GROUP"&&e.lastMessage.senderName?t.jsxs("span",{className:"font-medium",children:[e.lastMessage.senderName,": "]}):null,e.lastMessage.content]}),t.jsx("p",{className:"text-xs text-neutral-500 mt-1 font-medium",children:new Date(e.lastMessage.createdAt).toLocaleDateString("ru-RU",{day:"numeric",month:"short",hour:"2-digit",minute:"2-digit"})})]}):t.jsx("p",{className:"text-sm text-neutral-500 group-hover:text-neutral-700 transition-colors",children:e.chatType==="GROUP"?"Ð“Ñ€ÑƒÐ¿Ð¿Ð¾Ð²Ð¾Ð¹ Ñ‡Ð°Ñ‚":`Ð¢ÐµÐ»ÐµÑ„Ð¾Ð½: ${e.phone}`})]})]}),e.chatType==="PRIVATE"&&t.jsx("button",{onClick:U=>{U.stopPropagation(),u(`/teacher/students/${e.id}`)},className:"p-2.5 text-neutral-600 hover:text-primary-600 hover:bg-primary-100 rounded-xl transition-all duration-200 flex-shrink-0 active:scale-95",title:"ÐžÑ‚ÐºÑ€Ñ‹Ñ‚ÑŒ Ð¿Ñ€Ð¾Ñ„Ð¸Ð»ÑŒ ÑÑ‚ÑƒÐ´ÐµÐ½Ñ‚Ð°",children:t.jsx(V,{className:"h-5 w-5"})}),e.chatType==="GROUP"&&e.classId&&t.jsx("button",{onClick:U=>{U.stopPropagation(),u(`/classes/${e.classId}`)},className:"p-2.5 text-neutral-600 hover:text-primary-600 hover:bg-primary-100 rounded-xl transition-all duration-200 flex-shrink-0 active:scale-95",title:"ÐžÑ‚ÐºÑ€Ñ‹Ñ‚ÑŒ ÐºÐ»Ð°ÑÑ",children:t.jsx(z,{className:"h-5 w-5"})})]})},e.chatType==="GROUP"?`group-${e.classId}`:e.id)})})})]}),t.jsx("div",{className:`flex-1 flex flex-col card p-0 overflow-hidden ${O?"flex":"hidden md:flex"}`,children:q==="GROUP"&&d?t.jsx("div",{className:"flex-1 flex items-center justify-center text-neutral-500",children:t.jsxs("div",{className:"text-center",children:[t.jsx(y,{className:"h-16 w-16 mx-auto mb-4 text-neutral-400"}),t.jsx("p",{className:"mb-4",children:"Ð“Ñ€ÑƒÐ¿Ð¿Ð¾Ð²Ð¾Ð¹ Ñ‡Ð°Ñ‚ ÐºÐ»Ð°ÑÑÐ°"}),t.jsx("button",{onClick:()=>u(`/classes/${d}/chat`),className:"btn-primary",children:"ÐžÑ‚ÐºÑ€Ñ‹Ñ‚ÑŒ Ð³Ñ€ÑƒÐ¿Ð¿Ð¾Ð²Ð¾Ð¹ Ñ‡Ð°Ñ‚"})]})}):r&&o?t.jsxs(t.Fragment,{children:[t.jsxs("div",{className:"p-4 border-b-2 border-primary-100 bg-gradient-to-r from-white to-blue-50/30 flex items-center justify-between shadow-sm",children:[t.jsxs("div",{className:"flex items-center gap-3 flex-1",children:[t.jsx("button",{onClick:ae,className:"md:hidden p-2.5 text-neutral-600 hover:text-primary-600 hover:bg-primary-50 rounded-xl transition-all duration-200 active:scale-95",title:"Ð’ÐµÑ€Ð½ÑƒÑ‚ÑŒÑÑ Ðº ÑÐ¿Ð¸ÑÐºÑƒ",children:t.jsx(ie,{className:"h-5 w-5"})}),o.avatarUrl?t.jsx("img",{src:o.avatarUrl,alt:`${o.firstName} ${o.lastName}`,className:"w-12 h-12 rounded-full object-cover ring-2 ring-primary-200 shadow-sm"}):t.jsx("div",{className:"w-12 h-12 rounded-full bg-gradient-to-br from-blue-500 to-purple-600 text-white flex items-center justify-center font-bold text-lg shadow-md ring-2 ring-primary-200",children:o.firstName[0]}),t.jsxs("div",{children:[t.jsxs("h2",{className:"font-semibold text-neutral-900 text-lg",children:[o.firstName," ",o.lastName]}),t.jsx("p",{className:"text-xs text-neutral-600 font-medium",children:"Ð¡Ñ‚ÑƒÐ´ÐµÐ½Ñ‚"})]})]}),t.jsx("button",{onClick:()=>u(`/teacher/students/${o.id}`),className:"p-2.5 text-neutral-600 hover:text-primary-600 hover:bg-primary-50 rounded-xl transition-all duration-200 active:scale-95",title:"ÐžÑ‚ÐºÑ€Ñ‹Ñ‚ÑŒ Ð¿Ñ€Ð¾Ñ„Ð¸Ð»ÑŒ ÑÑ‚ÑƒÐ´ÐµÐ½Ñ‚Ð°",children:t.jsx(V,{className:"h-5 w-5"})})]}),t.jsxs("div",{className:"flex-1 overflow-y-auto space-y-3 p-4 bg-gradient-to-b from-neutral-50/50 to-white",children:[_?t.jsx("div",{className:"flex justify-center py-8",children:t.jsx(w,{className:"h-6 w-6 animate-spin text-primary-500"})}):L.length===0?t.jsxs("div",{className:"text-center py-12 text-neutral-500",children:[t.jsx(y,{className:"h-16 w-16 mx-auto mb-4 text-neutral-300 animate-pulse"}),t.jsx("p",{className:"text-lg font-medium",children:"ÐÐ°Ñ‡Ð½Ð¸Ñ‚Ðµ Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ðµ ÑÐ¾ ÑÑ‚ÑƒÐ´ÐµÐ½Ñ‚Ð¾Ð¼"}),t.jsx("p",{className:"text-sm mt-2",children:"ÐžÑ‚Ð¿Ñ€Ð°Ð²ÑŒÑ‚Ðµ Ð¿ÐµÑ€Ð²Ð¾Ðµ ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ðµ"})]}):L.map((e,s)=>{const l=e.senderId===Q?.id;return t.jsx("div",{className:`flex ${l?"justify-end":"justify-start"} animate-slide-in`,style:{animationDelay:`${s*.05}s`},children:t.jsxs("div",{className:`max-w-[75%] md:max-w-[65%] chat-message-bubble ${l?"chat-message-bubble-own":"chat-message-bubble-other"}`,children:[e.fileUrl&&t.jsxs("a",{href:e.fileUrl.startsWith("http")?e.fileUrl:`${xe.replace("/api","")}${e.fileUrl}`,download:e.fileName,target:"_blank",rel:"noopener noreferrer",className:`flex items-center gap-2 mb-2 p-2.5 rounded-xl transition-all duration-200 hover:scale-[1.02] ${l?"bg-white/20 hover:bg-white/30":"bg-primary-50 hover:bg-primary-100"}`,children:[te(e.fileName||""),t.jsx("span",{className:"text-sm font-medium flex-1 truncate",children:e.fileName}),e.fileSize&&t.jsx("span",{className:`text-xs ${l?"text-white/80":"text-neutral-600"}`,children:k(e.fileSize)}),t.jsx(oe,{className:`h-4 w-4 ${l?"text-white":"text-primary-600"}`})]}),e.content&&t.jsx("p",{className:"text-[0.9375rem] leading-relaxed whitespace-pre-wrap break-words",children:e.content}),t.jsx("p",{className:`text-xs mt-2 ${l?"text-white/80":"text-neutral-500"}`,children:new Date(e.createdAt).toLocaleTimeString("ru-RU",{hour:"2-digit",minute:"2-digit"})})]})},e.id)}),t.jsx("div",{ref:E})]}),t.jsxs("form",{onSubmit:G,className:"chat-input-container",children:[n&&t.jsxs("div",{className:"mb-3 flex items-center gap-3 p-3 bg-gradient-to-r from-primary-50 to-blue-50 rounded-xl border-2 border-primary-200 animate-slide-in",children:[t.jsx(B,{className:"h-5 w-5 text-primary-600 flex-shrink-0"}),t.jsxs("div",{className:"flex-1 min-w-0",children:[t.jsx("p",{className:"text-sm font-semibold text-neutral-900 truncate",children:n.file.name}),t.jsx("p",{className:"text-xs text-neutral-600 mt-0.5",children:k(n.file.size)})]}),t.jsx("button",{type:"button",onClick:Z,className:"p-1.5 text-neutral-500 hover:text-red-600 hover:bg-red-50 rounded-lg transition-all duration-200 active:scale-95",children:t.jsx(de,{className:"h-5 w-5"})})]}),t.jsxs("div",{className:"flex items-end gap-2 md:gap-3",children:[t.jsx("input",{ref:p,type:"file",onChange:Y,className:"hidden",id:"file-input-teacher",disabled:R}),t.jsx("label",{htmlFor:"file-input-teacher",className:"chat-attach-btn",children:R?t.jsx(w,{className:"h-5 w-5 md:h-6 md:w-6 animate-spin"}):t.jsx(ce,{className:"h-5 w-5 md:h-6 md:w-6"})}),t.jsx("textarea",{ref:g,value:f,onChange:ee,placeholder:"",className:"chat-textarea flex-1",rows:1,onKeyDown:e=>{e.key==="Enter"&&!e.shiftKey&&(e.preventDefault(),G(e))},onInput:m}),t.jsx("button",{type:"submit",disabled:!f.trim()&&!n||N.isLoading||R,className:"chat-send-btn",children:N.isLoading?t.jsx(w,{className:"h-5 w-5 md:h-6 md:w-6 animate-spin"}):t.jsx(me,{className:"h-5 w-5 md:h-6 md:w-6"})})]})]})]}):t.jsx("div",{className:"flex-1 flex items-center justify-center text-neutral-500",children:t.jsxs("div",{className:"text-center",children:[t.jsx(y,{className:"h-16 w-16 mx-auto mb-4 text-neutral-400"}),t.jsx("p",{children:"Ð’Ñ‹Ð±ÐµÑ€Ð¸Ñ‚Ðµ ÑÑ‚ÑƒÐ´ÐµÐ½Ñ‚Ð° Ð´Ð»Ñ Ð½Ð°Ñ‡Ð°Ð»Ð° Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ñ"})]})})}),t.jsx(fe,{isOpen:M.isOpen,onClose:()=>S({isOpen:!1,message:""}),message:M.message})]})}export{we as default};
