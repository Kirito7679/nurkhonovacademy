import{ab as $,u as P,d as Q,r as l,e as U,f as X,j as e,am as y,Z as F,al as G,a1 as V}from"./vendor-react-B4b84SyH.js";import{a as w}from"./index-D6PcLXw1.js";import{E as Z}from"./ErrorModal-BsuAe5nl.js";function H(){var v;const{courseId:d,testId:c}=$(),m=P(),u=Q(),[h,j]=l.useState({}),[f,S]=l.useState({}),[N,C]=l.useState(0),[L,E]=l.useState(!1),[i,k]=l.useState(null),[b,g]=l.useState({isOpen:!1,message:""}),{data:a,isLoading:M}=U(["test",c],async()=>(await w.get(`/tests/${c}`)).data.data),x=X(async s=>(await w.post(`/tests/${c}/submit`,s)).data.data,{onSuccess:s=>{k(s),E(!0),u.invalidateQueries(["test",c]),u.invalidateQueries("user")},onError:s=>{var t,r;g({isOpen:!0,message:((r=(t=s.response)==null?void 0:t.data)==null?void 0:r.message)||"Ошибка при отправке теста"})}});l.useEffect(()=>{if(!(a!=null&&a.timeLimit))return;const s=setInterval(()=>{C(t=>t+1)},1e3);return()=>clearInterval(s)},[a==null?void 0:a.timeLimit]);const T=(s,t,r)=>{j(r?n=>{const p=n[s]||[];return p.includes(t)?{...n,[s]:p.filter(O=>O!==t)}:{...n,[s]:[...p,t]}}:{...prev,[s]:[t]})},A=(s,t)=>{S(r=>({...r,[s]:t}))},I=()=>{var t;if(!a)return;const s=((t=a.questions)==null?void 0:t.map(r=>({questionId:r.id,optionIds:h[r.id]||[],textAnswer:f[r.id]||void 0})))||[];x.mutate({testId:c,answers:s,timeSpent:N})};if(M)return e.jsxs("div",{className:"text-center py-12",children:[e.jsx("div",{className:"inline-block relative",children:e.jsx("div",{className:"animate-spin rounded-full h-12 w-12 border-4 border-primary-200 border-t-primary-500"})}),e.jsx("p",{className:"mt-4 text-neutral-600",children:"Загрузка теста..."})]});if(!a)return e.jsx("div",{className:"text-center py-12",children:e.jsx("p",{className:"text-neutral-600",children:"Тест не найден"})});if(L&&i)return e.jsxs("div",{children:[e.jsxs("button",{onClick:()=>m(`/courses/${d}`),className:"flex items-center text-neutral-600 hover:text-primary-600 mb-6 transition-colors",children:[e.jsx(y,{className:"h-5 w-5 mr-2"}),"Назад к курсу"]}),e.jsxs("div",{className:"card p-8 text-center",children:[i.passed?e.jsx(F,{className:"h-16 w-16 text-green-500 mx-auto mb-4"}):e.jsx(G,{className:"h-16 w-16 text-red-500 mx-auto mb-4"}),e.jsx("h1",{className:"text-2xl font-bold text-neutral-900 mb-2",children:i.passed?"Тест пройден!":"Тест не пройден"}),e.jsxs("div",{className:"mt-6 space-y-2",children:[e.jsxs("p",{className:"text-lg",children:[e.jsx("span",{className:"font-semibold",children:"Результат:"})," ",i.percentage.toFixed(1),"%"]}),e.jsxs("p",{className:"text-lg",children:[e.jsx("span",{className:"font-semibold",children:"Баллов:"})," ",i.score]}),i.timeSpent&&e.jsxs("p",{className:"text-lg",children:[e.jsx("span",{className:"font-semibold",children:"Время:"})," ",Math.floor(i.timeSpent/60),":",(i.timeSpent%60).toString().padStart(2,"0")]})]}),e.jsx("button",{onClick:()=>m(`/courses/${d}`),className:"btn-primary mt-6",children:"Вернуться к курсу"})]})]});const o=a.timeLimit?a.timeLimit*60-N:null;return e.jsxs("div",{children:[e.jsxs("button",{onClick:()=>m(`/courses/${d}`),className:"flex items-center text-neutral-600 hover:text-primary-600 mb-6 transition-colors",children:[e.jsx(y,{className:"h-5 w-5 mr-2"}),"Назад к курсу"]}),e.jsx("div",{className:"card p-6 mb-6",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("h1",{className:"text-2xl font-bold text-neutral-900",children:a.title}),a.description&&e.jsx("p",{className:"text-neutral-600 mt-2",children:a.description})]}),o!==null&&e.jsxs("div",{className:"flex items-center gap-2 text-lg font-semibold",children:[e.jsx(V,{className:"h-5 w-5"}),e.jsxs("span",{children:[Math.floor(o/60),":",(o%60).toString().padStart(2,"0")]})]})]})}),e.jsx("div",{className:"space-y-6",children:(v=a.questions)==null?void 0:v.map((s,t)=>{var r;return e.jsxs("div",{className:"card p-6",children:[e.jsxs("div",{className:"flex items-start gap-3 mb-4",children:[e.jsx("span",{className:"flex-shrink-0 w-8 h-8 rounded-full bg-primary-100 text-primary-700 flex items-center justify-center font-semibold",children:t+1}),e.jsxs("div",{className:"flex-1",children:[e.jsx("p",{className:"font-medium text-neutral-900 mb-2",children:s.question}),e.jsxs("p",{className:"text-sm text-neutral-600",children:[s.type==="SINGLE"?"Выберите один ответ":s.type==="MULTIPLE"?"Выберите несколько ответов":"Введите текстовый ответ"," • Баллов: ",s.points]})]})]}),s.type==="TEXT"?e.jsx("textarea",{value:f[s.id]||"",onChange:n=>A(s.id,n.target.value),className:"input-field",rows:4,placeholder:"Введите ваш ответ..."}):e.jsx("div",{className:"space-y-2",children:(r=s.options)==null?void 0:r.map(n=>e.jsxs("label",{className:"flex items-center gap-3 p-3 border border-neutral-200 rounded-lg hover:bg-neutral-50 cursor-pointer",children:[e.jsx("input",{type:s.type==="MULTIPLE"?"checkbox":"radio",name:s.id,checked:(h[s.id]||[]).includes(n.id),onChange:()=>T(s.id,n.id,s.type==="MULTIPLE"),className:"w-4 h-4 text-primary-600"}),e.jsx("span",{className:"flex-1",children:n.text})]},n.id))})]},s.id)})}),e.jsx("div",{className:"mt-6 flex justify-end",children:e.jsx("button",{onClick:I,disabled:x.isLoading,className:"btn-primary disabled:opacity-50",children:x.isLoading?"Отправка...":"Отправить тест"})}),e.jsx(Z,{isOpen:b.isOpen,message:b.message,onClose:()=>g({isOpen:!1,message:""})})]})}export{H as default};
